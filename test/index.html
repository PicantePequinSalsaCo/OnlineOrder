<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Picante Pequin Salsa Co. â€“ Order Now</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    :root {
      --bg: #050608;
      --card: #111827;
      --accent: #f59e0b;
      --accent-soft: #fbbf24;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border-subtle: #1f2937;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-subtle);
      backdrop-filter: blur(12px);
      background: linear-gradient(to right, rgba(15,23,42,0.9), rgba(15,23,42,0.6));
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #f97316, #b91c1c 60%, #111827 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #fef3c7;
      box-shadow: 0 0 0 1px rgba(248,250,252,0.1), 0 10px 30px rgba(0,0,0,0.7);
    }

    .brand-text h1 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .brand-text span {
      display: block;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-pill {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 0.8rem;
    }

    .user-pill span.label {
      color: var(--muted);
    }

    .user-pill span.value {
      font-weight: 600;
    }

    .user-pill span.rewards {
      color: var(--accent-soft);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .icon-btn {
      border: none;
      background: rgba(15,23,42,0.9);
      color: var(--text);
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
      font-size: 0.85rem;
      border: 1px solid rgba(148,163,184,0.5);
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
    }

    .icon-btn:hover {
      background: rgba(30,64,175,0.9);
      box-shadow: 0 10px 25px rgba(15,23,42,0.7);
      transform: translateY(-1px);
    }

    .icon-btn.logout {
      border-color: rgba(248,113,113,0.7);
      color: #fecaca;
    }

    .icon-btn .icon {
      font-size: 1rem;
    }

    .cart-button {
      position: relative;
    }

    .cart-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ef4444;
      color: #fef2f2;
      border-radius: 999px;
      font-size: 0.7rem;
      padding: 0 0.35rem;
      min-width: 1.1rem;
      text-align: center;
    }

    main {
      flex: 1;
      padding: 1.5rem;
      max-width: 1100px;
      width: 100%;
      margin: 0 auto 2rem auto;
    }

    .hero {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .hero-text {
      flex: 1 1 260px;
    }

    .hero-text h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.6rem;
    }

    .hero-text p {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(22,163,74,0.1);
      color: #bbf7d0;
      border: 1px solid rgba(34,197,94,0.4);
      font-size: 0.75rem;
      margin-bottom: 0.4rem;
    }

    .hero-badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.25);
    }

    .hero-side {
      flex: 0 0 260px;
      border-radius: 1rem;
      padding: 1rem;
      background: radial-gradient(circle at top left, rgba(248,250,252,0.06), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(248,250,252,0.03), transparent 55%),
                  #020617;
      border: 1px solid rgba(148,163,184,0.4);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .hero-side h3 {
      margin: 0;
      font-size: 0.95rem;
    }

    .hero-side-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      color: var(--muted);
    }

    .hero-side-row strong {
      color: var(--accent-soft);
    }

    .hero-side-note {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 1.25rem;
    }

    .prod-card {
      perspective: 1200px;
    }

    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.5s ease;
    }

    .prod-card.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .card-front,
    .card-back {
      position: relative;
      backface-visibility: hidden;
      border-radius: 1rem;
      background: radial-gradient(circle at top, #111827 0, #020617 60%, #000 100%);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-height: 280px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
    }

    .card-back {
      position: absolute;
      inset: 0;
      transform: rotateY(180deg);
    }

    .card-front img {
      width: 100%;
      border-radius: 0.75rem;
      object-fit: cover;
      max-height: 160px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.7);
    }

    .prod-name {
      margin: 0.4rem 0 0.1rem 0;
      font-size: 1rem;
    }

    .prod-price {
      margin: 0;
      color: var(--accent-soft);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .quantity {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.25rem;
    }

    .qty-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .qty-btn:hover {
      background: rgba(30,64,175,0.9);
      transform: translateY(-1px);
    }

    .qty-input {
      width: 48px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      padding: 0.2rem 0.4rem;
      text-align: center;
      font-size: 0.85rem;
    }

    .info-btn {
      margin-left: auto;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .info-btn:hover {
      background: rgba(30,64,175,0.9);
      color: #e5e7eb;
    }

    .add-to-cart {
      margin-top: 0.4rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(to right, #f97316, #facc15);
      color: #111827;
      font-weight: 600;
      padding: 0.45rem 0.9rem;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      box-shadow: 0 12px 30px rgba(248,113,22,0.5);
      transition: transform 0.1s ease, box-shadow 0.15s ease;
    }

    .add-to-cart:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(248,113,22,0.7);
    }

    .card-back h4 {
      margin: 0 0 0.4rem 0;
      font-size: 0.95rem;
    }

    .card-back ul {
      margin: 0;
      padding-left: 1.1rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .card-back li + li {
      margin-top: 0.2rem;
    }

    .close-info {
      margin-top: auto;
      align-self: flex-start;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .close-info:hover {
      background: rgba(30,64,175,0.9);
    }

    /* Cart overlay */
    #cart-container {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      backdrop-filter: blur(16px);
      display: none;
      align-items: center;
      justify-content: flex-end;
      z-index: 40;
    }

    #cart-container.open {
      display: flex;
    }

    .cart-panel {
      width: 360px;
      max-width: 100%;
      height: 100%;
      background: radial-gradient(circle at top, #020617 0, #020617 60%, #000 100%);
      border-left: 1px solid rgba(148,163,184,0.4);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      box-shadow: -20px 0 40px rgba(0,0,0,0.8);
    }

    .cart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .cart-header h3 {
      margin: 0;
      font-size: 1rem;
    }

    .cart-header small {
      color: var(--muted);
      font-size: 0.8rem;
    }

    .cart-close-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .cart-close-btn:hover {
      background: rgba(30,64,175,0.9);
      color: #e5e7eb;
    }

    #cart-items {
      list-style: none;
      margin: 0;
      padding: 0;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    #cart-items li {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      border-radius: 0.75rem;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
      transition: transform 0.15s ease, opacity 0.15s ease;
    }

    #cart-items li.removing {
      opacity: 0;
      transform: translateX(10px);
    }

    .cart-thumb {
      width: 40px;
      height: 40px;
      border-radius: 0.5rem;
      object-fit: cover;
    }

    .cart-name {
      flex: 1;
      font-size: 0.85rem;
    }

    .cart-quantity {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .cart-qty-input {
      width: 40px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      padding: 0.15rem 0.3rem;
      text-align: center;
      font-size: 0.8rem;
    }

    .cart-footer {
      border-top: 1px solid rgba(31,41,55,0.9);
      padding-top: 0.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.85rem;
    }

    .cart-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .cart-row span.label {
      color: var(--muted);
    }

    .cart-row span.value {
      font-weight: 600;
    }

    #rewards-row {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--muted);
    }

    #rewards-box {
      display: none;
      margin-top: 0.35rem;
      padding: 0.4rem;
      border-radius: 0.75rem;
      background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(234,179,8,0.6);
      display: none;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.8rem;
    }

    #rewards-box label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
    }

    #rewards-input {
      width: 80px;
      border-radius: 999px;
      border: 1px solid rgba(234,179,8,0.7);
      background: rgba(15,23,42,0.9);
      color: var(--accent-soft);
      padding: 0.2rem 0.4rem;
      text-align: center;
      font-size: 0.8rem;
    }

    #rewards-applied {
      color: var(--accent-soft);
      font-weight: 600;
    }

    #checkout-btn {
      margin-top: 0.4rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(to right, #f97316, #facc15);
      color: #111827;
      font-weight: 600;
      padding: 0.5rem 0.9rem;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      box-shadow: 0 12px 30px rgba(248,113,22,0.5);
      transition: transform 0.1s ease, box-shadow 0.15s ease, opacity 0.15s ease;
    }

    #checkout-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    #checkout-btn.loading::after {
      content: attr(data-loading-text);
      margin-left: 0.4rem;
      font-size: 0.8rem;
      color: #1f2937;
    }

    /* Auth overlay */
    #login-container {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      backdrop-filter: blur(16px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    #login-container.open {
      display: flex;
    }

    .auth-panel {
      width: 380px;
      max-width: 100%;
      background: radial-gradient(circle at top, #020617 0, #020617 60%, #000 100%);
      border-radius: 1rem;
      border: 1px solid rgba(148,163,184,0.5);
      padding: 1rem 1.1rem 1.1rem;
      box-shadow: 0 20px 50px rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      position: relative;
    }

    .auth-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .auth-header h3 {
      margin: 0;
      font-size: 1rem;
    }

    .auth-close-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .auth-close-btn:hover {
      background: rgba(30,64,175,0.9);
      color: #e5e7eb;
    }

    .auth-tabs {
      display: flex;
      gap: 0.4rem;
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }

    .auth-tabs button {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      padding: 0.25rem 0.4rem;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .auth-tabs button:hover {
      background: rgba(30,64,175,0.9);
      color: #e5e7eb;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.4rem;
    }

    .form-row {
      display: flex;
      gap: 0.4rem;
    }

    .form-row > div {
      flex: 1;
    }

    label {
      display: block;
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 0.15rem;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="tel"],
    input[type="number"],
    select {
      width: 100%;
      border-radius: 0.6rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      padding: 0.35rem 0.45rem;
      font-size: 0.85rem;
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
                        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 12px) calc(50% - 3px),
                           calc(100% - 8px) calc(50% - 3px);
      background-size: 4px 4px, 4px 4px;
      background-repeat: no-repeat;
      padding-right: 1.5rem;
    }

    .state-dropdown-wrapper {
      position: relative;
    }

    .state-dropdown-btn {
      position: absolute;
      inset: 0;
      border-radius: 0.6rem;
      border: none;
      background: transparent;
      cursor: pointer;
    }

    .reveal-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }

    .reveal-wrap input {
      padding-right: 2rem;
    }

    .reveal-btn {
      position: absolute;
      right: 0.25rem;
      top: 50%;
      transform: translateY(-50%);
      border-radius: 999px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1rem;
    }

    .helper-text {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .link-btn {
      border: none;
      background: none;
      color: var(--accent-soft);
      font-size: 0.75rem;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
    }

    .hidden {
      display: none !important;
    }

    .primary-btn {
      border-radius: 999px;
      border: none;
      background: linear-gradient(to right, #f97316, #facc15);
      color: #111827;
      font-weight: 600;
      padding: 0.45rem 0.9rem;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      box-shadow: 0 12px 30px rgba(248,113,22,0.5);
      transition: transform 0.1s ease, box-shadow 0.15s ease, opacity 0.15s ease;
    }

    .primary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .primary-btn.loading::after {
      content: 'Processing...';
      margin-left: 0.4rem;
      font-size: 0.8rem;
      color: #1f2937;
    }

    .secondary-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      padding: 0.35rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .secondary-btn:hover {
      background: rgba(30,64,175,0.9);
    }

    .password-strength {
      margin-top: 0.15rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.7rem;
    }

    .password-strength-bar {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: #4b5563;
      overflow: hidden;
    }

    .password-strength-bar-inner {
      width: 0%;
      height: 100%;
      background: red;
      transition: width 0.15s ease, background 0.15s ease;
    }

    .password-strength-text {
      min-width: 80px;
      text-align: right;
      color: var(--muted);
    }

    .match-msg {
      display: none;
      font-size: 0.7rem;
      color: var(--accent-red);
    }

    .message-box {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.6rem 0.9rem;
      border-radius: 999px;
      font-size: 0.8rem;
      z-index: 60;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.6);
      color: var(--text);
      box-shadow: 0 15px 35px rgba(0,0,0,0.8);
    }

    .message-box.success {
      border-color: rgba(34,197,94,0.7);
      color: #bbf7d0;
    }

    .message-box.error {
      border-color: rgba(248,113,113,0.7);
      color: #fecaca;
    }

    .message-box.info {
      border-color: rgba(59,130,246,0.7);
      color: #bfdbfe;
    }

    .email-error {
      display: none;
      font-size: 0.7rem;
      color: var(--accent-red);
      margin-top: 0.15rem;
    }

    .shimmer {
      position: relative;
      overflow: hidden;
    }

    .shimmer::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.4) 40%, transparent 80%);
      transform: translateX(-100%);
      animation: shimmer 0.8s ease forwards;
    }

    @keyframes shimmer {
      to {
        transform: translateX(100%);
      }
    }

    /* Payment section */
    #payment-section {
      display: none;
      margin-top: 0.75rem;
      padding: 0.6rem;
      border-radius: 0.75rem;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 0.85rem;
    }

    #card-element {
      padding: 0.4rem 0.5rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      margin-top: 0.35rem;
    }

    #card-errors {
      margin-top: 0.3rem;
      font-size: 0.75rem;
      color: var(--accent-red);
    }

    /* Sign-out confirm modal */
    #signout-confirm {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      backdrop-filter: blur(16px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 55;
    }

    .signout-dialog {
      background: radial-gradient(circle at top, #020617 0, #020617 60%, #000 100%);
      border-radius: 0.9rem;
      border: 1px solid rgba(148,163,184,0.5);
      padding: 0.9rem 1rem;
      max-width: 320px;
      width: 100%;
      box-shadow: 0 20px 50px rgba(0,0,0,0.85);
      font-size: 0.9rem;
    }

    .signout-dialog h4 {
      margin: 0 0 0.4rem 0;
      font-size: 1rem;
    }

    .signout-dialog p {
      margin: 0 0 0.7rem 0;
      color: var(--muted);
      font-size: 0.8rem;
    }

    .signout-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.4rem;
    }

    footer {
      padding: 0.75rem 1.5rem 1rem;
      font-size: 0.75rem;
      color: var(--muted);
      border-top: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
    }

    @media (max-width: 640px) {
      header {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .header-right {
        width: 100%;
        justify-content: flex-end;
      }
      main {
        padding: 1rem;
      }
      .cart-panel {
        width: 100%;
      }
      .auth-panel {
        width: 100%;
        margin: 0 0.75rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="brand-logo">PP</div>
      <div class="brand-text">
        <h1>Picante Pequin Salsa Co.</h1>
        <span>Small-batch heat, shipped fresh</span>
      </div>
    </div>
    <div class="header-right">
      <div class="user-pill">
        <span class="label">Signed in as</span>
        <span class="value" id="username-display">Guest</span>
        <span class="rewards">
          <span>â˜…</span>
          <span id="rewards-display">0</span>
        </span>
      </div>
      <button id="login-btn" class="icon-btn">
        <span class="icon">ðŸ‘¤</span>
        <span>Sign In</span>
      </button>
      <button id="cart-icon" class="icon-btn cart-button">
        <span class="icon">ðŸ›’</span>
        <span>Cart</span>
        <span class="cart-count" id="cart-count">0</span>
      </button>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="hero-text">
        <div class="hero-badge">
          <span class="dot"></span>
          <span>Fresh batches weekly Â· Rewards on every jar</span>
        </div>
        <h2>Choose your pequin heat, then check out in two clean steps.</h2>
        <p>Sign in once, earn points every time, and redeem them right in your cartâ€”no codes, no guessing.</p>
      </div>
      <aside class="hero-side">
        <h3>How checkout works</h3>
        <div class="hero-side-row">
          <span>1. Add jars to your cart</span>
          <strong>Build your box</strong>
        </div>
        <div class="hero-side-row">
          <span>2. Sign in or create an account</span>
          <strong>Earn & redeem points</strong>
        </div>
        <div class="hero-side-row">
          <span>3. Confirm shipping & pay</span>
          <strong>Stripe-secured</strong>
        </div>
        <p class="hero-side-note">
          Youâ€™ll see your order number, shipping, tax, and total before you ever enter a card.
        </p>
      </aside>
    </section>

    <section>
      <div id="product-gallery" class="gallery-grid"></div>
    </section>
  </main>

  <!-- Cart overlay -->
  <div id="cart-container">
    <div class="cart-panel">
      <div class="cart-header">
        <div>
          <h3>Your Cart</h3>
          <small>Review jars, apply rewards, then check out.</small>
        </div>
        <button id="close-cart" class="cart-close-btn" aria-label="Close cart">âœ•</button>
      </div>

      <ul id="cart-items"></ul>

      <div class="cart-footer">
        <div id="rewards-row">
          <span class="label">Rewards available</span>
          <span class="value"><span id="rewards-display-footer">0</span> pts</span>
        </div>

        <div id="rewards-box">
          <label>
            <span>Redeem points (1000 pts = $1)</span>
            <input id="rewards-input" type="number" min="0" step="1" value="0" />
          </label>
          <div class="cart-row">
            <span class="label">Applied discount</span>
            <span class="value">-$<span id="rewards-applied">0.00</span></span>
          </div>
        </div>

        <div class="cart-row" id="subtotal-row" style="display:none;">
          <span class="label">Subtotal</span>
          <span class="value">$<span id="subtotal-value">0.00</span></span>
        </div>

        <div class="cart-row" id="shipping-row" style="display:none;">
          <span class="label">Shipping</span>
          <span class="value">$<span id="shipping-cost">0.00</span></span>
        </div>

        <div class="cart-row" id="tax-row" style="display:none;">
          <span class="label">Tax</span>
          <span class="value">$<span id="tax-amount">0.00</span></span>
        </div>

        <div class="cart-row" id="order-info-row" style="display:none;">
          <span class="label">Order #</span>
          <span class="value" id="order-number">â€”</span>
        </div>

        <div class="cart-row">
          <span class="label">Total</span>
          <span class="value">$<span id="cart-total-value">0.00</span></span>
        </div>

        <div id="payment-section">
          <div>Card details</div>
          <div id="card-element"></div>
          <div id="card-errors" role="alert"></div>
        </div>

        <button id="checkout-btn" disabled>Sign In to Checkout</button>
      </div>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="login-container">
    <div class="auth-panel">
      <div class="auth-header">
        <h3 id="auth-title">Sign In</h3>
        <button id="close-login" class="auth-close-btn" aria-label="Close auth">âœ•</button>
      </div>

      <div class="auth-tabs">
        <button id="show-login" type="button">Sign In</button>
        <button id="show-signup" type="button">Create Account</button>
        <button id="show-reset" type="button">Reset Password</button>
      </div>

      <!-- Sign In form -->
      <form id="login-form">
        <div>
          <label for="login-username">Email</label>
          <input id="login-username" type="email" autocomplete="email" />
        </div>
        <div>
          <label for="login-password">Password</label>
          <div class="reveal-wrap">
            <input id="login-password" type="password" autocomplete="current-password" />
            <button type="button" class="reveal-btn" data-target="login-password">ðŸª…</button>
          </div>
        </div>
        <button type="submit" class="primary-btn">
          <span>Sign In</span>
        </button>
      </form>

      <!-- Signup form -->
      <form id="signup-form" class="hidden">
        <div class="form-row">
          <div>
            <label for="signup-firstname">First name</label>
            <input id="signup-firstname" type="text" autocomplete="given-name" />
          </div>
          <div>
            <label for="signup-lastname">Last name</label>
            <input id="signup-lastname" type="text" autocomplete="family-name" />
          </div>
        </div>

        <div>
          <label for="signup-address">Street address</label>
          <input id="signup-address" type="text" autocomplete="address-line1" />
        </div>

        <div class="form-row">
          <div>
            <label for="signup-city">City</label>
            <input id="signup-city" type="text" autocomplete="address-level2" />
          </div>
          <div class="state-dropdown-wrapper">
            <label for="signup-state">State</label>
            <select id="signup-state" autocomplete="address-level1">
              <option value="">Select</option>
              <option value="TX">TX</option>
              <option value="CA">CA</option>
              <option value="NY">NY</option>
              <!-- add others as needed -->
            </select>
            <button class="state-dropdown-btn" aria-label="Open state list"></button>
          </div>
          <div>
            <label for="signup-zip">ZIP</label>
            <input id="signup-zip" type="text" inputmode="numeric" maxlength="5" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label for="signup-phone">Phone (10 digits)</label>
            <input id="signup-phone" type="tel" inputmode="numeric" maxlength="10" />
          </div>
          <div>
            <label for="signup-email">Email</label>
            <input id="signup-email" type="email" autocomplete="email" />
            <div id="email-error-msg" class="email-error">Please enter a valid email domain.</div>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label for="signup-password">Password</label>
            <div class="reveal-wrap">
              <input id="signup-password" type="password" autocomplete="new-password" />
              <button type="button" class="reveal-btn" data-target="signup-password">ðŸª…</button>
            </div>
            <div class="password-strength">
              <div class="password-strength-bar">
                <div id="password-strength-bar" class="password-strength-bar-inner"></div>
              </div>
              <div id="password-strength-text" class="password-strength-text">Strength: â€”</div>
            </div>
          </div>
          <div>
            <label for="signup-password-confirm">Confirm password</label>
            <div class="reveal-wrap">
              <input id="signup-password-confirm" type="password" autocomplete="new-password" />
              <button type="button" class="reveal-btn" data-target="signup-password-confirm">ðŸª…</button>
            </div>
            <div id="password-match-msg" class="match-msg">Passwords do not match.</div>
          </div>
        </div>

        <div>
          <label>Verification</label>
          <div class="form-row">
            <div>
              <button type="button" id="signup-request-code" class="secondary-btn">Request code</button>
            </div>
            <div>
              <input id="signup-verification-code" type="text" placeholder="Code" disabled />
            </div>
          </div>
          <div class="helper-text">
            Weâ€™ll send a short code to confirm your email/phone before creating your account.
          </div>
        </div>

        <div>
          <label>
            <input id="signup-smsConsent" type="checkbox" />
            <span>Yes, Iâ€™d like occasional SMS updates about orders and specials.</span>
          </label>
        </div>

        <button type="submit" class="primary-btn" disabled>
          <span>Create Account</span>
        </button>
      </form>

      <!-- Reset form -->
      <form id="reset-form" class="hidden">
        <div>
          <label for="reset-email">Email</label>
          <input id="reset-email" type="email" autocomplete="email" />
        </div>
        <div>
          <label for="reset-phone">Phone (10 digits)</label>
          <input id="reset-phone" type="tel" inputmode="numeric" maxlength="10" />
        </div>

        <div class="form-row">
          <div>
            <label for="reset-password">New password</label>
            <div class="reveal-wrap">
              <input id="reset-password" type="password" autocomplete="new-password" />
              <button type="button" class="reveal-btn" data-target="reset-password">ðŸª…</button>
            </div>
            <div class="password-strength">
              <div class="password-strength-bar">
                <div id="reset-password-strength-bar" class="password-strength-bar-inner"></div>
              </div>
              <div id="reset-password-strength-text" class="password-strength-text">Strength: â€”</div>
            </div>
          </div>
          <div>
            <label for="reset-password-confirm">Confirm new password</label>
            <div class="reveal-wrap">
              <input id="reset-password-confirm" type="password" autocomplete="new-password" />
              <button type="button" class="reveal-btn" data-target="reset-password-confirm">ðŸª…</button>
            </div>
            <div id="reset-password-match-msg" class="match-msg">Passwords do not match.</div>
          </div>
        </div>

        <div>
          <label>Verification</label>
          <div class="form-row">
            <div>
              <button type="button" id="reset-request-code" class="secondary-btn">Request code</button>
            </div>
            <div>
              <input id="reset-verification-code" type="text" placeholder="Code" disabled />
            </div>
          </div>
          <div class="helper-text">
            Weâ€™ll send a short code to confirm itâ€™s really you before changing your password.
          </div>
        </div>

        <div>
          <label>
            <input id="reset-smsConsent" type="checkbox" />
            <span>Yes, Iâ€™d like occasional SMS updates about orders and specials.</span>
          </label>
        </div>

        <div class="form-row" style="justify-content: space-between;">
          <button type="button" id="show-login-from-reset" class="link-btn">Back to Sign In</button>
          <button id="reset-submit" type="submit" class="primary-btn" disabled>Reset Password</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Sign-out confirmation -->
  <div id="signout-confirm">
    <div class="signout-dialog">
      <h4>Sign out?</h4>
      <p>Your cart and session will be cleared when you sign out.</p>
      <div class="signout-actions">
        <button id="cancel-signout" class="secondary-btn">Cancel</button>
        <button id="confirm-signout" class="primary-btn">Sign Out</button>
      </div>
    </div>
  </div>

  <footer>
    <span>Â© <span id="y"></span> Picante Pequin Salsa Co.</span>
    <span>Secure checkout by Stripe Â· Rewards applied at cart</span>
  </footer>

  <script>
    /* ===========================
       Config
       =========================== */

    // Update year
    document.getElementById('y').textContent = new Date().getFullYear();

    // Your automation endpoints (unchanged)
    const API = {
      issueOmniTok: 'https://default6eda43f3fbf04e2b9978b543d9dd31.e3.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e3755ec03d8241c09ddb4d73a1c2bb86/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9t0-qJP8VJW4G9_COUvGJxmFKL6IWjUBeEq4GYZj3kQ'
    };

    // Polling window (â‰¥ 2 minutes)
    const JOB = {
      intervalMs: 2000,
      timeoutMs: 120000
    };

    /* ===========================
       Utilities
       =========================== */
    function refreshSid() {
      sessionStorage.removeItem('sid');
      const newSid = crypto.randomUUID();
      sessionStorage.setItem('sid', newSid);
      console.log('New sid set:', newSid);
      return newSid;
    }

    function createJobId() {
      if (crypto?.randomUUID) return crypto.randomUUID();
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = (Math.random() * 16) | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    async function safeJson(resp) { try { return await resp.json(); } catch { return null; } }

    function normalizeStatus(payload) {
      const v =
        payload?.status ??
        payload?.result ??
        payload?.code ??
        (payload === true ? 'OK' : (payload === false ? 'ERROR' : undefined));
      return typeof v === 'string' ? v.toUpperCase() : v;
    }

    // OmniTok pre-flight fetcher
    async function getOmniTok(act) {
      let sid = sessionStorage.getItem('sid');
      if (!sid) {
        sid = crypto.randomUUID();
        sessionStorage.setItem('sid', sid);
      }

      let body;
      if (typeof act === 'string') {
        body = { act, sid };
      } else if (act && typeof act === 'object') {
        body = { sid, ...act };
      } else {
        throw new Error('Invalid getOmniTok argument');
      }

      const res = await fetch(API.issueOmniTok, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!res.ok) throw new Error(`Failed to get OmniTok config for ${body.act}`);

      const data = await res.json();
      return { ...data, sid };
    }

    /* ===========================
       API Button state + job handling
       =========================== */

    function setButtonState(btn, state) {
      btn.classList.remove('loading', 'success', 'error');
      if (state) btn.classList.add(state);
    }

    const DEV = {
      stubJobs: false,
      stubDelayMs: 3500,
      manualEvent: false
    };

    async function stubStatusUntilDone({ jobId, delayMs = 3000, manualEvent = true }) {
      function waitForEvent(ev, matchFn, timeoutMs) {
        return new Promise((resolve, reject) => {
          const on = (e) => {
            const d = e.detail || {};
            if (matchFn(d)) {
              window.removeEventListener(ev, on);
              resolve(d);
            }
          };
          window.addEventListener(ev, on);
          if (timeoutMs) {
            setTimeout(() => {
              window.removeEventListener(ev, on);
              reject(new Error('Manual event timed out'));
            }, timeoutMs);
          }
        });
      }

      if (manualEvent) {
        const eventPromise = waitForEvent('job:done', (d) => d.jobId === jobId, delayMs + 100);
        const delayPromise = new Promise((resolve) =>
          setTimeout(() => resolve({ status: 'OK', jobId, message: 'Stub auto-resolve' }), delayMs)
        );
        const detail = await Promise.race([eventPromise, delayPromise]);
        const status = normalizeStatus(detail);
        return { final: true, ok: status === 'OK' || status === 'SUCCESS', payload: detail };
      }

      await sleep(delayMs);
      return { final: true, ok: true, payload: { status: 'OK', jobId, message: 'Stub auto-resolve' } };
    }

    async function pollStatusUntilDone({ statusUrl, jobId, intervalMs = JOB.intervalMs, timeoutMs = JOB.timeoutMs }) {
      if (DEV.stubJobs || !statusUrl) {
        console.debug('[JOB:STUB] Using stub for job', { jobId, statusUrl });
        return stubStatusUntilDone({ jobId, delayMs: DEV.stubDelayMs, manualEvent: DEV.manualEvent });
      }

      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        try {
          const res = await fetch(statusUrl, {
            headers: { 'Content-Type': 'application/json', 'x-job-id': jobId }
          });
          const data = await safeJson(res);
          const status = normalizeStatus(data);

          if (status === 'SUCCESS' || status === 'OK') return { final: true, ok: true, payload: data };
          if (status === 'ERROR') return { final: true, ok: false, payload: data };
        } catch (err) {
          console.warn('Status poll error:', err);
        }
        await sleep(intervalMs);
      }
      return { final: true, ok: false, payload: { status: 'ERROR', message: 'Timed out waiting for job status.' } };
    }

    async function handleApiButton(btn, apiCall) {
      setButtonState(btn, 'loading');

      try {
        const first = await apiCall();

        if (first && first.jobId && first.statusUrl) {
          console.debug('[JOB] Waiting for completion', { jobId: first.jobId, statusUrl: first.statusUrl });

          const result = await pollStatusUntilDone({
            statusUrl: first.statusUrl,
            jobId: first.jobId,
            intervalMs: JOB.intervalMs,
            timeoutMs: JOB.timeoutMs
          });

          setButtonState(btn, result.ok ? 'success' : 'error');
          setTimeout(() => setButtonState(btn, ''), 1200);
          return { ok: result.ok, payload: result.payload };
        }

        const status = normalizeStatus(first);
        const ok = status === undefined ? true : (status === 'OK' || status === 'SUCCESS');

        setButtonState(btn, ok ? 'success' : 'error');
        setTimeout(() => setButtonState(btn, ''), 1200);
        return { ok, payload: first };

      } catch (err) {
        console.error(err);
        setButtonState(btn, 'error');
        setTimeout(() => setButtonState(btn, ''), 1200);
        return { ok: false, payload: { status: 'ERROR', message: 'Unhandled error' } };
      }
    }

    /* ===========================
       Catalog
       =========================== */
    const productsEcom = [
      { id: 'house-pequin', sku: 'PPSC-001', name: 'House Pequin Salsa',       price: 10, currency: 'USD', image: 'https://picantepequinsalsaco.com/images/image1.jpg', tiktok_sync: true, desc: 'A mild, bright blend of serrano, chile pequin, fresh tomatoes, white onion, garlic & cilantro.'},
      { id: 'spicy-green', sku: 'PPSC-002', name: 'Spicy Green Chile Pequin',  price: 10, currency: 'USD', image: 'https://picantepequinsalsaco.com/images/image2.jpg', tiktok_sync: true, desc: 'Smokey-citrusy salsa of serrano, chile pequin, fresh tomatillos, yellow onion, garlic, cilantro & lime.' },
      { id: 'red-hot', sku: 'PPSC-003', name: 'Red Hot Pepper Pequin',         price: 10, currency: 'USD', image: 'https://picantepequinsalsaco.com/images/image3.jpg', tiktok_sync: true, desc: 'Hot & sweet: fresno peppers, chile pequin, fresh tomatoes, yellow onion & garlic.' }, 
      { id: 'the-crew', sku: 'PPSC-004', name: 'The Crew',                     price: 30, currency: 'USD', image: 'https://picantepequinsalsaco.com/images/image4.jpg', tiktok_sync: true, desc: 'All three of our fullâ€‘size pequin salsas in one pack â€” perfect for sharing, gifting, or keeping your pantry stocked with every flavor we make.' }
    ];

    /* ===========================
       App state
       =========================== */
    let cart = [];
    let isLoggedIn = false;
    let currentUser = { email: '', name: '', rewards: 0 };

    /* ===========================
       DOM refs
       =========================== */
    const galleryEl       = document.getElementById('product-gallery');
    const cartOverlay     = document.getElementById('cart-container');
    const cartItemsEl     = document.getElementById('cart-items');
    const checkoutBtn     = document.getElementById('checkout-btn');
    const closeCart       = document.getElementById('close-cart');
    const cartIcon        = document.getElementById('cart-icon');
    const cartCountEl     = document.getElementById('cart-count');

    const loginBtn        = document.getElementById('login-btn');
    const loginOverlay    = document.getElementById('login-container');
    const closeLogin      = document.getElementById('close-login');
    const loginForm       = document.getElementById('login-form');
    const signupForm      = document.getElementById('signup-form');
    const showSignupBtn   = document.getElementById('show-signup');
    const showLoginBtn    = document.getElementById('show-login');
    const authTitle       = document.getElementById('auth-title');

    const usernameDisplay = document.getElementById('username-display');
    const rewardsDisplay  = document.getElementById('rewards-display');
    const rewardsDisplayFooter = document.getElementById('rewards-display-footer');

    const resetForm     = document.getElementById('reset-form');
    const showResetBtn  = document.getElementById('show-reset');
    const showLoginFromResetBtn = document.getElementById('show-login-from-reset');

    const signupRequestCodeBtn = document.getElementById('signup-request-code');
    const signupCodeInput      = document.getElementById('signup-verification-code');
    const resetRequestCodeBtn  = document.getElementById('reset-request-code');
    const resetCodeInput       = document.getElementById('reset-verification-code');

    // Stripe Elements setup
    let stripe, elements, card, cardMounted = false;

    // SMS Optional Consent checkbox state
    let smsConsent = false;

    const signupSmsConsentEl = document.getElementById('signup-smsConsent');
    const resetSmsConsentEl  = document.getElementById('reset-smsConsent');

    [signupSmsConsentEl, resetSmsConsentEl].forEach(el => {
      if (el) {
        el.addEventListener('change', () => {
          smsConsent = el.checked;
          console.log('smsConsent is now:', smsConsent);
        });
      }
    });

    function mountStripeElements() {
      if (!stripe) {
        stripe = Stripe('pk_live_51RqP1xGVhbxOz1NuTFAsWTaV6X0PJt4TxC4BFeAjLE4olqFlNGLh5ZOjifotx2qCQZRxBsISzexWaV9oO8BZrGU800LSSMudS9');
      }
      if (!elements) {
        elements = stripe.elements();
      }
      if (!cardMounted) {
        card = elements.create('card', {
          hidePostalCode: true,
          style: {
            base: {
              color: '#fff',
              fontFamily: 'system-ui, sans-serif',
              fontSize: '16px',
              '::placeholder': { color: '#9BA3AF' }
            },
            invalid: { color: '#ff6b6b' }
          }
        });
        card.mount('#card-element');
        cardMounted = true;
      }
    }

    document.querySelectorAll('.reveal-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const input = document.getElementById(btn.dataset.target);
        if (!input) return;

        const isHidden = input.type === 'password';
        input.type = isHidden ? 'text' : 'password';
        btn.textContent = isHidden ? 'ðŸª‡' : 'ðŸª…';
      });
    });

    /* ===========================
       Live validators
       =========================== */

    function setupRequestCodeHandler(btnId, codeInputId, act, emailInputId) {
      const btn = document.getElementById(btnId);
      const codeInput = document.getElementById(codeInputId);
      const emailInput = emailInputId ? document.getElementById(emailInputId) : null;
      if (!btn || !codeInput) return;

      btn.dataset.codeSent = 'false';

      btn.addEventListener('click', async () => {
        if (btn.dataset.codeSent === 'true') return;

        const sid = refreshSid();
        const email = emailInput ? emailInput.value.trim() : undefined;
        const phsms = document.getElementById('signup-phone')?.value.trim() || document.getElementById('reset-phone')?.value.trim() || "";

        const result = await handleApiButton(btn, async () => {
          const payload = email ? { act, email, smsConsent, phone: phsms } : { act };
          await getOmniTok(payload);
          return { status: 'OK', message: 'Verification code sent' };
        });

        if (result.ok) {
          codeInput.disabled = false;
          btn.disabled = true;
          btn.style.backgroundColor = 'var(--accent-green)';
          btn.textContent = 'Enter Code';
          btn.dataset.codeSent = 'true';
          showMessage('Verification code sent. Please check your email/phone.', 'success');
        } else {
          showMessage('Failed to send verification code. Try again.', 'error');
        }
      });
    }

    setupRequestCodeHandler(
      'signup-request-code',
      'signup-verification-code',
      'signup_code',
      'signup-email'
    );

    setupRequestCodeHandler(
      'reset-request-code',
      'reset-verification-code',
      'reset_code',
      'reset-email'
    );

    function checkSignupValidity() {
      const signupBtn = signupForm.querySelector('button[type="submit"]');
      const signupRequestCodeBtn = document.getElementById('signup-request-code');
      const signupCodeInput = document.getElementById('signup-verification-code');

      const ids = [
        'signup-firstname',
        'signup-lastname',
        'signup-address',
        'signup-city',
        'signup-state',
        'signup-zip',
        'signup-phone',
        'signup-email',
        'signup-password',
        'signup-password-confirm'
      ];

      const inputs = ids.map(id => document.getElementById(id));
      const allFilled = inputs.every(el => el && el.value.trim() !== '');

      const pw1 = document.getElementById('signup-password').value;
      const pw2 = document.getElementById('signup-password-confirm').value;
      const passwordsMatch = pw1 && pw1 === pw2;

      const strengthText = document.getElementById('password-strength-text');
      const strength = (strengthText?.textContent || '');
      const strongEnough = strength.includes('Strong') || strength.includes('Excellent');

      const emailInput = document.getElementById('signup-email');
      const emailVal = emailInput.value.trim();
      const atIndex = emailVal.lastIndexOf('@');
      const domain = atIndex !== -1 ? emailVal.slice(atIndex + 1) : '';
      const domainPattern = /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      const domainValid = atIndex !== -1 && domainPattern.test(domain);

      if (signupRequestCodeBtn) {
        const codeAlreadyEnabled = signupCodeInput && !signupCodeInput.disabled;
        signupRequestCodeBtn.disabled = !(domainValid) || codeAlreadyEnabled;
      }

      const codeOk = signupCodeInput && !signupCodeInput.disabled
        ? /^[A-Za-z0-9]{6}$/.test(signupCodeInput.value.trim())
        : false;

      signupBtn.disabled = !(allFilled && passwordsMatch && strongEnough && domainValid && codeOk);
    }

    (function emailDomainValidation() {
      const emailInput = document.getElementById('signup-email');
      const errorMsg = document.getElementById('email-error-msg');
      const domainPattern = /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

      emailInput.addEventListener('input', () => {
        const value = emailInput.value.trim();
        const atIndex = value.lastIndexOf('@');

        if (atIndex === -1) {
          errorMsg.style.display = 'none';
          emailInput.style.borderColor = '';
          checkSignupValidity();
          return;
        }

        const domain = value.slice(atIndex + 1);

        if (domainPattern.test(domain)) {
          errorMsg.style.display = 'none';
          emailInput.style.borderColor = 'var(--accent-green)';
        } else {
          errorMsg.style.display = 'block';
          emailInput.style.borderColor = 'var(--accent-red)';
        }
        checkSignupValidity();
      });
    })();

    (function passwordStrengthMeter() {
      const pwInput = document.getElementById('signup-password');
      const bar = document.getElementById('password-strength-bar');
      const text = document.getElementById('password-strength-text');

      pwInput.addEventListener('input', () => {
        const val = pwInput.value;
        let score = 0;

        if (val.length >= 8) score++;
        if (/[A-Z]/.test(val)) score++;
        if (/[0-9]/.test(val)) score++;
        if (/[^A-Za-z0-9]/.test(val)) score++;
        if (val.length >= 12) score++;

        const widths = ['0%', '20%', '40%', '60%', '80%', '100%'];
        const colors = ['red', 'orangered', 'orange', 'gold', 'yellowgreen', 'green'];
        const labels = ['Too short', 'Weak', 'Fair', 'Good', 'Strong', 'Excellent'];

        bar.style.width = widths[score];
        bar.style.background = colors[score];
        text.textContent = `Strength: ${labels[score]}`;

        checkSignupValidity();
      });
    })();

    (function livePasswordMatch() {
      const pw1 = document.getElementById('signup-password');
      const pw2 = document.getElementById('signup-password-confirm');
      const msg = document.getElementById('password-match-msg');

      function checkMatch() {
        if (!pw1.value && !pw2.value) {
          msg.style.display = 'none';
          pw1.style.borderColor = '';
          pw2.style.borderColor = '';
          checkSignupValidity();
          return;
        }
        if (pw1.value === pw2.value) {
          msg.style.display = 'none';
          pw1.style.borderColor = 'var(--accent-green)';
          pw2.style.borderColor = 'var(--accent-green)';
        } else {
          msg.style.display = 'block';
          pw1.style.borderColor = 'var(--accent-red)';
          pw2.style.borderColor = 'var(--accent-red)';
        }
        checkSignupValidity();
      }

      pw1.addEventListener('input', checkMatch);
      pw2.addEventListener('input', checkMatch);
    })();

    (function enableSignupButtonWhenValid() {
      const fields = [
        'signup-firstname',
        'signup-lastname',
        'signup-address',
        'signup-city',
        'signup-state',
        'signup-zip',
        'signup-phone',
        'signup-email',
        'signup-password',
        'signup-password-confirm'
      ].map(id => document.getElementById(id));

      fields.forEach(el => el && el.addEventListener('input', checkSignupValidity));

      const stateSelect = document.getElementById('signup-state');
      if (stateSelect) stateSelect.addEventListener('change', checkSignupValidity);

      const signupCodeInput = document.getElementById('signup-verification-code');
      if (signupCodeInput) {
        signupCodeInput.addEventListener('input', checkSignupValidity);
      }

      checkSignupValidity();
    })();

    function checkResetValidity() {
      const btn = document.getElementById('reset-submit');
      const resetRequestCodeBtn = document.getElementById('reset-request-code');
      const resetCodeInput = document.getElementById('reset-verification-code');

      const em  = document.getElementById('reset-email').value.trim();
      const ph  = document.getElementById('reset-phone').value.trim();
      const pw1 = document.getElementById('reset-password').value;
      const pw2 = document.getElementById('reset-password-confirm').value;

      const passwordsMatch = pw1 && pw1 === pw2;

      const strengthText = document.getElementById('reset-password-strength-text');
      const strength = (strengthText?.textContent || '');
      const strongEnough = strength.includes('Strong') || strength.includes('Excellent');

      const phoneValid = /^\d{10}$/.test(ph);
      const emailPresent = em.length > 3 && em.includes('@');

      if (resetRequestCodeBtn) {
        const codeAlreadyEnabled = resetCodeInput && !resetCodeInput.disabled;
        resetRequestCodeBtn.disabled = !(emailPresent && phoneValid) || codeAlreadyEnabled;
      }

      const codeOk = resetCodeInput && !resetCodeInput.disabled
        ? /^[A-Za-z0-9]{6}$/.test(resetCodeInput.value.trim())
        : false;

      btn.disabled = !(emailPresent && phoneValid && passwordsMatch && strongEnough && codeOk);
    }

    (function resetPasswordStrengthMeter() {
      const pwInput = document.getElementById('reset-password');
      const bar = document.getElementById('reset-password-strength-bar');
      const text = document.getElementById('reset-password-strength-text');

      pwInput.addEventListener('input', () => {
        const val = pwInput.value;
        let score = 0;

        if (val.length >= 8) score++;
        if (/[A-Z]/.test(val)) score++;
        if (/[0-9]/.test(val)) score++;
        if (/[^A-Za-z0-9]/.test(val)) score++;
        if (val.length >= 12) score++;

        const widths = ['0%', '20%', '40%', '60%', '80%', '100%'];
        const colors = ['red', 'orangered', 'orange', 'gold', 'yellowgreen', 'green'];
        const labels = ['Too short', 'Weak', 'Fair', 'Good', 'Strong', 'Excellent'];

        bar.style.width = widths[score];
        bar.style.background = colors[score];
        text.textContent = `Strength: ${labels[score]}`;

        checkResetValidity();
      });
    })();

    (function resetLivePasswordMatch() {
      const pw1 = document.getElementById('reset-password');
      const pw2 = document.getElementById('reset-password-confirm');
      const msg = document.getElementById('reset-password-match-msg');

      function checkMatch() {
        if (!pw1.value && !pw2.value) {
          msg.style.display = 'none';
          pw1.style.borderColor = '';
          pw2.style.borderColor = '';
          checkResetValidity();
          return;
        }
        if (pw1.value === pw2.value) {
          msg.style.display = 'none';
          pw1.style.borderColor = 'var(--accent-green)';
          pw2.style.borderColor = 'var(--accent-green)';
        } else {
          msg.style.display = 'block';
          pw1.style.borderColor = 'var(--accent-red)';
          pw2.style.borderColor = 'var(--accent-red)';
        }
        checkResetValidity();
      }

      pw1.addEventListener('input', checkMatch);
      pw2.addEventListener('input', checkMatch);
    })();

    (function enableResetButtonWhenValid() {
      ['reset-email', 'reset-phone', 'reset-password', 'reset-password-confirm']
        .map(id => document.getElementById(id))
        .forEach(el => el && el.addEventListener('input', checkResetValidity));

      const resetCodeInput = document.getElementById('reset-verification-code');
      if (resetCodeInput) {
        resetCodeInput.addEventListener('input', checkResetValidity);
      }

      checkResetValidity();
    })();

    resetForm.addEventListener('reset', () => {
      const bar = document.getElementById('reset-password-strength-bar');
      const text = document.getElementById('reset-password-strength-text');
      if (bar && text) {
        bar.style.width = '0%';
        bar.style.background = 'red';
        text.textContent = 'Strength: â€”';
      }
    });

    signupForm.addEventListener('reset', () => {
      const bar = document.getElementById('password-strength-bar');
      const text = document.getElementById('password-strength-text');
      if (bar && text) {
        bar.style.width = '0%';
        bar.style.background = 'red';
        text.textContent = 'Strength: â€”';
      }
    });

    /* ===========================
       Message helper
       =========================== */
    function showMessage(msg, type = 'info') {
      const box = document.createElement('div');
      box.className = `message-box ${type}`;
      box.textContent = msg;
      document.body.appendChild(box);
      setTimeout(() => box.remove(), 4000);
    }

    /* ===========================
       Render products
       =========================== */
    function renderProducts() {
      galleryEl.innerHTML = '';
      productsEcom.forEach(p => {
        const card = document.createElement('div');
        card.className = 'prod-card';
        card.innerHTML = `
          <div class="card-inner">
            <div class="card-front">
              <img src="${p.image}" alt="${p.name}">
              <h3 class="prod-name">${p.name}</h3>
              <p class="prod-price">$${p.price.toFixed(2)}</p>
              <div class="quantity">
                <button class="qty-btn minus">âˆ’</button>
                <input type="number" class="qty-input" value="0" min="0">
                <button class="qty-btn plus">+</button>
                <button class="info-btn" title="More Info">â“˜</button>
              </div>
              <button class="add-to-cart">Add to Cart</button>
            </div>
            <div class="card-back">
              <h4>Quick Facts</h4>
              <ul>
                <li>SKU: ${p.sku || 'â€”'}</li>
                <li>Price: $${p.price.toFixed(2)}</li>
                <li>${p.desc}</li>
              </ul>
              <button class="close-info">Close</button>
            </div>
          </div>
        `;

        const qtyInput = card.querySelector('.qty-input');
        qtyInput.addEventListener('input', () => {
          if (qtyInput.value === '' || parseInt(qtyInput.value, 10) < 0) {
            qtyInput.value = 0;
          }
        });

        card.querySelector('.qty-btn.minus').onclick = () =>
          qtyInput.value = Math.max(0, +qtyInput.value - 1);
        card.querySelector('.qty-btn.plus').onclick = () =>
          qtyInput.value = +qtyInput.value + 1;

        card.querySelector('.add-to-cart').onclick = () => {
          const qty = +qtyInput.value;
          if (!qty) return;
          addToCart({ ...p, qty });
          qtyInput.value = 0;
          toggleCart(true);
        };

        card.querySelector('.info-btn').onclick = () => card.classList.add('flipped');
        card.querySelector('.close-info').onclick = () => card.classList.remove('flipped');

        galleryEl.appendChild(card);
      });
    }

    /* ===========================
       Cart management
       =========================== */
    function addToCart(item) {
      const idx = cart.findIndex(x => x.id === item.id);
      if (idx > -1) cart[idx].qty += item.qty;
      else cart.push(item);
      renderCart();
    }
    function removeFromCart(id) {
      cart = cart.filter(i => i.id !== id);
      renderCart();
      updateRewardsUI();
    }

    let cartLocked = false;

    function renderCart() {
      cartItemsEl.innerHTML = '';

      cart.forEach(item => {
        const prod = productsEcom.find(p => p.id === item.id);
        const li = document.createElement('li');
        li.innerHTML = `
          <img src="${prod.image}" class="cart-thumb" alt="${prod.name}">
          <span class="cart-name">${prod.name}</span>
          <div class="cart-quantity">
            <button class="qty-btn minus">âˆ’</button>
            <input type="number" class="cart-qty-input" value="${item.qty}" min="0">
            <button class="qty-btn plus">+</button>
          </div>
        `;

        if (!cartLocked) {
          li.querySelector('.qty-btn.minus').onclick = () => {
            if (item.qty > 1) {
              item.qty--;
              renderCart();
              updateRewardsUI();
            } else {
              li.classList.add('removing');
              setTimeout(() => removeFromCart(item.id), 300);
            }
          };
          li.querySelector('.qty-btn.plus').onclick = () => {
            item.qty++;
            renderCart();
            updateRewardsUI();
          };

          const qtyInput = li.querySelector('.cart-qty-input');
          qtyInput.addEventListener('input', () => {
            const raw = qtyInput.value;
            if (raw === '') return;

            let qty = parseInt(raw, 10);
            if (isNaN(qty) || qty < 0) qty = 0;

            qtyInput.value = qty;
            item.qty = qty;

            if (qty === 0) {
              li.classList.add('removing');
              setTimeout(() => removeFromCart(item.id), 300);
            } else {
              renderCart();
              updateRewardsUI();
            }
          });
        } else {
          li.querySelectorAll('.qty-btn').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('disabled');
          });
        }

        cartItemsEl.appendChild(li);
      });

      const subtotal = cart.reduce((sum, { id, qty }) => {
        const prod = productsEcom.find(p => p.id === id);
        return sum + prod.price * qty;
      }, 0);

      const rewardsRow = document.getElementById('rewards-row');
      const rewardsBox = document.getElementById('rewards-box');
      const rewardsInput = document.getElementById('rewards-input');
      const rewardsAppliedEl = document.getElementById('rewards-applied');

      if (!cartLocked) {
        rewardsRow.style.display = isLoggedIn ? 'flex' : 'none';

        if (isLoggedIn && cart.length > 0) {
          rewardsBox.style.display = 'flex';
        } else {
          rewardsBox.style.display = 'none';
        }

        let applied = 0;
        if (rewardsInput && isLoggedIn) {
          const rawPoints = parseInt(rewardsInput.value || "0", 10);
          const pointsRedeemed = parseInt(rewardsInput?.value || "0", 10);
          currentUser.pointsRedeemed = pointsRedeemed;

          const usablePoints = Math.max(0, Math.min(rawPoints, currentUser.rewards));
          let appliedDollars = usablePoints / 1000;
          appliedDollars = Math.min(appliedDollars, subtotal);
          applied = Math.ceil(appliedDollars * 100) / 100;

          rewardsAppliedEl.textContent = applied.toFixed(2);
        }

        const newTotal = Math.max(0, subtotal - applied);
        document.getElementById('cart-total-value').textContent = newTotal.toFixed(2);

        checkoutBtn.disabled = !isLoggedIn || cart.length === 0;
        checkoutBtn.textContent = !isLoggedIn
          ? 'Sign In to Checkout'
          : 'Proceed to Checkout';
      }

      cartCountEl.textContent = cart.reduce((sum, i) => sum + i.qty, 0);
    }

    /* ===========================
       Overlay toggles
       =========================== */
    function toggleCart(open = false) {
      cartOverlay.classList.toggle('open', open || !cartOverlay.classList.contains('open'));
    }
    function toggleLogin(open = false) {
      loginOverlay.classList.toggle('open', open || !loginOverlay.classList.contains('open'));
    }

    /* ===========================
       Event bindings
       =========================== */
    cartIcon.addEventListener('click', () => toggleCart());
    closeCart.addEventListener('click', () => toggleCart());
    cartOverlay.addEventListener('click', e => { if (e.target === cartOverlay) toggleCart(); });

    loginBtn.addEventListener('click', () => {
      if (isLoggedIn) {
        document.getElementById('signout-confirm').style.display = 'flex';
      } else {
        toggleLogin(true);
        document.getElementById('login-username').focus();
      }
    });

    document.getElementById('cancel-signout').addEventListener('click', () => {
      document.getElementById('signout-confirm').style.display = 'none';
    });

    document.getElementById('confirm-signout').addEventListener('click', () => {
      document.getElementById('signout-confirm').style.display = 'none';
      signOut();
    });

    closeLogin.addEventListener('click', () => toggleLogin());
    loginOverlay.addEventListener('click', e => { if (e.target === loginOverlay) toggleLogin(); });

    showSignupBtn.addEventListener('click', () => {
      loginForm.classList.add('hidden');
      signupForm.classList.remove('hidden');
      resetForm.classList.add('hidden');
      authTitle.textContent = 'Create Account';
    });
    showLoginBtn.addEventListener('click', () => {
      signupForm.classList.add('hidden');
      resetForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      authTitle.textContent = 'Sign In';
    });

    showResetBtn.addEventListener('click', () => {
      loginForm.classList.add('hidden');
      signupForm.classList.add('hidden');
      resetForm.classList.remove('hidden');
      authTitle.textContent = 'Reset Password';
      document.getElementById('reset-email').focus();
    });

    showLoginFromResetBtn.addEventListener('click', () => {
      resetForm.classList.add('hidden');
      signupForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      authTitle.textContent = 'Sign In';
      document.getElementById('login-username').focus();
    });

    /* ===========================
       Form + button handlers
       =========================== */

    // Sign In
    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      const btn = loginForm.querySelector('button[type="submit"]');

      const result = await handleApiButton(btn, async () => {
        const email = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;

        if (!email || !password) {
          showMessage('Please enter both email and password.', 'error');
          return { status: 'ERROR', message: 'Missing credentials' };
        }

        const { endpoint, authToken, OmniTok, sid } = await getOmniTok('login');
        const jobId = createJobId();

        const resp = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': authToken,
            'X-OmniTok': OmniTok,
            'X-SID': sid,
            'x-job-id': jobId
          },
          body: JSON.stringify({ email, password, jobId })
        });

        const data = await safeJson(resp);

        const explicit = normalizeStatus(data);
        const okByPayload = typeof explicit === 'string'
          ? explicit === 'OK' || explicit === 'SUCCESS'
          : resp.ok;

        if (!okByPayload || !data?.firstName) {
          const msg = data?.message || 'Invalid credentials or server error';
          showMessage(msg, 'error');
          return { status: 'ERROR', message: msg };
        }

        return data;
      });

      if (result.ok && result?.payload) {
        const data = result.payload;
        isLoggedIn = true;
        currentUser = {
          email: data.email || document.getElementById('login-username').value.trim(),
          name: `${data.firstName ?? ''} ${data.lastName ?? ''}`.trim(),
          rewards: data.rewards ?? 0
        };
        if (data.token) sessionStorage.setItem('authToken', data.token);

        usernameDisplay.textContent = currentUser.name || 'Guest';
        rewardsDisplay.textContent = currentUser.rewards;
        rewardsDisplayFooter.textContent = currentUser.rewards;

        const rewardsRow = document.getElementById('rewards-row');
        const rewardsInput = document.getElementById('rewards-input');
        const pointsRedeemed = parseInt(rewardsInput?.value || "0", 10);
        currentUser.pointsRedeemed = pointsRedeemed;
        if (currentUser.rewards > 0) {
          rewardsRow.style.display = 'flex';
          rewardsInput.max = currentUser.rewards;
          rewardsInput.value = 0;
          document.getElementById('rewards-applied').textContent = '0.00';
        } else {
          rewardsRow.style.display = 'none';
        }

        loginBtn.textContent = 'Sign Out';
        loginBtn.classList.add('logout');
        checkoutBtn.disabled = cart.length === 0;
        checkoutBtn.textContent = cart.length ? 'Proceed to Checkout' : 'Add items to checkout';
        loginForm.reset();
        toggleLogin(false);
        showMessage(data?.message || 'Signed in', 'success');
        renderCart();
        updateRewardsUI();
      }
    });

    // Reset Password
    resetForm.addEventListener('submit', async e => {
      e.preventDefault();
      const btn = resetForm.querySelector('button[type="submit"]');

      const result = await handleApiButton(btn, async () => {
        const email    = document.getElementById('reset-email').value.trim();
        const phone    = document.getElementById('reset-phone').value.trim();
        const password = document.getElementById('reset-password').value;
        const verificationCode = document.getElementById('reset-verification-code').value.trim();

        if (!email || !/^\d{10}$/.test(phone) || !password) {
          showMessage('Please complete all fields correctly.', 'error');
          return { status: 'ERROR', message: 'Invalid input' };
        }

        const { endpoint, authToken, OmniTok, sid } = await getOmniTok('reset');
        const jobId = createJobId();

        const resp = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': authToken,
            'X-OmniTok': OmniTok,
            'X-SID': sid,
            'x-job-id': jobId
          },
          body: JSON.stringify({ email, phone, newPassword: password, verificationCode, jobId })
        });

        const data = await safeJson(resp);

        const explicit = normalizeStatus(data);
        const okByPayload = typeof explicit === 'string'
          ? explicit === 'OK' || explicit === 'SUCCESS'
          : resp.ok;

        if (!okByPayload) {
          const msg = data?.message || 'Password reset failed';
          showMessage(msg, 'error');
          return { status: 'ERROR', message: msg };
        }

        return data;
      });

      if (result.ok) {
        const data = result.payload || {};
        const email =
          (data.body && data.body.email) ??
          data.email ??
          document.getElementById('reset-email').value.trim();

        showMessage(data?.message || 'Password reset successful. Please sign in.', 'success');

        document.getElementById('login-username').value = email;

        resetForm.reset();
        checkResetValidity();
        document.getElementById('reset-verification-code').disabled = true;
        resetRequestCodeBtn.dataset.codeSent = 'true';

        const resetBar = document.getElementById('reset-password-strength-bar');
        const resetText = document.getElementById('reset-password-strength-text');
        if (resetBar && resetText) {
          resetBar.style.width = '0%';
          resetBar.style.background = 'red';
          resetText.textContent = 'Strength: â€”';
        }

        showLoginFromResetBtn.click();

        setTimeout(() => {
          const signInBtn = loginForm.querySelector('button[type="submit"]');
          if (signInBtn) {
            signInBtn.classList.remove('shimmer');
            void signInBtn.offsetWidth;
            signInBtn.classList.add('shimmer');
            setTimeout(() => signInBtn.classList.remove('shimmer'), 800);
          }
        }, 50);
      }
    });

    // Create Account
    signupForm.addEventListener('submit', async e => {
      e.preventDefault();
      const btn = signupForm.querySelector('button[type="submit"]');

      const result = await handleApiButton(btn, async () => {
        const fn   = document.getElementById('signup-firstname').value.trim();
        const ln   = document.getElementById('signup-lastname').value.trim();
        const addr = document.getElementById('signup-address').value.trim();
        const city = document.getElementById('signup-city').value.trim();
        const st   = document.getElementById('signup-state').value.trim();
        const zip  = document.getElementById('signup-zip').value.trim();
        const ph   = document.getElementById('signup-phone').value.trim();
        const em   = document.getElementById('signup-email').value.trim();
        const pw1  = document.getElementById('signup-password').value;
        const pw2  = document.getElementById('signup-password-confirm').value;
        const verificationCode = document.getElementById('signup-verification-code').value.trim();

        if (pw1 !== pw2) {
          showMessage('Passwords do not match.', 'error');
          return { status: 'ERROR', message: 'Passwords mismatch' };
        }
        if (!/^\d{5}$/.test(zip)) {
          showMessage('ZIP Code must be 5 digits.', 'error');
          return { status: 'ERROR', message: 'Invalid ZIP' };
        }
        if (!/^\d{10}$/.test(ph)) {
          showMessage('Phone must be 10 digits.', 'error');
          return { status: 'ERROR', message: 'Invalid phone' };
        }

        const { endpoint, authToken, OmniTok, sid } = await getOmniTok('signup');
        const jobId = createJobId();

        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': authToken,
            'X-OmniTok': OmniTok,
            'X-SID': sid,
            'x-job-id': jobId
          },
          body: JSON.stringify({
            firstName: fn,
            lastName: ln,
            address: addr,
            city,
            state: st,
            zip,
            phone: ph,
            email: em,
            password: pw1,
            verificationCode,
            smsConsent,
            jobId
          })
        });

        const data = await safeJson(res);

        const explicit = normalizeStatus(data);
        const okByPayload = typeof explicit === 'string'
          ? explicit === 'OK' || explicit === 'SUCCESS'
          : res.ok;

        if (!okByPayload) {
          const msg = data?.message || 'Signup failed';
          showMessage(msg, 'error');
          return { status: 'ERROR', message: msg };
        }

        return data;
      });

      if (result.ok) {
        const data = result.payload || {};
        showMessage(data?.message || 'Account created! Please sign in.', 'success');
        const email = data.body?.email ?? data.email ?? document.getElementById('signup-email').value.trim();
        document.getElementById('login-username').value = email;
        signupForm.reset();
        checkSignupValidity();
        document.getElementById('signup-verification-code').disabled = true;
        signupRequestCodeBtn.dataset.codeSent = 'true';

        const signupBar = document.getElementById('password-strength-bar');
        const signupText = document.getElementById('password-strength-text');
        if (signupBar && signupText) {
          signupBar.style.width = '0%';
          signupBar.style.background = 'red';
          signupText.textContent = 'Strength: â€”';
        }
        showLoginBtn.click();

        setTimeout(() => {
          const signInBtn = loginForm.querySelector('button[type="submit"]');
          if (signInBtn) {
            signInBtn.classList.remove('shimmer');
            void signInBtn.offsetWidth;
            signInBtn.classList.add('shimmer');
            setTimeout(() => signInBtn.classList.remove('shimmer'), 800);
          }
        }, 50);
      }
    });

    /* ===========================
       Checkout
       =========================== */
    let checkoutPhase = 1;
    let confirmStep = false;

    function startShimmer(btn, text) {
      btn.classList.add('loading');
      btn.dataset.loadingText = text || 'Processing...';
    }

    function stopShimmer(btn) {
      btn.classList.remove('loading');
      delete btn.dataset.loadingText;
    }

    checkoutBtn.addEventListener('click', async () => {
      if (checkoutPhase === 1) {
        startShimmer(checkoutBtn, 'Processing Order...');
        let result;

        try {
          result = await handleApiButton(checkoutBtn, async () => {
            if (!cart.length) {
              showMessage('Your cart is empty.', 'error');
              return { status: 'ERROR', message: 'Empty cart' };
            }
            if (!isLoggedIn) {
              showMessage('Please sign in first.', 'error');
              return { status: 'ERROR', message: 'Not signed in' };
            }

            const { endpoint, authToken, OmniTok, sid } = await getOmniTok('checkout');
            const jobId = createJobId();
            const total = cart.reduce((sum, { id, qty }) => {
              const prod = productsEcom.find(p => p.id === id);
              return sum + prod.price * qty;
            }, 0);
            const rewardsInput = document.getElementById('rewards-input');
            const pointsRedeemed = parseInt(rewardsInput?.value || "0", 10);
            currentUser.pointsRedeemed = pointsRedeemed;

            const payload = {
              user: {
                email: currentUser.email,
                name: currentUser.name,
                rewards: currentUser.rewards
              },
              items: cart.map(i => ({
                id: i.id,
                sku: i.sku,
                name: i.name,
                price: i.price,
                currency: i.currency,
                qty: i.qty
              })),
              total,
              pointsRedeemed: currentUser.pointsRedeemed,
              jobId
            };

            const resp = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-auth-token': authToken,
                'X-OmniTok': OmniTok,
                'X-SID': sid,
                'x-job-id': jobId
              },
              body: JSON.stringify(payload)
            });

            document.getElementById('rewards-box').style.display = 'none';
            const data = await safeJson(resp);

            const explicit = normalizeStatus(data);
            const okByPayload = typeof explicit === 'string'
              ? explicit === 'OK' || explicit === 'SUCCESS'
              : resp.ok;

            if (!okByPayload) {
              const msg = data?.message || 'Order submission failed';
              showMessage(msg, 'error');
              return { status: 'ERROR', message: msg };
            }

            return data;
          });
        } finally {
          stopShimmer(checkoutBtn);
        }

        if (result?.ok && result?.payload) {
          const raw = result.payload || {};

          const data = {
            orderNumber: raw.orderNumber || '',
            shippingCost: Number(raw.shippingCost) || 0,
            taxAmount: Number(raw.taxAmount) || 0,
            totalAmount: Number(raw.totalAmount) || 0,
            subtotal: Number(raw.subtotal) || 0,
            currency: raw.currency || 'usd',
            clientSecret: raw.clientSecret || raw.client_secret || '',
            paymentIntentId: raw.paymentIntentId || raw.payment_intent_id || '',
            pointsRedeemed: Number(raw.pointsRedeemed) || 0
          };

          currentUser.name = raw.billingName || currentUser.name;
          currentUser.email = raw.billingEmail || currentUser.email;
          currentUser.addressLine1 = raw.billingLine1 || '';
          currentUser.city = raw.billingCity || '';
          currentUser.state = raw.billingState || '';
          currentUser.zip = raw.billingPostal || '';
          currentUser.country = raw.billingCountry || 'US';

          const orderNumberEl = document.getElementById('order-number');
          const shippingCostEl = document.getElementById('shipping-cost');
          const taxAmountEl = document.getElementById('tax-amount');
          const totalAmountEl = document.getElementById('total-amount');
          const subtotalEl = document.getElementById('subtotal-value');

          if (orderNumberEl) {
            orderNumberEl.textContent = data.orderNumber;
            document.getElementById('order-info-row').style.display = 'flex';
          }
          if (subtotalEl) {
            subtotalEl.textContent = (data.subtotal / 100).toFixed(2);
            document.getElementById('subtotal-row').style.display = 'flex';
          }
          if (shippingCostEl) {
            shippingCostEl.textContent = (data.shippingCost / 100).toFixed(2);
            document.getElementById('shipping-row').style.display = 'flex';
          }
          if (taxAmountEl) {
            taxAmountEl.textContent = (data.taxAmount / 100).toFixed(2);
            document.getElementById('tax-row').style.display = 'flex';
          }
          if (totalAmountEl) {
            totalAmountEl.textContent = (data.totalAmount / 100).toFixed(2);
          }

          document.getElementById('rewards-row').style.display = 'none';

          if (data.totalAmount === 0) {
            showMessage('Order completed using rewards points!', 'success');

            cart = [];
            renderCart();

            document.getElementById('payment-section').style.display = 'none';
            document.getElementById('rewards-row').style.display = 'none';

            checkoutBtn.textContent = 'Payment Successful';
            checkoutBtn.disabled = true;
            checkoutBtn.style.backgroundColor = '#28a745';
            checkoutBtn.style.cursor = 'default';

            checkoutPhase = 1;
            confirmStep = false;
            sessionStorage.removeItem('sid');

            let countdownSeconds = 5;
            let countdownEl = document.createElement('div');
            countdownEl.style.marginTop = '0.5rem';
            countdownEl.style.fontSize = '0.9rem';
            countdownEl.style.color = '#a76e28';
            countdownEl.textContent = `Redirecting Home in ${countdownSeconds}...`;
            checkoutBtn.insertAdjacentElement('afterend', countdownEl);

            let countdownTimer = setInterval(() => {
              countdownSeconds--;
              countdownEl.textContent = `Redirecting Home in ${countdownSeconds}...`;
              if (countdownSeconds <= 0) {
                clearInterval(countdownTimer);
                checkoutBtn.disabled = true;
                checkoutBtn.style.cursor = 'default';
                countdownEl.style.transition = 'opacity 0.5s ease';
                countdownEl.style.opacity = '0';
                setTimeout(() => countdownEl.remove(), 500);
                signOut();
                window.location.href = 'https://picantepequinsalsaco.com/';
              }
            }, 1000);

            return;
          }

          checkoutBtn.dataset.orderData = JSON.stringify(data);
          document.getElementById('cart-total-value').textContent = (data.totalAmount / 100).toFixed(2);

          cartLocked = true;
          renderCart();

          checkoutBtn.textContent = 'Pay for Order';
          checkoutPhase = 2;
          confirmStep = false;
          return;
        }
      }

      if (checkoutPhase === 2 && !confirmStep) {
        document.getElementById('payment-section').style.display = 'block';
        mountStripeElements();
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = 'Confirm & Pay';
        confirmStep = true;
        return;
      }

      if (checkoutPhase === 2 && confirmStep) {
        const data = JSON.parse(checkoutBtn.dataset.orderData || '{}');
        const clientSecret = data.clientSecret;
        const paymentIntentId = data.paymentIntentId;

        if (!clientSecret) {
          showMessage('Missing client secret for payment.', 'error');
          return;
        }

        startShimmer(checkoutBtn, 'Confirming...');

        try {
          const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
              card,
              billing_details: {
                name: currentUser?.name || '',
                email: currentUser?.email || '',
                address: {
                  line1: currentUser.addressLine1,
                  city: currentUser.city,
                  state: currentUser.state,
                  postal_code: currentUser.zip,
                  country: currentUser.country
                }
              }
            }
          });

          if (error) {
            document.getElementById('card-errors').textContent = error.message || 'Payment failed. Try another card.';
            showMessage(error.message || 'Payment failed.', 'error');
            return;
          }

          if (paymentIntent && paymentIntent.status === 'succeeded') {
            showMessage('Payment successful!', 'success');
            cart = [];
            renderCart();
            document.getElementById('payment-section').style.display = 'none';
            checkoutBtn.textContent = 'Payment Successful';
            checkoutBtn.disabled = true;
            checkoutBtn.style.backgroundColor = '#28a745';
            checkoutBtn.style.cursor = 'default';
            checkoutPhase = 1;
            confirmStep = false;
            sessionStorage.removeItem('sid');

            let countdownSeconds = 5;
            let countdownEl = document.createElement('div');
            countdownEl.style.marginTop = '0.5rem';
            countdownEl.style.fontSize = '0.9rem';
            countdownEl.style.color = '#a76e28';
            countdownEl.textContent = `Redirecting Home in ${countdownSeconds}...`;
            checkoutBtn.insertAdjacentElement('afterend', countdownEl);
            checkoutBtn.disabled = false;
            checkoutBtn.style.cursor = 'pointer';

            let countdownTimer = setInterval(() => {
              countdownSeconds--;
              countdownEl.textContent = `Redirecting Home in ${countdownSeconds}...`;
              if (countdownSeconds <= 0) {
                clearInterval(countdownTimer);
                checkoutBtn.disabled = true;
                checkoutBtn.style.cursor = 'default';
                countdownEl.style.transition = 'opacity 0.5s ease';
                countdownEl.style.opacity = '0';
                setTimeout(() => countdownEl.remove(), 500);
                signOut();
                window.location.href = 'https://picantepequinsalsaco.com/';
              }
            }, 1000);
          } else {
            showMessage(`Payment status: ${paymentIntent?.status || 'unknown'}`, 'info');
          }
        } finally {
          stopShimmer(checkoutBtn);
        }

        return;
      }
    });

    // Rewards input live handler
    document.addEventListener('input', (e) => {
      if (e.target.id === 'rewards-input') {
        updateRewardsUI();
        const subtotal = cart.reduce((sum, { id, qty }) => {
          const prod = productsEcom.find(p => p.id === id);
          return sum + (Number(prod.price) || 0) * (Number(qty) || 0);
        }, 0);

        const rawPoints = parseInt(e.target.value || "0", 10);
        const maxPointsBySubtotal = Math.floor(subtotal * 1000);

        const usablePoints = Math.max(
          0,
          Math.min(rawPoints, currentUser.rewards, maxPointsBySubtotal)
        );

        let applied = usablePoints / 1000;
        const appliedRounded = Math.ceil(applied * 100) / 100;

        e.target.value = usablePoints;
        document.getElementById('rewards-applied').textContent = appliedRounded.toFixed(2);
        document.getElementById('cart-total-value').textContent = (subtotal - appliedRounded).toFixed(2);
      }
    });

    function updateRewardsUI() {
      const rewardsInput = document.getElementById('rewards-input');
      if (!rewardsInput) return;

      const subtotal = cart.reduce((sum, { id, qty }) => {
        const prod = productsEcom.find(p => p.id === id);
        return sum + (Number(prod.price) || 0) * (Number(qty) || 0);
      }, 0);

      const rawPoints = parseInt(rewardsInput.value || "0", 10);
      const maxPointsBySubtotal = Math.floor(subtotal * 1000);

      const usablePoints = Math.max(
        0,
        Math.min(rawPoints, currentUser.rewards, maxPointsBySubtotal)
      );

      let applied = usablePoints / 1000;
      const appliedRounded = Math.ceil(applied * 100) / 100;

      rewardsInput.value = usablePoints;
      document.getElementById('rewards-applied').textContent = appliedRounded.toFixed(2);
      document.getElementById('cart-total-value').textContent = (subtotal - appliedRounded).toFixed(2);
    }

    /* ===========================
       State dropdown enhancement
       =========================== */
    (function enhanceStateSelect() {
      const select = document.getElementById('signup-state');
      const btn = document.querySelector('.state-dropdown-btn');
      if (!select || !btn) return;

      function openNativeDropdown() {
        if (typeof select.showPicker === 'function') {
          select.showPicker();
        } else {
          select.focus();
          const ev = new MouseEvent('mousedown', { bubbles: true, cancelable: true, view: window });
          select.dispatchEvent(ev);
        }
      }

      btn.addEventListener('click', (e) => {
        e.preventDefault();
        openNativeDropdown();
      });
    })();

    function signOut() {
      cart = [];
      isLoggedIn = false;
      currentUser = { email: '', name: '', rewards: 0 };
      checkoutPhase = 1;
      confirmStep = false;
      cartLocked = false;

      sessionStorage.removeItem('authToken');
      sessionStorage.removeItem('sid');

      usernameDisplay.textContent = 'Guest';
      rewardsDisplay.textContent = '0';
      rewardsDisplayFooter.textContent = '0';
      loginBtn.textContent = 'Sign In';
      loginBtn.classList.remove('logout');

      checkoutBtn.disabled = true;
      checkoutBtn.textContent = 'Sign In to Checkout';
      checkoutBtn.style.backgroundColor = '';
      checkoutBtn.style.cursor = 'pointer';

      document.getElementById('payment-section').style.display = 'none';

      document.getElementById('order-info-row').style.display = 'none';
      document.getElementById('shipping-row').style.display = 'none';
      document.getElementById('tax-row').style.display = 'none';

      document.getElementById('cart-total-value').textContent = '0.00';

      checkoutBtn.dataset.orderData = '';

      renderCart();
    }

    /* ===========================
       Confirm-on-exit
       =========================== */
    window.addEventListener('beforeunload', (e) => {
      e.preventDefault();
      e.returnValue = '';
    });

    window.addEventListener('pagehide', () => {
      if (isLoggedIn) {
        signOut();
      }
    });

    /* ===========================
       Persist cart and init
       =========================== */
    window.addEventListener('beforeunload', () => {
      sessionStorage.setItem('cart', JSON.stringify(cart));
    });

    document.addEventListener('DOMContentLoaded', () => {
      const saved = sessionStorage.getItem('cart');
      if (saved) { 
        cart = JSON.parse(saved); 
        renderCart(); 
      }
      renderProducts();
    });
  </script>
</body>
</html>
