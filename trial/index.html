<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================
       Versioning + auth prep
       ========================= -->
  <script>
    // Paint-block until gate decides
    document.documentElement.classList.add('pps-auth-pending');

        //  Collect anomalies and telemetry for Horus
function collectAnomalies() {
  const anomalies = [];

  // 1. Navigation anomalies
  const navEntries = performance.getEntriesByType('navigation');
  if (navEntries.length > 1) {
    anomalies.push(`Multiple navigation entries detected (${navEntries.length})`);
  }

  // 2. Resource load errors
  const resourceErrors = performance.getEntriesByType('resource')
    .filter(r => r.duration > 5000); // slow loads
  if (resourceErrors.length > 0) {
    anomalies.push(`Slow resources: ${resourceErrors.length} over 5s`);
  }

  // 3. Console errors (captured globally)
  if (window._horusErrors && window._horusErrors.length > 0) {
    anomalies.push(`Console errors: ${window._horusErrors.length}`);
  }

  // 4. DOM mutation anomalies (optional)
  if (window._horusMutations && window._horusMutations.length > 50) {
    anomalies.push(`High DOM mutation rate: ${window._horusMutations.length}`);
  }

  // 5. Memory usage anomalies
  if (performance.memory) {
    const used = performance.memory.usedJSHeapSize;
    const limit = performance.memory.jsHeapSizeLimit;
    if (used / limit > 0.8) {
      anomalies.push(`High memory usage: ${(used/limit*100).toFixed(1)}%`);
    }
  }

  return anomalies;
}
    // Capture console errors
    window._horusErrors = [];
    window.addEventListener('error', e => {
      window._horusErrors.push({
        message: e.message,
        source: e.filename,
        line: e.lineno
      });
    });

    // Capture DOM mutations
    window._horusMutations = [];
    const observer = new MutationObserver(mutations => {
      window._horusMutations.push(...mutations);
    });
    observer.observe(document, { childList: true, subtree: true });

    const APP_VERSION = '2025-11-18-v3'; // bump this on each deploy
    const verKey = `pps_app_version@${location.origin}`;
    const authKey = `pps_loggedIn@${location.origin}`;

    // Version bump: clear auth/session so users re-auth after deploy
    if (sessionStorage.getItem(verKey) !== APP_VERSION) {
      sessionStorage.removeItem(authKey);
      sessionStorage.removeItem('sid');
      sessionStorage.removeItem('loggedIn'); // legacy
      sessionStorage.setItem(verKey, APP_VERSION);
      console.info('App version changed â€” cleared auth state');
    }

    // Optional: unregister service workers during rollout
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations()
        .then(regs => regs.forEach(r => r.unregister().then(()=>console.info('SW unregistered'))))
        .catch(e => console.warn('SW unregister failed', e));
    }

    /* -------------------------
       FORCE LOGOUT HELPER
       ------------------------- */
async function forceLogout() {
  const authKey   = `pps_loggedIn@${location.origin}`;
  const sid       = sessionStorage.getItem("sid");
  const username  = sessionStorage.getItem("username");
  sessionStorage.removeItem(authKey);
  sessionStorage.removeItem("sid");
  sessionStorage.removeItem("masterTok");
  sessionStorage.removeItem("OmniTok");


  // Build logout payload before clearing tokens
  const payload = {
    sid,
    username,
    MasterTok: null,
    OmniTok: null,
    ts: new Date().toISOString(),
    logout: true
  };

  try {
    // Send one-off Horus logout pulse
    const res = await fetch(
      "https://default6eda43f3fbf04e2b9978b543d9dd31.e3.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9aa26c1296ee4694b10d7287acf604d5/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=hsuEfswj0_Ly1J3pWXLM7PVwwpOGIYs7KEB2MLhaggI",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }
    );
    console.info("HORUS: logout pulse sent", res.status);
  } catch (e) {
    console.warn("HORUS: logout pulse failed", e);
  }
  stopHorus();

  // Reset login button state
  const btn = document.getElementById("loginBtn");
  if (btn) {
    btn.disabled = false;
    btn.textContent = "Login";
    btn.classList.remove("is-success", "is-error", "btn-loading");
  }

  // Show login; hide all post-login cards
  document.getElementById("loginContainer")?.classList.remove("hidden");
  document.getElementById("modeSelector")?.classList.add("hidden");
  document.getElementById("posContainer")?.classList.add("hidden");
  document.getElementById("contactForm")?.classList.add("hidden");

  // Hide header buttons
  document.getElementById("chooseJoinBtn")?.classList.add("hidden");
  document.getElementById("chooseLogOutBtn")?.classList.add("hidden");
  document.getElementById("returnFromJoinBtn")?.classList.add("hidden");

  // Reset rewards state to guest
  resetRewardsToGuest();

  // Overlay for focus
  document.getElementById("authOverlay")?.classList.remove("hidden");

  // Reset global view/caller
  currentView = "login";
  sessionStorage.setItem("currentView", currentView);
  joinCaller = "login";
  sessionStorage.setItem("joinCaller", joinCaller);

  console.info("PPS: forced logout â€” session cleared");
}
window.forceLogout = forceLogout;

     // Horus 5 tap Logout
    
    function setupHorusLogout() {
      const horusEl = document.querySelector('.horus');
      if (!horusEl) return;

      let clickCount = 0;
      let timerId = null;

      horusEl.addEventListener('click', () => {
        clickCount++;
        if (!timerId) {
          timerId = setTimeout(() => {
            clickCount = 0;
            timerId = null;
          }, 8000);
        }
        if (clickCount >= 5) {
          clearTimeout(timerId);
          timerId = null;
          clickCount = 0;
          console.info('HORUS: 5 clicks detected within 8s â†’ force logout');
          forceLogout();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', setupHorusLogout);


      //Initialize HORUS//      
const HORUS_INTERVAL_MS = 120000; // Horus pulse every 120s
let _horusTimer = null;

// ðŸ”§ helper: set Horus eyes by state
function horusEyes(state) {
  switch (state) {
    case "progress":
      setEyes([
        { id: "LeftEye", state: "ok",   flash: true, rate: 1200 }, // slow ok
        { id: "RightEye", state: "warn", flash: true, rate: 350 }  // fast warn
      ]);
      break;
    case "success":
      setEyes([
        { id: "LeftEye", state: "ok",   flash: true, rate: 1200 },
        { id: "RightEye", state: "ok",  flash: true, rate: 1200 }
      ]);
      break;
    case "error":
      setEyes([
        { id: "LeftEye", state: "error", flash: true, rate: 800 },
        { id: "RightEye", state: "error", flash: true, rate: 800 }
      ]);
      break;
  }
}

//  HORUS: sends Horus heartbeat to backend
async function sendHorusPulse() {
  const sid       = sessionStorage.getItem("sid");
  const username  = sessionStorage.getItem("username");
  const MasterTok = sessionStorage.getItem("masterTok");
  const OmniTok   = sessionStorage.getItem("omniTok");

  if (!sid || !username) {
    console.warn("Horus pulse aborted - missing sid or username");
    window.forceLogout?.();
    return;
  }

  const payload = {
    sid,
    username,
    MasterTok,
    OmniTok,
    logout: false,
    ts: new Date().toISOString(),
    logout: false,
    anomalies: collectAnomalies(),
    metrics: {
      cpuLoad: window.navigator.hardwareConcurrency,
      memUsage: performance.memory?.usedJSHeapSize,
      navEvents: performance.getEntriesByType("navigation").length
    }
  };

  try {
    horusEyes("progress"); // show inâ€‘progress state

    const res = await fetch('https://default6eda43f3fbf04e2b9978b543d9dd31.e3.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9aa26c1296ee4694b10d7287acf604d5/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=hsuEfswj0_Ly1J3pWXLM7PVwwpOGIYs7KEB2MLhaggI', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      console.info("Horus pulse success");
      horusEyes("success");
    } else {
      console.error(`Horus pulse failed (${res.status})`);
      alert("Session expired â€” Horus closed the gate.");
      window.forceLogout?.();
      horusEyes("error");
    }
  } catch (err) {
    console.error("Horus pulse error", err);
    alert("Session expired â€” Horus closed the gate.");
    window.forceLogout?.();
    horusEyes("error");
  }
}

//  startHorus: starts Horus pulse loop
function startHorus() {
  if (_horusTimer) return;
  _horusTimer = setInterval(sendHorusPulse, HORUS_INTERVAL_MS);
  sendHorusPulse(); // immediate first ping
}

//  stopHorus: stops Horus pulse loop
function stopHorus() {
  if (_horusTimer) {
    clearInterval(_horusTimer);
    _horusTimer = null;
  }
}

// HORUS UX //
// Change eye state (color)
function setEyeState(id, state) {
  const el = document.getElementById(id);
  if (!el) {
    console.warn(`Eye ${id} not found`);
    return;
  }
  el.classList.remove("eye--idle","eye--ok","eye--warn","eye--error","eye--off");
  el.classList.add(`eye--${state}`);
}

// Start flashing an eye
function flashEye(id, rate = 600) {
  const el = document.getElementById(id);
  if (!el) {
    console.warn(`Eye ${id} not found`);
    return;
  }
  if (rate < 600) el.dataset.rate = "fast";
  else if (rate > 600) el.dataset.rate = "slow";
  else el.dataset.rate = "";
  el.classList.add("eye--flash");
}

// Stop flashing an eye
function stopFlash(id) {
  const el = document.getElementById(id);
  if (!el) {
    console.warn(`Eye ${id} not found`);
    return;
  }
  el.classList.remove("eye--flash");
  el.removeAttribute("data-rate");
}

//  Unified eye controller
function setEyes(configs) {
  configs.forEach(cfg => {
    const { id, state, flash, rate } = cfg;
    setEyeState(id, state);

    if (flash) {
      flashEye(id, rate);
    } else {
      stopFlash(id);
    }
  });
}

// --- Default scenario before backend pulse ---
document.addEventListener("DOMContentLoaded", () => {
  // Default state
  setEyes([
    { id: "LeftEye",  state: "idle", flash: true,  rate: 1200 },
    { id: "RightEye", state: "idle", flash: true,  rate: 1200 }
  ]);

  // Username focus
  const usernameInput = document.getElementById("loginUsername");
  if (usernameInput) {
    usernameInput.addEventListener("focus", () => {
      console.info("Username focus â†’ HORUS eyes update");
      setEyes([
        { id: "LeftEye",  state: "ok",   flash: false },
        { id: "RightEye", state: "idle", flash: true, rate: 1200 }
      ]);
    });
  }
});
  </script>

  <!-- =========================
       Meta head
       ========================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Picante Pequin Salsa Co â€“ Smoked Chile Pequin Salsa from Texas</title>
  <meta name="description" content="Picante Pequin Salsa Co crafts fresh, locally sourced chile pequin salsas in Texas. Order online for delivery or pickup.">
  <meta name="color-scheme" content="dark light" />

  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Picante Pequin Salsa Co">
  <meta property="og:title" content="Picante Pequin Salsa Co â€“ Fresh Chile Pequin Salsas from Texas">
  <meta property="og:description" content="Picante Pequin Salsa Co crafts fresh, locally sourced chile pequin salsas in Texas. Order online for delivery or pickup.">
  <meta property="og:image" content="https://picantepequinsalsaco.com/images/social-preview.png">
  <meta property="og:url" content="https://picantepequinsalsaco.com">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="icon" type="image/x-icon" href="/images/favicon.ico" sizes="48x48">
  <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.webmanifest">

  <link rel="preload" as="image" href="https://picantepequinsalsaco.com/images/bg.png">

  <!-- =========================
       CSS
       ========================= -->
  <style>
    :root {
      --bg-deep: #1e1e1e00;
      --ink: #ececec;
      --muted: #b0b0b0;
      --banner: #00001b63;
      --surface: #ffffff0d;
      --dropdown: #000000;
      --header:  #161616cc;
      --horus:   #a187287f;

      --accent-orange: #f57c00;
      --accent-softorange: #e4872ae0;
      --accent-green: #558b2f;
      --accent-red: #d84315;
      --accent-softred: #df5227cb;
      --accent-softborder: #4d4c4cb6;

      --card: #00001b63;
      --card-border: #f57c00;
      --input-border: #558b2f;
      --row-alt: #262626;

      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 10px 30px #00000066;
      --accent-glow: 0 0 0 2px #f57c0033, 0 10px 20px #f57c0022;

      --maxw: 1100px;
      --grad: linear-gradient(135deg, #1f1f1f70 0%, #1b1b1b70 40%, #15151570 100%);

      --tile-w: 300px;
      --tile-h: 300px;
      --rail-pad: 14px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-deep);
      scroll-behavior: smooth;
    }

    a { color: inherit; text-decoration: none; }
    img { display: block; max-width: 100%; }

    /* Background image */
    .bg {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: url('https://picantepequinsalsaco.com/images/bg.png') center/cover no-repeat;
      filter: blur(0px) saturate(1.05) brightness(.9);
      transform: translateZ(0) scale(1.02);
    }
    .bg::after { content: ""; position: absolute; inset: 0; background: none; }

    /* Sticky header */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: saturate(140%) blur(10px);
      background: var(--header);
      border-bottom: 1px solid #ffffff14;
    }
    .nav {
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 12px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .brand { display: flex; align-items: center; gap: 10px; letter-spacing: .3px; }
    .logo {
      width: 34px; height: 34px; border-radius: 10px;
      background-image: url('https://picantepequinsalsaco.com/images/bg.png');
      background-size: cover; background-position: center;
      box-shadow: var(--accent-glow);
    }
    .tag { color: var(--muted); font-size: .95rem; }
    nav ul { display: flex; gap: 10px; list-style: none; align-items: center; margin: 0; padding: 0; }

    /* AUTH GATE: hide main UI until script validates auth */
    .pps-auth-pending #modeSelector,
    .pps-auth-pending #posContainer,
    .pps-auth-pending #posGallery,
    .pps-auth-pending #posCart {
      display: none !important;
    }

    /* Overlay used when logged out, separate from layout */
    #authOverlay {
      position: fixed; inset: 0; z-index: 1000;
      background: #00000066;
      display: none;
    }
    #authOverlay.hidden { display: none !important; }

    /* 1px white outline around orange text */
    .outlined {
      color: #ffffffdc;
      -webkit-text-stroke: 1px #ffffff10;
      text-shadow:
        -1px -1px 0 #ffffff10,
         1px -1px 0 #ffffff10,
        -1px  1px 0 #ffffff10,
         1px  1px 0 #ffffff10;
    }

    .link { padding: 8px 12px; border-radius: 999px; color: var(--muted); border: 1px solid transparent; transition: .2s ease; }
    .link:hover { color: var(--ink); border-color: #ffffff22; background: #ffffff10; }

    .cta {
      background: #050f46a9; color: #c06a00b5; backdrop-filter: 6px;
      font-weight: 700; padding: 9px 14px; border-radius: 999px; box-shadow: var(--accent-glow);
    }
    .cta:hover { filter: brightness(.95); }
        
      input, select, textarea {
      font-size: 16px; /* prevents auto zoom on focus */
    }
    /* Hero grid */
    .hero {
      max-width: var(--maxw);
      margin: 36px auto 18px;
      padding: 0 18px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 24px;
    }
    .hero-card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 28px;
      box-shadow: var(--shadow);
    }
    .hero .hero-gallery { align-self: start; }

    .field-message { font-size: .9rem; margin-top: 4px; color: var(--muted); }

    .kicker { color: var(--accent-green); font-weight: 800; letter-spacing: .12em; text-transform: uppercase; font-size: .8rem; }
    h1 { font-size: clamp(1.9rem, 3.2vw, 3rem); line-height: 1.1; margin: .4rem 0 .8rem; }
    .sub { color: var(--muted); font-size: 1.05rem; }

    .badges { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
    .pill { padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: .8rem; color: #0d0a05; background: #3d8700ad; border: 1px solid #ffffff22; }
    .pill.alt { color: #0a0f08; background: #cf7c00d8; }

    .hero-actions { display: flex; align-items:center; flex-wrap: wrap; width: 100%; box-sizing: border-box; gap: 10px; }

    .btn {
      font-family: inherit; font-size: 1rem; font-weight: 600; letter-spacing: 0.3px;
      text-decoration: none; display: inline-block; cursor: pointer;
      padding: 11px 14px; border-radius: 12px; border: 1px solid #ffffff1f;
      background: #ffffff0f; color: var(--ink); backdrop-filter: blur(6px);
      transition: transform .15s ease, background .2s ease;
    }
    .btn:hover { transform: translateY(-1px); background: #ffffff1a; }
    .btn.primary {
      background: linear-gradient(540deg, #ffa600ef, var(--accent-orange));
      color: var(--dropdown); border: 1px solid var(--banner); box-shadow: var(--accent-glow); font-weight: 800;
    }
    .btn.primary:hover { background: var(--accent-glow); color: var(--accent-softorange); border: 1px solid var(--accent-softorange); box-shadow: var(--accent-glow); }
    .btn.rewards { background: var(--surface); color: var(--muted); border: 1px solid var(--accent-green); box-shadow: var(--card); font-weight: 800; }
    .btn.rewards:hover { background: var(--accent-green); color: var(--dropdown); border: 1px solid var(--card); box-shadow: var(--accent-green); }

    /* Menu section */
    .section { max-width: var(--maxw); margin: 20px auto; padding: 0 18px; }
    .card { background: var(--card); border: 1px solid var(--card-border); border-radius: var(--radius-sm); padding: 18px; box-shadow: var(--shadow); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

    .section h2 {
      font-size: 1.4rem; margin: 0 0 10px; text-align: center; font-weight: 700; letter-spacing: 0.5px;
      color: var(--accent-orange); text-transform: uppercase;
    }
     
   .rewards-row { display: inline-flex; align-items: center; flex-wrap: wrap; width: 100%; box-sizing: border-box; gap: 8px; padding: 8px 12px; border: 1px solid var(--accent-softborder); border-radius: var(--radius-sm); background: var(--surface); box-shadow: var(--accent-glow); flex: 0 0 auto;}

   .rewards-label { font-weight: 600; color: var(--muted); margin-right: 6px; flex: 0 0 auto;}

   .rewards-value { border-radius: 6px; color: var(--muted); font-weight: 700; flex: 0 0 auto; text-align: right; padding: 6px;}
      
   .rewards-box { flex: 0 0 auto; width: 120px; border-radius: 6px; padding: 8px; border: 1px solid var(--banner); background: var(--surface); color: var(--muted); font-weight: 700; text-align: right;}

   .rewards-input { flex: 0 0 auto; width: 100px; padding: 8px; border-radius: 6px; border: 1px solid var(--input-border); background: var(--banner); color: var(--ink); text-align: right;}

   .rewards-input:focus { outline: none; border-color: var(--accent-orange); box-shadow: 0 0 0 2px #f57c0033;}
      
   .apply-rewards { flex: 0 0 auto; padding: 8px 14px; margin-left: 8px; background: var(--accent-green); color: var(--dropdown); font-weight: 800;}
  
   .rewards-input:disabled { background: #333; color: var(--muted); cursor: not-allowed;}
      
   .apply-rewards:disabled { background: var(--muted); color: var(--muted); cursor: not-allowed;}

    /* Contact form styles */
    #contactForm { display: flex; flex-direction: column; align-items: stretch; }
    #submitBtn {
      margin: 12px auto 0; padding: 12px 24px; border: none; border-radius: var(--radius-sm);
      font-size: 1rem; font-weight: 600; cursor: not-allowed; background: var(--accent-orange); color: var(--ink);
      opacity: 0.6; transition: all 0.3s ease; max-width: 240px; width: auto; display: block;
    }
    #submitBtn.enabled {
      cursor: pointer; opacity: 1; background: linear-gradient(90deg, var(--accent-orange), var(--accent-green)); box-shadow: 0 4px 12px #00000040;
    }
    #contactForm input, #contactForm select {
      width: 100%; box-sizing: border-box; padding: 8px; margin: 6px 0; border-radius: 6px; border: 1px solid var(--input-border);
      background: #ffffff0d; color: var(--ink);
    }
    #contactForm input:focus, #contactForm select:focus { outline: none; border-color: var(--accent-orange); box-shadow: 0 0 0 2px #f57c0033; }
    #contactForm select.drop-down {
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      width: 100%; padding: 8px; margin: 6px 0; border-radius: 6px; border: 1px solid var(--input-border);
      background-color: var(--surface); color: var(--ink); font-size: 1rem; box-sizing: border-box; cursor: pointer;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' fill='%23f57c00' viewBox='0 0 24 24'><path d='M6 9l6 6 6-6'/></svg>");
      background-repeat: no-repeat; background-position: right 12px center; background-size: 16px;
    }
    #contactForm select.drop-down:focus { outline: none; border-color: var(--accent-orange); box-shadow: 0 0 0 2px #f57c0033; }
    #contactForm select.drop-down option { background-color: var(--dropdown); color: var(--ink); }
    #contactForm select.drop-down option.placeholder { background-color: var(--surface); color: var(--ink); }
    #contactForm select.drop-down option[value=""] { background-color: var(--dropdown); color: var(--muted); }

    /* Password strength meter */
    meter { width: 100%; height: 10px; border-radius: 6px; background: #333; }
    meter::-webkit-meter-bar { background: #333; border-radius: 6px; }
    meter::-webkit-meter-optimum-value { background: linear-gradient(90deg, red, orange, green); border-radius: 6px; transition: width 0.3s ease; }
    meter::-moz-meter-bar { background: linear-gradient(90deg, red, orange, green); border-radius: 6px; transition: width 0.3s ease; }

    /* Hide utility (sibling model: true collapse) */
    .hidden { display: none !important; }

    /* Stacking */
    #loginContainer, #contactForm { position: relative; }
    #loginContainer { z-index: 2; }
    #contactForm { z-index: 1; }

    #loginContainer { display: flex; flex-direction: column; align-items: stretch; }
    #loginContainer input {
      width: 100%; box-sizing: border-box; padding: 8px; margin: 6px 0; border-radius: 6px; border: 1px solid var(--input-border);
      background: #ffffff0d; color: var(--ink);
    }
    #loginContainer input:focus { outline: none; border-color: var(--accent-orange); box-shadow: 0 0 0 2px #f57c0033; }

    #loginBtn {
      margin: 12px auto 0; padding: 12px 24px; border: none; border-radius: var(--radius-sm);
      font-size: 1rem; font-weight: 600; cursor: not-allowed; background: var(--accent-orange); color: var(--ink);
      opacity: 0.6; transition: all 0.3s ease; max-width: 240px; width: auto; display: block;
    }
    #loginBtn.enabled { cursor: pointer; opacity: 1; background: linear-gradient(90deg, var(--accent-orange), var(--accent-green)); box-shadow: 0 4px 12px #00000040; }

    .btn-loading { position: relative; overflow: hidden; color: transparent; }
    .btn-loading::after {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.4) 50%, rgba(255,255,255,0) 100%);
      animation: shimmer 1.5s infinite;
    }
    .is-success { background: linear-gradient(90deg, #28a745, #218838); color: #fff !important; font-weight: bold; }
    .is-error { background: linear-gradient(90deg, #dc3545, #c82333); color: #fff !important; font-weight: bold; }

    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

    /* PPS: Mode selector and POS container */
    #modeSelector, #posContainer { position: relative; z-index: 2; }

    .vertical-gallery {
      max-width: var(--maxw); margin: 20px auto;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;
    }
    .prod-card {
      background: var(--card); border: 1px solid var(--surface); box-shadow: var(--accent-glow);
      border-radius: var(--radius-sm); padding: 16px; display: flex; flex-direction: column;
    }
    .prod-card img { border-radius: var(--radius-sm); margin-bottom: 12px; object-fit: cover; aspect-ratio: 1 / 1; }
    .prod-name { margin: 0 0 8px; font-size: 1.2rem; }
    .prod-price { margin: 0 0 12px; color: var(--muted); }
    .quantity { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .qty-btn { width: 32px; height: 32px; background: var(--surface); border: 1px solid var(--surface); border-radius: 6px; color: var(--muted); cursor: pointer; }
    .qty-btn:hover { background: var(--accent-glow); color: var(--ink); border: 1px solid var(--accent-orange); transform: translateY(-2%); }
    .qty-input { width: 56px; text-align: center; border: 1px solid var(--surface); border-radius: var(--radius-sm); background: #ffffff0d; color: var(--ink); }
    .add-to-cart { margin-top: auto; background: var(--surface); color: var(--muted); border: solid 1px var(--accent-orange); padding: 10px; border-radius: var(--radius-sm); font-weight: 700; cursor: pointer; }
    .add-to-cart:hover { background: var(--accent-glow); color: var(--ink); border: solid 1px var(--accent-orange); transform: translateY(-2%); }

    /* POS cart wrap */
      /* Ensure POS container fits viewport */
#posContainer {
  width: 100%;
  max-width: 100%;       /* never exceed screen width */
  box-sizing: border-box; /* include padding/border in width */
}
      /* Gallery grid baseline */
#posGallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 12px;
}

/* Product card baseline */
#posGallery .card {
  width: 100%;          /* card fills its grid cell */
  box-sizing: border-box;
}
    .pos-cart-wrap { margin-top: 16px; background: var(--card); border: 1px solid var(--accent-glow); border-radius: var(--radius-sm); padding: 14px; }
    #posCartItems { list-style: none; margin: 0; padding: 0; }
    #posCartItems li {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 8px; margin-bottom: 6px; background: var(--surface); border-radius: var(--radius-sm);
    }
    #posCartItems li:hover { background: var(--card); transform: translateY(-2%); }
    .cart-name { flex: 1; margin-right: 8px; color: var(--ink); }
    .cart-controls { display: flex; align-items: center; gap: 6px; }
    .cart-controls .qty-btn { width: 24px; height: 24px; }
    .cart-controls .qty-display { min-width: 24px; text-align: center; }
    .remove-btn { background: var(--surface); color: var(--ink); border: 1px solid var(--accent-red); border-radius: 6px; padding: 4px 8px; cursor: pointer; }
    .remove-btn:hover { background: var(--accent-softred); color: var(--card); border: 1px solid var(--accent-red); border-radius: 6px; padding: 4px 8px; cursor: pointer; }
    /* --- Responsive tweaks for POS cart --- */
@media (max-width: 768px) {    
      #posContainer {
    padding: 8px;
  }
      #posGallery {
    grid-template-columns: repeat(2, 1fr); /* 2 cards per row on tablets */
  }

  .hero-actions {
    flex-direction: column;
    align-items: stretch;
  }

  .rewards-row {
    flex-direction: column;
    align-items: stretch;
  }

  .rewards-box,
  .rewards-input {
    width: 100%; /* full width fields on mobile */
  }
  .apply-rewards {
    width: auto;             /* shrink to content */
    align-self: center;      /* center horizontally under input */
    margin-left: 0;          /* remove desktop margin */
    margin-top: 6px;         /* add a little breathing room */
  }
    
  .pos-cart-wrap {
    padding: 10px;
    margin-top: 12px;
  }

  #posCartItems li {
    flex-direction: column;       /* stack name + controls vertically */
    align-items: flex-start;
    gap: 6px;
  }

  .cart-name {
    margin-right: 0;
    width: 100%;
  }

  .cart-controls {
    width: 100%;
    justify-content: space-between;
  }

  .cart-controls .qty-btn,
  .cart-controls .qty-display {
    flex: 0 0 auto;
  }

  .remove-btn {
    width: 100%;                  /* full width remove button */
    text-align: center;
  }
}

@media (max-width: 480px) {
  #rewardsModal .contact-row {
    flex-direction: column;   /* stack label + input + message vertically */
    align-items: stretch;
  }

  #rewardsModal .contact-row span {
    flex: 0 0 auto !important;           /* cancel the fixed 120px width */
    width: 100% !important;              /* let label fit content */
    margin-bottom: 4px;       /* small spacing before input */
  }

  #rewardsModal .contact-row input {
    width: 100%;              /* input fills modal width */
  }

  #rewardsModal .field-message {
    margin-top: 4px;          /* stays right under input */
  }
    
  #posContainer {
    padding: 8px;
  }
    
  #posGallery {
    grid-template-columns: 1fr; /* 1 card per row on phones */
  }

  .hero-actions {
    flex-direction: column;
    align-items: stretch;
  }

  .rewards-row {
    flex-direction: column;
    align-items: stretch;
  }

  .rewards-box,
  .rewards-input {
    width: 100%; /* full width fields on mobile */
  }
    
  .apply-rewards {
    width: auto;             /* shrink to content */
    align-self: center;      /* center horizontally under input */
    margin-left: 0;          /* remove desktop margin */
    margin-top: 6px;         /* add a little breathing room */
  }

  .pos-cart-wrap {
    padding: 8px;
  }

  #posCartItems li {
    padding: 4px 6px;
    margin-bottom: 4px;
  }

  .cart-name {
    font-size: 0.9rem;
  }

  .cart-controls .qty-btn {
    width: 20px;
    height: 20px;
  }

  .cart-controls .qty-display {
    min-width: 20px;
    font-size: 0.85rem;
  }

  .remove-btn {
    font-size: 0.85rem;
    padding: 3px 6px;
  }
}
    /* Consent checkbox */
    .consent-inline { display: inline-flex; align-items: center; gap: 6px; font-size: 0.95rem; line-height: 1.4; color: var(--ink, #fff); cursor: pointer; user-select: none; white-space: nowrap; padding: 0; flex: 0 0 auto; width: auto; }
    .consent-inline input[type="checkbox"] {
      width: 18px; height: 18px; margin: 0; padding: 0; border: 2px solid var(--accent-orange, #ff6a00);
      background-color: transparent; transition: background-color 0.2s ease; appearance: none; cursor: pointer; position: relative; box-sizing: border-box; flex: 0 0 18px; display: inline-block; vertical-align: middle;
    }
    .consent-inline input[type="checkbox"]:checked { background-color: var(--accent-orange, #ff6a00); }
    .consent-inline input[type="checkbox"]:checked::after {
      content: 'âœ“'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 14px; color: white; font-weight: bold; line-height: 1; pointer-events: none;
    }
    .consent-text { flex: 1 1 auto; color: var(--muted, #ccc); }
    .consent-optional { color: var(--muted, #888); font-size: 0.88rem; margin-left: 4px; }

    @media (max-width: 600px) {
      .consent-inline { white-space: normal; flex-wrap: wrap; align-items: flex-start; }
      .consent-inline input[type="checkbox"] { width: 17px; height: 17px; flex: 0 0 17px; }
    }

    /* Table styles */
    .table-wrap { overflow: auto; border-radius: 12px; border: 1px solid var(--input-border); background: #1a1a1acc; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 520px; }
    thead { background: linear-gradient(90deg, var(--accent-red), var(--accent-green)); }
    thead th { color: #fff; font-weight: 600; padding: .8em 1em; text-align: left; }
    tbody td { padding: .8em 1em; border-top: 1px solid var(--card-border); color: var(--ink); }
    tbody tr:nth-child(even) { background: var(--row-alt); }
    .info-grid { display: grid; grid-template-columns: 1.2fr .8fr; gap: 16px; margin-top: 12px; }
    .list { margin: 0; padding-left: 1.2em; }
    .list li { margin: .4em 0; }
    .order-cta { display: flex; align-items: center; justify-content: center; }
    .order-cta a { background-color: var(--accent-orange); color: #fff; padding: .9em 1.4em; border-radius: 10px; font-weight: 800; text-align: center; box-shadow: var(--accent-glow); }
    .small { font-size: .9rem; color: var(--muted); margin-top: 10px; }

    /* Highlights gallery */
    .gallery-wrap {
      position: relative; overflow: hidden; border-radius: var(--radius); border: 1px solid var(--card-border);
      background: #1e1e1e60; box-shadow: var(--shadow);
      width: calc(var(--tile-w) + 2 * var(--rail-pad)); height: calc(var(--tile-h) + 2 * var(--rail-pad)); max-width: 100%; margin: 0 auto;
    }
    .rail { display: flex; gap: 12px; padding: var(--rail-pad); overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; -ms-overflow-style: none; }
    .rail::-webkit-scrollbar { display: none; }
    .tile { flex: 0 0 auto; width: var(--tile-w); height: var(--tile-h); position: relative; border-radius: 12px; overflow: hidden; scroll-snap-align: center; border: 1px solid #ffffff1a; background: #141414; }
    .tile img { width: 100%; height: 100%; object-fit: cover; opacity: .95; transition: .25s; }
    .tile:hover img { transform: scale(1.03); opacity: 1; }
    .tile .label { position: absolute; left: 10px; bottom: 10px; padding: 6px 10px; border-radius: 999px; background: #161616cc; border: 1px solid #ffffff22; color: #fff; font-size: .8rem; }
    .gallery-controls { position: absolute; inset: auto 10px 10px auto; display: flex; gap: 8px; z-index: 2; }
    .ctrl { width: 36px; height: 36px; display: grid; place-items: center; border-radius: 10px; background: #161616cc; border: 1px solid #ffffff2a; color: #fff; cursor: pointer; }
    .ctrl:hover { background: #161616e0; }

    /* Footer */
    footer { margin: 40px 0 28px; color: var(--muted); text-align: center; font-size: .9rem; }
    .links { display: flex; gap: 14px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
    .links a { color: var(--accent-orange); font-weight: 700; }

    /* Responsive */
    @media (max-width: 960px) {
      .hero { grid-template-columns: 1fr; }
      .info-grid { grid-template-columns: 1fr; }
      .gallery-wrap {
        width: calc(var(--tile-w) + 2 * var(--rail-pad));
        height: calc(var(--tile-h) + 2 * var(--rail-pad));
        margin: 0 auto;
      }
    }
    @media (max-width: 640px) {
      .nav { flex-direction: column; align-items: stretch; text-align: center; }
      .brand { flex-wrap: wrap; justify-content: center; gap: 6px; margin-bottom: 6px; }
      nav ul { flex-wrap: wrap; justify-content: center; gap: 8px; }
      nav ul li { display: flex; justify-content: center; }
      nav a { width: 100%; text-align: center; }
    }

    /* Contact modal (Rewards Lookup) */
    .contact-popup { position: fixed; inset: 0; z-index: 1000; }
    .contact-hidden { display: none; }
    .contact-overlay { position: absolute; inset: 0; background:var(--card); backdrop-filter: blur(2px); }
    .contact-card {
      position: relative; margin: 0 auto; top: 50%; transform: translateY(-50%); max-width: 520px; width: calc(100% - 32px);
      background: var(--card); border: 1px solid var(--card-border); border-radius: var(--radius); color: var(--ink); padding: 20px 22px;
    }
    .contact-row { display: flex; align-items: center; justify-content: space-between; background: var(--card); gap: 10px; margin: 10px 0 8px; flex-wrap: nowrap; }
    .contact-card input[type="text"], .contact-card input[type="email"], .contact-card input[type="tel"] {
      flex: 1; padding: 8px 10px; border-radius: var(--radius-sm); border: 1px solid var(--accent-softborder);
      background: var(--card); box-shadow: var(--accent-green); color: var(--ink); font-size: 0.95rem; transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .contact-card input:focus { outline: none; border-color: var(--accent-green); box-shadow: 0 0 0 2px #558b2f55; }
    .contact-card input:hover { background: var(--surface) !important; box-shadow: var(--accent-green); border-color: var(--surface); box-shadow: 0 0 0 2px #558b2f55; }
    .contact-card input::placeholder { color: var(--muted); opacity: 0.8; }
    .contact-email { flex: 1; color: #fff; font-weight: 700; word-break: break-all; border-bottom: 1px dashed #ffffff22; }
    .contact-copy { margin-left: 12px; flex-shrink: 0; padding: 6px 10px; border-radius: 10px; border: 1px solid var(--surface); background: #ffffff10; color: var(--muted); cursor: pointer; transition: background .2s ease, transform .15s ease; }
    .contact-copy:hover { background: #ffffff1a; transform: translateY(-1px); }
    .contact-actions { margin-top: 12px; display: flex; justify-content: flex-end; }

    .contact-toast { margin-top: 10px; background: #333; color: #fff; padding: 8px 12px; border-radius: 10px; opacity: 0; transition: opacity .25s ease; pointer-events: none; }
    .contact-toast.show { opacity: 1; }
    .body-lock { overflow: hidden; }
    .contact-card button {
      width: 100%; padding: 10px 14px; border-radius: var(--radius-sm); border: 1px solid var(--accent-softborder) !important;
      background: var(--card); box-shadow: none !important; color: var(--ink); font-weight: 700; cursor: pointer;
      transition: background 0.5s ease, color 0.5s ease, transform 0.25s ease;
    }
    .contact-card button:hover { background: var(--accent-green); color: var(--dropdown); transform: translateY(-1px); }
    .contact-card button:disabled { opacity: 0.6; cursor: not-allowed; background: var(--muted); border-color: var(--muted); }
    .contact-card button.is-success { background: var(--accent-green); color: #fff; }
    .contact-card button.is-error { background: var(--accent-red); color: #fff; }
    .contact-header { display: flex; justify-content: flex-end; margin-bottom: 6px; }
    .close-modal-btn {
      width: 100%; padding: 10px 14px; border-radius: var(--radius-sm); border: 1px solid var(--surface);
      background: var(--card); color: var(--muted); font-weight: 700; cursor: pointer; transition: background 0.5s ease, color 0.5s ease, transform 0.25s ease;
    }
    .close-modal-btn:hover { background: var(--accent-softred) !important; color: var(--dropdown); transform: scale(1.1); }
    @media (max-width: 420px) { .contact-card { padding: 18px; } .contact-email { font-size: .95rem; } }
    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }

    /* Checkout modal specifics */
.tender {
  display: inline-flex;
  gap: 12px;
  padding: 8px 0 12px;
  border-bottom: 1px solid var(--accent-softborder);
  margin-bottom: 12px;
}
.tender-option {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 700;
  color: var(--muted);
  cursor: pointer;
  user-select: none;
}
.tender-option input[type="radio"] {
  appearance: none;
  width: 16px; height: 16px;
  border: 2px solid var(--accent-orange);
  border-radius: 50%;
  position: relative;
  cursor: pointer;
  background: transparent;
}
.tender-option input[type="radio"]:checked::after {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--accent-orange);
  transform: translate(-50%, -50%);
}

/* Cart replica list/rows */
.replica {
  border: 1px solid var(--accent-softborder);
  border-radius: var(--radius-sm);
  background: var(--surface);
  padding: 10px;
  box-shadow: var(--shadow);
}
.replica .line {
  display: flex;
  justify-content: space-between;
  padding: 6px 4px;
  border-bottom: 1px solid #ffffff12;
}
.replica .line:last-child { border-bottom: none; }
.replica .line.total {
  font-weight: 800;
  color: var(--accent-orange);
  border-top: 1px solid var(--accent-softborder);
}

/* Cash controls */
.cash-controls { margin-top: 12px; }
.cash-label { display: block; font-weight: 600; color: var(--muted); margin-bottom: 6px; }
.cash-input {
  width: 100%;
  padding: 8px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--input-border);
  background: var(--banner);
  color: var(--ink);
  text-align: right;
}
.cash-input:focus { outline: none; border-color: var(--accent-orange); box-shadow: 0 0 0 2px #f57c0033; }
.change-row {
  display: flex; justify-content: space-between;
  margin-top: 6px; padding-top: 6px;
  border-top: 1px dashed var(--accent-softborder);
}

/* Status text */
.status {
  margin-top: 10px;
  color: var(--muted);
  min-height: 20px;
}

        /*  [WatchDog Patch B] Optional global toast style */
    #globalToast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px; z-index: 2000; }

    /* HORUS */
.horus {
  position:relative;
  display: inline-block;
  margin-left: 12px;
  width: 30px;   /* adjust as needed */
  height: auto;
  cursor: pointer;
}
/* Tooltip styling */
.tooltip {
  visibility: hidden;
  opacity: 0;
  position: absolute;
  bottom: 100%;       /* below the icon */
  left: 50%;
  transform: translateX(-50%) translateY(135%);
  background-color: var(--header);
  color: var(--muted);
  text-align: center;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  white-space: normal;
  max-width: 220px;
  width: max-content;
  word-wrap: break-word;
  line-height: 1.0;
  transition: opacity 0.2s;
  pointer-events: none; /* prevents blocking clicks */
}

/* Tooltip arrow */
.tooltip::after {
  content: "";
  position: absolute;
  bottom: 100%; /* top of tooltip */
  left: 50%;
  transform: translateX(-50%) translateY(-25%);
  border-width: 5px;
  border-style: solid;
  border-color: #333 transparent transparent transparent;
}
.tooltip-title {
  font-weight: bold;
  font-size: 13px;
  margin-bottom: 2px;
}

.tooltip-subtitle {
  font-style: italic;
  font-size: 11px;
  margin-bottom: 8px;
}

.tooltip-body {
  font-style: italic;
  font-size: 10px;
  margin: 0;
}


.btnrtn .tooltip,
.btnlog .tooltip,
.btnjoin .tooltip {
  transform: translateX(-50%) translateY(250%) !important; /* increase from 135% to 160% */
}
/* Show tooltip on hover or tap */
.btnrtn:hover .tooltip,
.btnlog:hover .tooltip,
.btnjoin:hover .tooltip,
.btnrtn:focus .tooltip,
.btnlog:focus .tooltip,
.btnjoin:focus .tooltip,
.horus:hover .tooltip,
.horus:focus .tooltip {
  visibility: visible;
  opacity: 1;
}



/* Outline styling */
.head-outline {
  fill: none;       /* gold fill for the eagle outline */
  stroke: var(--horus); /*#aa8e27d6; default color*/
  stroke-width: 10;     
}


/* Eye base class */
.eye {
  transition: fill 160ms ease;
  animation: none; /* no animation by default */
}

/* Eye state colors */
.eye--idle  { fill: #053f107e; }
.eye--ok    { fill: #00D4557e; }
.eye--warn  { fill: #ffd7237e; }
.eye--error { fill: #ef44447e; }
.eye--off   { fill: #6b7280; opacity: 0.6; }

/* Flash animations */
@keyframes horusFlashFast {
  0%, 100% { opacity: 1; }
  50%      { opacity: 0.3; }
}

@keyframes horusFlashSlow {
  0%, 100% { opacity: 1; }
  50%      { opacity: 0.3; }
}

@keyframes horusFlash {
  0%, 100% { opacity: 1; }
  50%      { opacity: 0.3; }
}

/* Apply based on data-rate */
.eye--flash[data-rate="fast"] { animation: horusFlashFast 600ms infinite; }
.eye--flash[data-rate="slow"] { animation: horusFlashSlow 2400ms infinite; }
.eye--flash:not([data-rate])  { animation: horusFlash 1200ms infinite; }
    
  .back-arrow,
  .logout-icon,
  .join-icon {
  stroke: #ffffff6b;
  fill: #ffffff0f;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.btnrtn,
.btnlog,
.btnjoin {
  position: relative;
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
}
.btnrtn svg,
.btnlog svg,
.btnjoin svg {
  display: block;
  width: 24px;
  height: 24px;
  transition: transform .15s ease;
}
.btnrtn:hover svg,
.btnlog:hover svg,
.btnjoin:hover svg {
  transform: translateY(-1px);
}

.btnrtn.hidden,
.btnlog.hidden, 
.btnjoin.hidden {
  display: none;
}

	  /* ============================
   Phase 3 Success Modal
   ============================ */

.pps-success-modal {
  position: fixed;
  inset: 0;
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pps-success-overlay {
  position: absolute;
  inset: 0;
  background: #00000088;
  backdrop-filter: blur(6px);
}

.pps-success-card {
  position: relative;
  z-index: 10;
  width: min(420px, 90%);
  padding: 28px 24px;
  border-radius: var(--radius);
  background: var(--card);
  border: 1px solid var(--accent-orange);
  box-shadow: var(--accent-glow), var(--shadow);
  animation: ppsSuccessPop 0.25s ease-out;
}

@keyframes ppsSuccessPop {
  0% { transform: scale(0.92); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

.pps-success-title {
  margin: 0 0 12px;
  text-align: center;
  color: var(--accent-orange);
  font-size: 1.4rem;
  font-weight: 800;
  letter-spacing: 0.5px;
}

.pps-success-body {
  margin-top: 10px;
  color: var(--ink);
  font-size: 1rem;
  line-height: 1.4;
  text-align: center;
}

.pps-success-line {
  margin: 6px 0;
}

.pps-success-actions {
  margin-top: 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.pps-success-btn {
  width: 100%;
  font-weight: 700;
}

.pps-dismiss-btn {
  width: 100%;
  background: var(--surface);
  border: 1px solid var(--accent-softborder);
  color: var(--ink);
}

.pps-dismiss-btn:hover {
  background: var(--accent-softorange);
  color: var(--dropdown);
}

	  .pps-points-badge {
  margin: 14px auto 0;
  padding: 10px 18px;
  border-radius: 999px;
  background: var(--accent-orange);
  color: var(--dropdown);
  font-weight: 800;
  font-size: 1.1rem;
  letter-spacing: 0.5px;
  box-shadow: var(--accent-glow);
  width: fit-content;
  animation: ppsPointsPop 0.3s ease-out;
}

@keyframes ppsPointsPop {
  0% { transform: scale(0.7); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}
	  
  </style>
</head>
<body>

  <div class="bg" aria-hidden="true"></div>

  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <strong>Picante Pequin Salsa Co</strong>
      </div>
      <nav aria-label="Primary">
        <ul>
          <li>
            <button id="returnFromJoinBtn" class="btnrtn hidden" aria-label="Back">
              <svg xmlns="http://www.w3.org/2000/svg"
                   viewBox="0 0 45.58 45.58"
                   width="24" height="24">
                 <path d="M45.506,33.532c-1.741-7.42-7.161-17.758-23.554-19.942V7.047c0-1.364-0.826-2.593-2.087-3.113
                   c-1.261-0.521-2.712-0.229-3.675,0.737L1.305,19.63c-1.739,1.748-1.74,4.572-0.001,6.32L16.19,40.909
                   c0.961,0.966,2.415,1.258,3.676,0.737c1.261-0.521,2.087-1.75,2.087-3.113v-6.331c5.593,0.007,13.656,0.743,19.392,4.313
                   c0.953,0.594,2.168,0.555,3.08-0.101C45.335,35.762,45.763,34.624,45.506,33.532z"
                   class="back-arrow" />
              </svg>
			 <span class="tooltip">
              <div class="tooltip-title">Back</div>
             </span> 
            </button>
          </li>     
          <li>
            <button id="chooseJoinBtn" class="btnjoin hidden" aria-label="Join Rewards">
              <svg xmlns="http://www.w3.org/2000/svg"
                   viewBox="0 0 45.902 45.902"
                   width="24" height="24">
                <path d="M43.162,26.681c-1.564-1.578-3.631-2.539-5.825-2.742c1.894-1.704,3.089-4.164,3.089-6.912
						c0-5.141-4.166-9.307-9.308-9.307c-4.911,0-8.932,3.804-9.281,8.625c4.369,1.89,7.435,6.244,7.435,11.299
						c0,1.846-0.42,3.65-1.201,5.287c1.125,0.588,2.162,1.348,3.066,2.26c2.318,2.334,3.635,5.561,3.61,8.851l-0.002,0.067
						l-0.002,0.057l-0.082,1.557h11.149l0.092-12.33C45.921,30.878,44.936,28.466,43.162,26.681z" 
							class="join-icon"/>
				<path d="M23.184,34.558c1.893-1.703,3.092-4.164,3.092-6.912c0-5.142-4.168-9.309-9.309-9.309c-5.142,0-9.309,4.167-9.309,9.309
						c0,2.743,1.194,5.202,3.084,6.906c-4.84,0.375-8.663,4.383-8.698,9.318l-0.092,1.853h14.153h15.553l0.092-1.714
						c0.018-2.514-0.968-4.926-2.741-6.711C27.443,35.719,25.377,34.761,23.184,34.558z" 
					        class="join-icon"/>
				<path d="M6.004,11.374v3.458c0,1.432,1.164,2.595,2.597,2.595c1.435,0,2.597-1.163,2.597-2.595v-3.458h3.454
						c1.433,0,2.596-1.164,2.596-2.597c0-1.432-1.163-2.596-2.596-2.596h-3.454V2.774c0-1.433-1.162-2.595-2.597-2.595
						c-1.433,0-2.597,1.162-2.597,2.595V6.18H2.596C1.161,6.18,0,7.344,0,8.776c0,1.433,1.161,2.597,2.596,2.597H6.004z"
                      	    class="join-icon" />
              </svg>
			  <span class="tooltip">
              <div class="tooltip-title">Join Rewards</div>
             </span> 
            </button>
          </li>
          <li>
            <button id="chooseLogOutBtn" class="btnlog hidden" aria-label="Logout">
              <svg xmlns="http://www.w3.org/2000/svg"
                   viewBox="0 0 24 24"
                   width="24" height="24"> 
                <path d="M10.138 1.815A3 3 0 0 1 14 4.688v14.624a3 3 0 0 1-3.862 2.873l-6-1.8A3 3 0 0 1 2 17.512V6.488a3 3 0 0 1 2.138-2.873l6-1.8zM15 4a1 1 0 0 1 1-1h3a3 3 0 0 1 3 3v1a1 1 0 1 1-2 0V6a1 1 0 0 0-1-1h-3a1 1 0 0 1-1-1zm6 12a1 1 0 0 1 1 1v1a3 3 0 0 1-3 3h-3a1 1 0 1 1 0-2h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1zM9 11a1 1 0 1 0 0 2h.001a1 1 0 1 0 0-2H9z"
                      class="logout-icon" />
                <path d="M16 12h5m0 0-2-2m2 2-2 2"
                  class="logout-icon" />
              </svg>
			  <span class="tooltip">
              <div class="tooltip-title">LogOut</div>
             </span> 
            </button>
          </li>          
          <li><a class="link" href="https://picantepequinsalsaco.com/PrivacyPolicy">Privacy</a></li>
          <div class="horus">
            <svg viewBox="0 0 558 603" xmlns="http://www.w3.org/2000/svg">
              <g id="Horus">
                <g id="HorusEyes">
                  <path id="LeftEye" d="m -154.61678,-102.63518 c 0,0 -2.77704,10.939524 -47.95742,-3.69449 -13.92672,-4.51089 -24.06791,-30.811 -11.9513,-52.71461 16.49488,16.07794 62.657,46.75559 59.90872,56.4091"
                    transform="matrix(-0.09071252,-0.99587712,-0.99997224,-0.00745048,0,0)" class="eye eye--idle" />
                  <path id="RightEye" d="m 441.25001,154.05099 c -9.40394,-2.66502 -49.31527,43.2601 -65.25191,62.17153 20.80388,11.90346 51.43309,-0.4814 57.20718,-14.38431 18.73204,-45.10313 8.04473,-47.78722 8.04473,-47.78722" class="eye eye--idle" />
                </g>
               <path id="HorusOutline" d="M 244.264,4.023 C 202.208,7.325 161.52,16.643 128.198,30.604 106.508,39.691 67,61.889 67,64.988 c 0,0.577 3.757,5.32 8.348,10.541 l 8.348,9.493 -5.904,17.239 C 70.913,122.348 62.66,152.574 57.657,176 c -5.675,26.58 -19.15,93.13 -25.207,124.5 -3.079,15.95 -7.816,40.206 -10.525,53.903 -2.709,13.696 -4.918,25.621 -4.91,26.5 0.02,2.103 25.19,30.427 40.44,45.508 38.754,38.322 76.09,65.154 177.545,127.591 14.025,8.632 29.645,18.271 34.711,21.421 l 9.212,5.726 4.288,-2.93 c 2.359,-1.612 12.614,-8.015 22.789,-14.229 76.636,-46.804 109.531,-68.112 137.5,-89.067 20.074,-15.039 35.225,-27.973 53.946,-46.053 14.876,-14.365 41.548,-43.718 42.89,-47.201 C 541.124,379.624 529.781,321.262 506.969,210 495.331,153.234 486.058,118.147 475.814,92.104 l -2.909,-7.395 2.797,-3.103 c 1.539,-1.706 5.697,-6.186 9.24,-9.955 l 6.441,-6.853 -2.441,-1.855 C 482.811,58.287 460.162,45.422 447,39.12 397.148,15.252 347.325,4.506 282,3.535 267.425,3.318 250.444,3.538 244.264,4.023 M 254,23.652 c -1.925,0.183 -9.35,0.829 -16.5,1.435 -31.152,2.642 -61.52,9.93 -93.87,22.528 -17.947,6.99 -43.981,20.228 -42.798,21.762 C 115.533,88.433 146.659,132 145.573,132 144.959,132 103.97,108.042 100.846,105.857 99.386,104.835 97.96,104 97.678,104 95.2,104 75.25,184.583 77.235,186.569 c 0.207,0.207 4.245,-7.374 8.972,-16.847 8.576,-17.184 14.338,-25.428 19.658,-28.126 7.814,-3.963 18.777,-2.353 27.156,3.987 2.847,2.155 11.397,11.342 19,20.417 17.282,20.627 18.525,21.977 29.251,31.753 5.563,5.071 11.55,9.406 16.367,11.85 7.057,3.582 8.312,3.882 17.733,4.23 5.893,0.219 11.969,-0.117 14.509,-0.801 l 4.371,-1.177 -2.971,-3.177 c -5.751,-6.151 -26.582,-36.594 -25.7,-37.559 0.191,-0.21 5.651,3.39 12.133,8 34.076,24.232 50.198,32.881 61.292,32.881 10.075,0 27.256,-8.904 55.494,-28.761 9.35,-6.574 17.185,-11.796 17.41,-11.603 0.711,0.609 -16.617,25.992 -22.388,32.794 -3.037,3.581 -5.522,6.727 -5.522,6.993 0,1.291 8.492,2.566 17.116,2.571 8.998,0.006 10.057,-0.217 16.5,-3.474 3.786,-1.914 9.841,-5.714 13.454,-8.445 8.167,-6.171 23.873,-22.42 34.408,-35.597 15.348,-19.194 21.53,-24.429 31.34,-26.532 8.299,-1.78 14.374,0.115 20.724,6.466 4.049,4.049 7.103,9.046 14.727,24.098 10.378,20.489 10.502,20.508 6.599,0.99 -4.522,-22.616 -16.287,-64.319 -18.875,-66.907 -0.622,-0.622 -1.774,-0.231 -3.23,1.096 -2.227,2.03 -22.8,14.458 -36.004,21.75 -3.708,2.048 -6.997,4.137 -7.309,4.642 -0.312,0.505 -1.005,0.919 -1.539,0.919 -0.93,0 6.501,-11.649 12.12,-19 1.472,-1.925 5.104,-6.86 8.072,-10.967 2.968,-4.106 9.81,-13.319 15.203,-20.472 C 458.714,67.431 459.391,70.002 441.5,60.512 395.258,35.983 335.264,22.607 274,23.169 c -9.075,0.083 -18.075,0.301 -20,0.483 M 116.658,154.744 c -0.74,1.197 2.08,23.009 3.777,29.211 3.874,14.162 13.143,26.679 23.639,31.924 9.799,4.897 20.062,5.078 30.69,0.542 l 3.736,-1.595 -2.5,-1.645 c -5.623,-3.699 -15.899,-14.499 -26.815,-28.181 -6.362,-7.975 -14.315,-17.2 -17.673,-20.5 -6.197,-6.092 -13.965,-11.194 -14.854,-9.756 m 318.444,2.893 c -7.211,4.722 -14.686,12.377 -26.335,26.966 -5.315,6.657 -13.962,16.172 -19.216,21.143 -5.253,4.972 -9.551,9.277 -9.551,9.567 0,1.614 11.298,4.159 18.521,4.172 7.051,0.013 8.822,-0.379 14.646,-3.247 11.1,-5.464 19.569,-15.791 24.217,-29.531 3.191,-9.433 5.957,-32.798 3.866,-32.656 -0.413,0.027 -3.179,1.641 -6.148,3.586 M 91.32,195.272 C 73.555,219.4 62.088,248.704 54.645,289 c -3.574,19.35 -4.914,28.065 -4.393,28.585 0.249,0.25 3.619,-4.392 7.487,-10.315 8.331,-12.756 20.267,-29.107 20.247,-27.737 -0.008,0.532 -1.824,7.042 -4.037,14.467 -9.331,31.316 -13.202,44.796 -18.92,65.893 l -6.045,22.303 5.094,6.402 c 2.802,3.521 5.393,6.395 5.758,6.385 0.365,-0.009 2.17,-2.821 4.011,-6.25 4.354,-8.108 35.293,-54.927 35.897,-54.322 0.509,0.508 -14.756,46.872 -20.9,63.48 -2.114,5.715 -3.844,11.201 -3.844,12.19 0,0.989 4.332,6.013 9.628,11.164 l 9.627,9.365 3.707,-7.055 c 2.039,-3.88 7.896,-15.155 13.016,-25.055 9.641,-18.643 11.576,-21.837 10.602,-17.5 -0.309,1.375 -0.983,5.2 -1.498,8.5 -1.561,10.011 -9.094,51.914 -9.571,53.249 -0.255,0.711 5.021,5.353 12.271,10.796 l 12.718,9.547 10.5,-31.796 c 8.265,-25.028 10.574,-31.051 10.847,-28.296 0.347,3.504 -1.349,47.509 -2.488,64.56 l -0.605,9.059 14.242,9.238 c 7.833,5.081 14.472,9.008 14.753,8.728 0.519,-0.52 1.26,-4.566 7.792,-42.585 3.805,-22.145 5.459,-27.58 5.459,-17.94 0,9.329 5.404,71.915 6.254,72.431 0.135,0.082 3.171,1.957 6.746,4.167 3.575,2.21 13.475,8.222 22,13.36 8.525,5.137 16.975,10.448 18.777,11.801 1.803,1.353 3.503,2.235 3.778,1.959 1.104,-1.104 -3.879,-36.179 -9.133,-64.278 -7.441,-39.803 -17.682,-73.195 -29.87,-97.397 -5.759,-11.436 -15.098,-24.417 -22.892,-31.821 -11.573,-10.993 -23.01,-15.535 -39.054,-15.509 -8.868,0.014 -18.837,2.123 -24.887,5.264 -2.079,1.08 -4.156,1.963 -4.616,1.963 -1.165,0 1.528,-11.131 4.407,-18.218 3.953,-9.727 10.358,-17.476 30.036,-36.335 C 173.561,266.099 189.392,249 187.589,249 c -0.297,0 -4.939,2.845 -10.315,6.322 -20.552,13.293 -33.877,17.823 -46.146,15.687 -16.272,-2.834 -27.182,-14.291 -32.236,-33.855 -2.642,-10.222 -3.529,-28.568 -1.944,-40.166 0.686,-5.02 1.063,-9.31 0.838,-9.535 -0.224,-0.224 -3.134,3.294 -6.466,7.819 m 370.159,12.978 c -0.016,16.03 -0.383,21.604 -1.76,26.75 -2.73,10.202 -8.017,20.008 -13.931,25.839 -7.269,7.167 -12.486,9.543 -21.949,9.997 -14.064,0.675 -23.886,-2.675 -41.004,-13.986 -6.63,-4.38 -12.23,-7.788 -12.446,-7.573 -1.015,1.016 16.973,20.789 31.454,34.574 17.389,16.553 24.02,24.807 28.192,35.09 2.958,7.293 5.48,16.878 4.656,17.701 -0.294,0.294 -3.382,-0.802 -6.863,-2.436 -8.551,-4.015 -15.753,-5.547 -25.317,-5.384 -15.023,0.254 -26.178,4.912 -37.37,15.604 -22.13,21.141 -42.702,72.545 -52.653,131.574 -3.565,21.145 -9.449,61.372 -9.037,61.784 0.315,0.316 10.995,-6.142 37.382,-22.603 6.234,-3.888 11.808,-7.228 12.388,-7.421 0.58,-0.194 1.419,-3.031 1.865,-6.306 1.893,-13.891 6.914,-60.649 6.914,-64.385 0,-2.238 0.337,-4.068 0.75,-4.068 0.767,0.002 2.759,10.216 8.425,43.211 l 3.213,18.711 3.556,-2.174 c 17.972,-10.992 25.934,-16.785 25.582,-18.614 -0.758,-3.937 -2.673,-56.914 -2.355,-65.158 l 0.329,-8.522 9.946,30.522 c 5.471,16.788 10.06,30.687 10.199,30.888 0.139,0.201 5.529,-3.399 11.979,-8 6.449,-4.601 12.127,-8.635 12.617,-8.965 0.502,-0.337 0,-5.37 -1.145,-11.5 -1.12,-5.995 -3.418,-19 -5.107,-28.9 -1.689,-9.9 -3.442,-19.913 -3.895,-22.25 -0.454,-2.337 -0.693,-4.25 -0.532,-4.25 0.162,0 6.289,11.695 13.616,25.989 7.327,14.294 13.588,25.994 13.913,26 0.325,0.006 4.972,-4.152 10.327,-9.239 l 9.736,-9.25 -4.565,-12.5 c -2.51,-6.875 -7.746,-22.4 -11.636,-34.5 -8.88,-27.622 -9.887,-30.9 -9.586,-31.2 0.133,-0.134 1.96,2.332 4.06,5.478 8.184,12.268 30.074,45.995 33.113,51.02 l 3.205,5.299 5.627,-6.219 c 3.096,-3.42 5.628,-6.742 5.628,-7.382 0,-0.64 -2.226,-8.776 -4.947,-18.08 -11.459,-39.182 -15.446,-52.819 -20.123,-68.827 -2.717,-9.302 -4.809,-17.044 -4.647,-17.205 0.161,-0.161 6.576,9.121 14.255,20.627 8.564,12.832 14.076,20.234 14.256,19.146 0.485,-2.922 -5.638,-35.673 -9.377,-50.157 -6.522,-25.262 -16.377,-47.748 -30.444,-69.463 -3.398,-5.245 -6.245,-9.537 -6.326,-9.537 -0.081,0 -0.156,9.113 -0.168,20.25 m -15.329,-7.055 c -4.796,15.691 -13.746,27.122 -25.711,32.837 -6.104,2.915 -8.143,3.363 -16.939,3.717 -7.163,0.288 -11.405,-0.034 -14.953,-1.137 -2.725,-0.846 -5.112,-1.38 -5.305,-1.187 -0.194,0.194 2.26,1.99 5.453,3.993 11.61,7.281 26.391,9.76 36.994,6.203 14.326,-4.806 23.829,-22.746 23.106,-43.618 l -0.295,-8.497 -2.35,7.689 M 109,202.412 c 0,10.111 2.359,21.64 5.676,27.734 5.848,10.745 16.662,16.896 29.827,16.965 8.962,0.046 13.784,-1.217 23.997,-6.289 7.554,-3.751 12.33,-6.936 8.24,-5.497 -4.892,1.723 -15.887,2.863 -24.122,2.503 -7.626,-0.333 -10.263,-0.906 -15.174,-3.294 -11.227,-5.459 -20.305,-17.176 -25.403,-32.784 -1.212,-3.713 -2.392,-6.75 -2.623,-6.75 -0.23,0 -0.418,3.335 -0.418,7.412 m 140.409,24.413 c -6.981,2.413 -8.967,4.245 -25.479,23.507 -22.308,26.023 -37.743,39.931 -61.776,55.668 -2.082,1.363 -0.985,1.47 12.027,1.173 28.178,-0.644 43.394,5.802 56.994,24.144 16.089,21.7 33.873,71.76 44.4,124.981 1.501,7.589 3.045,13.439 3.431,13 0.386,-0.439 1.929,-7.216 3.427,-15.061 5.038,-26.367 14.892,-60.081 25.059,-85.737 12.428,-31.359 22.891,-45.794 39.429,-54.398 C 357.632,308.529 365.763,307 384.68,307 h 15.548 l -5.156,-2.75 c -15.882,-8.47 -42.068,-31.653 -58.205,-51.531 -12.838,-15.814 -21.486,-24.065 -27.295,-26.042 -6.191,-2.107 -14.652,-2.138 -23.669,-0.087 -6.391,1.454 -7.793,1.454 -16.321,0 -11.631,-1.982 -13.832,-1.957 -20.173,0.235 m -13.343,28.743 c -5.116,2.22 -17.148,15.182 -24.642,26.547 -3.637,5.516 -6.458,10.184 -6.268,10.372 0.189,0.189 3.944,-2.081 8.344,-5.044 4.4,-2.963 10.817,-6.525 14.261,-7.915 10.069,-4.066 15.827,-3.238 22.489,3.234 l 3.75,3.644 v -5.519 c 0,-6.223 -1.54,-15.994 -3.178,-20.171 -2.398,-6.111 -8.018,-8.071 -14.756,-5.148 m 73.903,1.182 c -2.574,2.311 -3.289,4.026 -4.481,10.75 -0.78,4.4 -1.417,10.475 -1.416,13.5 l 0.003,5.5 3.213,-3.64 c 1.766,-2.002 4.195,-4.139 5.396,-4.75 6.552,-3.33 19.233,0.961 36.744,12.435 5.872,3.847 -16.451,-26.28 -23.073,-31.14 -4.283,-3.143 -9.007,-5.405 -11.29,-5.405 -1.118,0 -3.412,1.238 -5.096,2.75 m -33.403,68.5 c -4.377,20.355 -4.482,50.192 -0.263,74.75 2.591,15.083 2.311,15.321 5.9,-5 2.84,-16.074 3.076,-44.032 0.506,-60 -2.74,-17.031 -2.938,-18 -3.67,-18 -0.384,0 -1.497,3.712 -2.473,8.25"
                class="head-outline" />
              </g>
            </svg>
            <span class="tooltip">
              <div class="tooltip-title">HORUS</div>
                <div class="tooltip-subtitle">Heartbeat Observation & Reporting Unilateral Sentinel</div>
                <p class="tooltip-body">
                    HORUS is a heartbeat function that runs on a timed pulse, observing activity and reporting state. 
                    It acts unilaterally, surfacing clear signals about session continuity and backend health. 
                    The Horus icon reflects this process visually, with eyes that change color and flash at different 
                    rates to indicate idle, active, warning, or error states.
                </p>
             </span>            
          </div>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <!-- =========================
         HERO â€” Option B (sibling cards)
         ========================= -->
    <section class="hero">

      <!-- Login card (visible when logged out) -->
      <div class="card hidden" id="loginContainer">
        <h2 style="text-align:center; color:var(--ink)">Login Required</h2>
        <form id="loginForm">
          <label>
            Username:<br>
            <input type="text" id="loginUsername" required>
          </label><br>
          <label>
            Password:<br>
            <input type="password" id="loginPassword" required>
          </label><br>
          <button type="submit" id="loginBtn" class="cta-btn" data-act="seclog" disabled>Login</button>
        </form>
      </div>

      <!-- Checkout mode selector (appears after login) -->
      <div class="card hidden" id="modeSelector">
        <h2 style="text-align:center; margin-top:0; color:var(--ink)">
          Choose <span style="color:var(--accent-orange)">Checkout Mode</span>
        </h2>
        <div class="hero-actions" style="justify-content:center;">
          <button id="choosePOSBtn" class="btn primary">POS</button>
          <button id="chooseSelfBtn" class="btn">Self Checkout</button>
        </div>
        <p class="small" style="text-align:center;">
          POS Mode for Employee's; Self Checkout for Guest.
        </p>
      </div>

      <!-- POS container (gallery + cart) -->
      <div class="card hidden" id="posContainer">
        <h2 style="text-align:center; margin-top:0; color:var(--ink)">
          Point of <span style="color: var(--accent-orange);"> Sale</span>
        </h2>
        <section id="posGallery" class="vertical-gallery" role="region" aria-label="POS Catalog"></section>
        <aside id="posCart" class="pos-cart-wrap">
          <ul id="posCartItems"></ul>
          <div class="cart-total" style="display:flex; justify-content:space-between;">
            <span>Total:</span>
            <strong>$<span id="posCartTotal">0.00</span></strong>
          </div>
          <div class="hero-actions" style="margin-top:12px;">
            <button id="posCheckoutBtn" class="btn primary">Checkout</button>
            <button id="posClearBtn" class="btn">Clear Cart</button>
            <button id="openRewardsModal" class="btn rewards">Get Rewards Member Info</button>                        <!-- Rewards summary inline -->
            <div class="rewards-row">
                <span class="rewards-label">Member:</span>
                 <span id="checkoutMemberName" class="rewards-box">Guest</span>

                <span class="rewards-label">Balance:</span>
                <span id="checkoutRewardsBalance" class="rewards-box">$0.00</span>

                <input type="number" id="checkoutRewardsInput" class="rewards-input" min="0" step="0.01" disabled />

                <button id="checkoutApplyRewardsBtn" class="btn apply-rewards" disabled>Apply</button>
            </div>
          </div>
        </aside>
      </div>

      <!-- Contact Form (self checkout) -->
      <div class="card hidden" id="contactForm">
        <h2 style="text-align:center; margin-top:0; color:var(--ink)">
          Join Our <span style="color: var(--accent-orange);">Rewards Trading Post!</span>
        </h2>
        <form onsubmit="handleFormSubmit(event)" autocomplete="on">
          <label>
            First Name:<br>
            <input type="text" id="custFirstname" name="given-name" required style="width:100%; padding:8px; margin:6px 0;">
          </label><br>
          <label>
            Last Name:<br>
            <input type="text" id="custLastname" name="family-name" required style="width:100%; padding:8px; margin:6px 0;">
          </label><br>
          <label>
            Address:<br>
            <input type="text" id="custAddress" name="street-address" required style="width:100%; padding:8px; margin:6px 0;">
          </label><br>
          <label>
            City:<br>
            <input type="text" id="custCity" name="address-level2" required style="width:100%; padding:8px; margin:6px 0;">
          </label><br>
          <label>
            State:<br>
            <select class="drop-down" id="custState" name="address-level1" required style="width:100%; padding:8px; margin:6px 0;">
              <option value="" class="placeholder"></option>
              <option value="AL">Alabama</option>
              <option value="AK">Alaska</option>
              <option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option>
              <option value="CA">California</option>
              <option value="CO">Colorado</option>
              <option value="CT">Connecticut</option>
              <option value="DE">Delaware</option>
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="HI">Hawaii</option>
              <option value="ID">Idaho</option>
              <option value="IL">Illinois</option>
              <option value="IN">Indiana</option>
              <option value="IA">Iowa</option>
              <option value="KS">Kansas</option>
              <option value="KY">Kentucky</option>
              <option value="LA">Louisiana</option>
              <option value="ME">Maine</option>
              <option value="MD">Maryland</option>
              <option value="MA">Massachusetts</option>
              <option value="MI">Michigan</option>
              <option value="MN">Minnesota</option>
              <option value="MS">Mississippi</option>
              <option value="MO">Missouri</option>
              <option value="MT">Montana</option>
              <option value="NE">Nebraska</option>
              <option value="NV">Nevada</option>
              <option value="NH">New Hampshire</option>
              <option value="NJ">New Jersey</option>
              <option value="NM">New Mexico</option>
              <option value="NY">New York</option>
              <option value="NC">North Carolina</option>
              <option value="ND">North Dakota</option>
              <option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option>
              <option value="OR">Oregon</option>
              <option value="PA">Pennsylvania</option>
              <option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option>
              <option value="SD">South Dakota</option>
              <option value="TN">Tennessee</option>
              <option value="TX">Texas</option>
              <option value="UT">Utah</option>
              <option value="VT">Vermont</option>
              <option value="VA">Virginia</option>
              <option value="WA">Washington</option>
              <option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option>
              <option value="WY">Wyoming</option>
            </select>
          </label><br>
          <label>
            Zip:<br>
            <input type="text" id="custZip" name="postal-code" required pattern="\d{5}" maxlength="5" style="width:100%; padding:8px; margin:6px 0;">
          </label><br>
          <label>
            Email:<br>
            <input type="email" id="custEmail" name="email" required style="width:100%; padding:8px; margin:6px 0;">
          </label><br>
          <label>
            Phone:<br>
            <input type="tel" id="custPhone" name="tel" autocomplete="tel" inputmode="numeric" placeholder="Enter 10 digits" style="width:100%; padding:8px; margin:6px 0;">
          </label><br>
          <label>
            Password:<br>
            <div style="position:relative;">
              <input type="password" id="custPassword" name="password" required style="width:100%; padding:8px; margin:6px 0;">
              <span onclick="togglePassword('custPassword')" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--muted);">ðŸ‘</span>
            </div>
            <meter id="passwordStrength" min="0" max="4" value="0" style="width:100%; height:8px; margin-top:4px;"></meter>
          </label><br>
          <div id="passwordCriteria" style="font-size:.9rem; color:var(--muted); margin-top:12px;">
            <strong>Your Password Must Be:</strong>
            <ul style="margin:6px 0 0 18px; padding:0;">
              <li>At least 8 characters long</li>
              <li>Include at least one uppercase letter (Aâ€“Z)</li>
              <li>Include at least one number (0â€“9)</li>
              <li>Include at least one special character (e.g. !, @, #, $)</li>
              <li>Match the Confirm Password field exactly</li>
            </ul>
          </div>
          <div id="passwordMessage" style="font-size:.9rem; margin-top:8px;"></div>
          <label><br>
            Confirm Password:<br>
            <div style="position:relative;">
              <input type="password" id="custConfirmpassword" name="confirm-password" required style="width:100%; padding:8px; margin:6px 0;">
              <span onclick="togglePassword('custConfirmpassword')" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--muted);">ðŸ‘</span>
            </div>
          </label><br>

          <!-- SMS Consent Checkbox -->
          <div id="SMSConsentMessage" style="font-size:.9rem; color:var(--muted); margin-top:12px;">
            <strong>Optional SMS Notifications</strong>
          </div>
          <label class="consent-inline" for="smsConsent">
            <input type="checkbox" id="smsConsent" name="smsConsent" value="true" />
            <span class="consent-text">
              I consent to receiving transactional text messages and phone calls from
              <strong>Picante Pequin Salsa Co.</strong>
              <span class="consent-optional">(optional)</span>
            </span>
          </label>

          <button type="submit" id="submitBtn" class="cta-btn" data-act="ppsc_signup" disabled>Join Now!</button>
        </form>
      </div>
    </section>

    <!-- Rewards Member Info Modal -->
    <div id="rewardsModal" class="contact-popup contact-hidden" role="dialog" aria-modal="true" aria-label="Rewards Member Lookup">
      <div class="contact-overlay"></div>
      <div class="contact-card">
        <h2 style="text-align:center; margin-top:0; color:var(--ink)">Rewards Member Lookup</h2>
        <form id="rewardsForm">
          <label class="contact-row">
            <span style="flex:0 0 120px;">Email (optional):</span>
            <input type="email" id="rewardsEmail" name="email" style="flex:1; padding:6px;" />
          </label>
          <label class="contact-row">
            <span style="flex:0 0 120px;">Phone (optional):</span>
            <input type="tel" id="rewardsPhone" name="phone" style="flex:1; padding:6px;" />
          </label>
          <div class="contact-actions">
            <button type="submit" id="rewardsLookupBtn" class="cta api-btn" data-act="posrewardsmember" data-loading-text="Looking up...">
              Get Rewards Balance
            </button>
          </div>
          <div class="contact-actions" style="margin-top:8px;">
            <button type="button" id="closeRewardsModal" class="close-modal-btn" aria-label="Close modal">âœ–</button>
          </div>
        </form>
        <div id="rewardsToast" class="contact-toast">Balance retrieved âœ”</div>
      </div>
    </div>

    <!-- Checkout Modal -->
<div id="checkoutModal" class="contact-popup contact-hidden" role="dialog" aria-modal="true" aria-label="Checkout">
  <div class="contact-overlay"></div>
  <div class="contact-card">
    <h2 style="text-align:center; margin-top:0; color:var(--ink)">Checkout</h2>

    <!-- Tender selection -->
<div class="tender">
  <label class="tender-option" id="tenderCashLabel">
    <input type="radio" id="tenderCash" name="tender" value="CASH" checked>
    <span>Cash</span>
  </label>

  <label class="tender-option" id="tenderCardLabel">
    <input type="radio" id="tenderCard" name="tender" value="CARD">
    <span>Card</span>
  </label>
</div>

    <!-- Static cart replica -->
    <div id="cartReplica" class="replica"></div>

    <!-- Cash-only controls -->
    <div id="cashControls" class="cash-controls">
      <label class="cash-label">Cash received</label>
      <input id="cashReceived" type="number" step="0.01" min="0" inputmode="decimal" class="cash-input"/>
      <div id="changeDueRow" class="change-row">
        <span>Change due:</span>
        <strong id="changeDue">$0.00</strong>
      </div>
    </div>

    <!-- Live status -->
    <div id="statusRow" class="status" aria-live="polite"></div>

    <!-- Actions -->
    <div class="contact-actions" style="margin-top:10px;">
      <button id="submitOrderBtn" class="btn primary">Submit order</button>
    </div>
    <div class="contact-actions" style="margin-top:8px;">
      <button id="closeCheckoutModal" class="close-modal-btn" aria-label="Close modal">âœ–</button>
    </div>
  </div>
</div>


<!-- Phase 3: Order Success Modal -->
<div id="orderSuccessModal" class="pps-success-modal contact-hidden" role="dialog" aria-modal="true" aria-label="Order success">
  <div class="pps-success-overlay"></div>

  <div class="pps-success-card">
    <h2 class="pps-success-title">Order Complete</h2>

    <div id="orderSuccessBody" class="pps-success-body">
      <p id="orderSuccessLine1" class="pps-success-line"></p>
      <p id="orderSuccessLine2" class="pps-success-line"></p>
		<div id="orderSuccessPointsBadge" class="pps-points-badge hidden">
  			+<span id="orderSuccessPointsValue"></span> pts
		</div>
    </div>

    <!-- Guest-only CTA -->
    <div id="orderSuccessGuestActions" class="pps-success-actions hidden">
      <button id="keepPointsBtn" class="btn primary pps-success-btn">
        Keep my points & join rewards
      </button>
    </div>

    <!-- Universal dismiss -->
    <div class="pps-success-actions">
      <button id="dismissOrderSuccessBtn" class="btn pps-dismiss-btn">
        Dismiss
      </button>
    </div>
  </div>
</div>

    <!-- Optional overlay (logged-out focus aid) -->
    <div id="authOverlay" class="hidden" aria-hidden="true"></div>
  </main>

  <footer>
    Â© <span id="y"></span> Picante Pequin Salsa Co. All rights reserved.
    <div class="links">
      <a href="https://picantepequinsalsaco.com/PrivacyPolicy">Privacy</a>
    </div>
  </footer>

  <!-- =========================
       Script: consolidated
       ========================= -->
  <script>
  (function () {
    'use strict';

    /* -------------------------
       AUTH GATE â€” sibling cards
       ------------------------- */
 const $id = id => document.getElementById(id);
(function enforceAuthGate() {
  if (window._ppsAuthGateInitialized) return;
  window._ppsAuthGateInitialized = true;

  let _ppsAuthGateLastRun = 0;
  const authKey = `pps_loggedIn@${location.origin}`;
  document.documentElement.classList.add('pps-auth-pending');

  function isLogged() {
    return sessionStorage.getItem(authKey) === 'true';
  }

// Track current view globally
let currentView = sessionStorage.getItem('currentView') || 'login';
sessionStorage.setItem('currentView', currentView);

// Track join button caller globally
let joinCaller = sessionStorage.getItem('joinCaller') || null;
sessionStorage.setItem('joinCaller', joinCaller);

  // -------------------------
  // Scene functions
  // -------------------------
function showLogin() {
  currentView = 'login';
  sessionStorage.setItem('currentView', currentView);
  joinCaller = 'login';
  sessionStorage.setItem('joinCaller', joinCaller);

  showView('login');
  $id('chooseJoinBtn')?.classList.add('hidden');
  $id('chooseLogOutBtn')?.classList.add('hidden');
  $id('returnFromJoinBtn')?.classList.add('hidden');
}

function showModeSelector() {
  currentView = 'mode';
  sessionStorage.setItem('currentView', currentView);
  joinCaller = 'mode';
  sessionStorage.setItem('joinCaller', joinCaller);

  showView('mode');
  $id('chooseJoinBtn')?.classList.remove('hidden');
  $id('chooseLogOutBtn')?.classList.remove('hidden');
  $id('returnFromJoinBtn')?.classList.add('hidden');
  $id('authOverlay')?.classList.add('hidden');
  resetZoom();
}

function showPOSContainer() {
  currentView = 'pos';
  sessionStorage.setItem('currentView', currentView);
  joinCaller = 'pos';
  sessionStorage.setItem('joinCaller', joinCaller);
	
  showView('pos');
  $id('chooseJoinBtn')?.classList.remove('hidden');
  $id('chooseLogOutBtn')?.classList.remove('hidden');
  $id('returnFromJoinBtn')?.classList.remove('hidden');
  $id('authOverlay')?.classList.add('hidden');
  initPOSCatalog();
  resetZoom();
  resetRewardsToGuest();
  clearPOSCartOnly();
}

function showSelfCheckout() {
  currentView = 'self';
  sessionStorage.setItem('currentView', currentView);
  joinCaller = 'self';
  sessionStorage.setItem('joinCaller', joinCaller);


  showView('self');
  $id('chooseJoinBtn')?.classList.remove('hidden');
  $id('chooseLogOutBtn')?.classList.add('hidden');
  $id('returnFromJoinBtn')?.classList.add('hidden');
  $id('authOverlay')?.classList.add('hidden');
  initPOSCatalog();
  resetZoom();
  resetRewardsToGuest();
  clearPOSCartOnly();
}

function showJoinRewards() {
  // remember where you came from
  joinCaller = currentView;
  sessionStorage.setItem('joinCaller', joinCaller);

  currentView = 'contact';
  sessionStorage.setItem('currentView', currentView);

  showView('contact');
  $id('chooseJoinBtn')?.classList.add('hidden');
  $id('chooseLogOutBtn')?.classList.add('hidden');
  $id('returnFromJoinBtn')?.classList.remove('hidden');
  $id('authOverlay')?.classList.add('hidden');
  resetZoom();
}
	
function clearPOSCartOnly() {
  // Clear the underlying cart array
  if (Array.isArray(window.posCart)) {
    window.posCart.length = 0;
  }

  // Clear the DOM rows + totals
  if (typeof renderCart === 'function') {
    renderCart();
  }
  // Unlock the rewards lookup button
  const openBtn = $id('openRewardsModal');
  if (openBtn) {
    openBtn.disabled = false;
    openBtn.classList.remove('disabled');
    openBtn.removeAttribute('aria-disabled');
  }
}
// -------------------------
// Back button wiring
// -------------------------
$id('returnFromJoinBtn')?.addEventListener('click', () => {
  if (currentView === 'pos') {
    showModeSelector(); // back from POS â†’ mode selector
  } else if (currentView === 'contact') {
    // back from Join Rewards â†’ caller
    if (joinCaller === 'pos') {
      showPOSContainer();
    } else if (joinCaller === 'self') {
      showSelfCheckout();
    } else {
      showModeSelector(); // fallback
    }
  } else {
    showModeSelector(); // fallback
  }
});

  // -------------------------
  // Gate respects currentView
  // -------------------------
  function applyGate() {
    const now = Date.now();
    if (now - _ppsAuthGateLastRun < 150) return;
    _ppsAuthGateLastRun = now;

    if (!isLogged()) {
      sessionStorage.removeItem('sid');
      showLogin();
      setTimeout(() => { document.documentElement.classList.remove('pps-auth-pending'); }, 0);
      console.info('Gate: unauthenticated â€” login visible, others hidden.');
      return;
    }

    if (currentView === 'pos') showPOSContainer();
    else if (currentView === 'self') showSelfCheckout();
    else if (currentView === 'contact') showJoinRewards();
    else showModeSelector();

    document.documentElement.classList.remove('pps-auth-pending');
    console.info(`Gate: authenticated â€” ${currentView} visible.`);
  }

  window._internalApplyGate = applyGate;
  window.showPOSContainer = showPOSContainer;
  window.showSelfCheckout = showSelfCheckout;
  window.showJoinRewards = showJoinRewards;
})();
    
// -------------------------
// Global rewards defaults
// -------------------------
function resetRewardsToGuest() {
  window.rewardsMember = {
    name: "Guest",
    email: null,
    phone: null,
    points: 0,
    balance: "0.00",
    isGuest: true
  };

  window.rewardsConsumedPoints = 0;

  // POS / Self Checkout inline UI
  const memberNameEl = document.getElementById("checkoutMemberName");
  const balanceEl = document.getElementById("checkoutRewardsBalance");
  const inputEl = document.getElementById("checkoutRewardsInput");
  const applyBtn = document.getElementById("checkoutApplyRewardsBtn");

  if (memberNameEl) memberNameEl.textContent = "Guest";
  if (balanceEl) balanceEl.textContent = "$0.00";

  if (inputEl) {
    inputEl.value = "0";
    inputEl.disabled = true;
  }

  if (applyBtn) applyBtn.disabled = true;
}

// Initialize once at startup
resetRewardsToGuest();

    /* -------------------------
       Small helpers
       ------------------------- */
    const safe = v => (v || '').toString().trim();
    function once(fn) { let ran = false; return (...a) => { if (ran) return; ran = true; return fn(...a); }; }

    /* -------------------------
       Loading / viewport helpers
       ------------------------- */
    function _resetViewportScale({ allowPinchAfter = true } = {}) {
      let meta = document.querySelector('meta[name="viewport"]');
      if (!meta) { meta = document.createElement('meta'); meta.name = 'viewport'; document.head.appendChild(meta); }
      const base = 'width=device-width';
      meta.content = base + ', initial-scale=1.0001';
      requestAnimationFrame(() => { meta.content = base + ', initial-scale=1.0' + (allowPinchAfter ? ', user-scalable=yes' : ', maximum-scale=1.0'); });
      if (document.activeElement && typeof document.activeElement.blur === 'function') document.activeElement.blur();
      setTimeout(() => { window.scrollTo(0, Math.max(0, window.pageYOffset || 0)); }, 0);
    }
    function startLoading(opts) { _resetViewportScale(opts); document.documentElement.classList.add('is-loading'); }
    function stopLoading() { document.documentElement.classList.remove('is-loading'); }

      function resetZoom() {
  const meta = document.querySelector('meta[name="viewport"]');
  if (meta) {
    // Temporarily disable user scaling, then restore
    meta.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no');
    setTimeout(() => {
      meta.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes');
    }, 500);
  }
}

// Toast utility â€” generic, reused across flows
function showToast(msg, { kind = 'info', ms = 4000 } = {}) {
  let toast = document.getElementById('globalToast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'globalToast';
    toast.className = 'contact-toast'; // reusing modal toast style
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.background = kind === 'error' ? '#7a1f1f' : '#333';
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), ms);
}

    /* -------------------------
       Validators
       ------------------------- */
    const reEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const reZip = /^\d{5}$/;
    const reStreet = /^\d+\s+[\w\s]+/;
    const rePhoneFormatted = /^\+1 \(\d{3}\) \d{3}-\d{4}$/;

    const validators = {
      email: v => reEmail.test(safe(v)),
      notEmpty: v => safe(v).length > 0,
      zip5: v => reZip.test(safe(v)),
      street: v => reStreet.test(safe(v)),
      phoneFormatted: v => rePhoneFormatted.test(safe(v))
    };

    /* -------------------------
       Field-level validation messages
       ------------------------- */
    function setupFieldValidation(fieldId, validateFn, hint) {
      const el = $id(fieldId);
      if (!el) return;
      if (el.nextElementSibling && el.nextElementSibling.classList?.contains('field-message')) return;
      const msg = document.createElement('div');
      msg.className = 'field-message';
      msg.style.cssText = 'font-size:.9rem;margin-top:4px;color:var(--muted);transition:color .25s ease;';
      el.insertAdjacentElement('afterend', msg);

      function update() {
        try {
          if (validateFn(el.value)) { msg.textContent = 'âœ” Looks good'; msg.style.color = 'var(--accent-green)'; }
          else { msg.textContent = hint; msg.style.color = 'var(--muted)'; }
        } catch (e) { /* noop */ }
      }
      el.addEventListener('focus', () => { if (!safe(el.value)) { msg.textContent = hint; msg.style.color = 'var(--muted)'; }});
      el.addEventListener('input', update);
      el.addEventListener('blur', update);
    }

    /* -------------------------
       Phone handling (authoritative)
       ------------------------- */
    function _formatFromDigits(d) {
      if (!d) return '';
      if (d.length === 10) return `+1 (${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
      if (d.length >= 6) return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
      if (d.length >= 3) return `(${d.slice(0,3)}) ${d.slice(3)}`;
      return d;
    }
    function setPhoneRawAndRender(input, digits) {
      if (!input) return;
      digits = (digits || '').replace(/\D/g, '');
      if (digits.length > 10 && digits[0] === '1') digits = digits.slice(1);
      digits = digits.slice(0, 10);
      input.dataset.raw = digits;
      input.value = _formatFromDigits(digits);
    }
    function formatPhoneInternal(input) {
      if (!input) return;
      let d = (input.value || '').replace(/\D/g, '');
      if (d.length === 11 && d[0] === '1') d = d.slice(1);
      d = d.slice(0, 10);
      input.dataset.raw = d;
      input.value = _formatFromDigits(d);
    }
    function placeCaretAfterDigits(input, digitIndex) {
      if (!input) return;
      const s = input.value || '';
      if (!digitIndex) { try { input.setSelectionRange(0,0); } catch(_) {} return; }
      let seen = 0;
      for (let i=0;i<s.length;i++) {
        if (/\d/.test(s[i])) seen++;
        if (seen === digitIndex) { try { input.setSelectionRange(i+1, i+1); } catch(_) {} return; }
      }
      try { input.setSelectionRange(s.length, s.length); } catch(_) {}
    }
    function wirePhone(input) {
      if (!input || input._fv_wired) return;
      input.setAttribute('inputmode','numeric');
      input.setAttribute('autocomplete','tel');
      input.setAttribute('maxlength','20');

      const digitsFrom = v => (String(v||'').replace(/\D/g,'').slice(0,11));
      function selectionDigitOffsets(el) {
        const s = el.value || '';
        const start = (typeof el.selectionStart === 'number') ? el.selectionStart : s.length;
        const end = (typeof el.selectionEnd === 'number') ? el.selectionEnd : start;
        const left = s.slice(0, start), right = s.slice(0, end);
        return { startDigitCount: (left.match(/\d/g)||[]).length, endDigitCount: (right.match(/\d/g)||[]).length };
      }
      function applyDigitsAndPlace(phoneEl, newDigits, caretDigitIndex) {
        if (!phoneEl) return;
        if (newDigits.length > 10 && newDigits[0] === '1') newDigits = newDigits.slice(1);
        newDigits = (newDigits || '').replace(/\D/g,'').slice(0,10);
        setPhoneRawAndRender(phoneEl, newDigits);
        placeCaretAfterDigits(phoneEl, caretDigitIndex);
      }
      function beforeInput(e) {
        try {
          if (!e.data && e.inputType === 'insertCompositionText') return;
          const phoneEl = e.target;
          if (!phoneEl) return;
          const currentRaw = (phoneEl.dataset.raw||'').replace(/\D/g,'').slice(0,10);
          const { startDigitCount, endDigitCount } = selectionDigitOffsets(phoneEl);
          let newDigits = currentRaw;
          let caretDigitIndex = startDigitCount;
          switch (e.inputType) {
            case 'insertText': {
              const ch = (e.data||'').replace(/\D/g,'');
              if (!ch) { e.preventDefault(); return; }
              const arr = newDigits.split('');
              arr.splice(startDigitCount, endDigitCount - startDigitCount, ...ch.split(''));
              newDigits = arr.join('');
              caretDigitIndex = startDigitCount + ch.length;
              e.preventDefault();
              break;
            }
            case 'insertFromPaste': {
              const pasted = (e.clipboardData || window.clipboardData)?.getData('text') || '';
              const digits = pasted.replace(/\D/g,'');
              if (!digits) { e.preventDefault(); return; }
              const arr = newDigits.split('');
              arr.splice(startDigitCount, endDigitCount - startDigitCount, ...digits.split(''));
              newDigits = arr.join('');
              caretDigitIndex = startDigitCount + digits.length;
              e.preventDefault();
              break;
            }
            case 'deleteContentBackward': {
              if (endDigitCount > startDigitCount) {
                const arr = newDigits.split('');
                arr.splice(startDigitCount, endDigitCount - startDigitCount);
                newDigits = arr.join('');
                caretDigitIndex = startDigitCount;
              } else if (startDigitCount > 0) {
                const arr = newDigits.split('');
                arr.splice(startDigitCount-1, 1);
                newDigits = arr.join('');
                caretDigitIndex = startDigitCount - 1;
              }
              e.preventDefault();
              break;
            }
            case 'deleteContentForward': {
              if (endDigitCount > startDigitCount) {
                const arr = newDigits.split('');
                arr.splice(startDigitCount, endDigitCount - startDigitCount);
                newDigits = arr.join('');
                caretDigitIndex = startDigitCount;
              } else {
                const arr = newDigits.split('');
                if (startDigitCount < arr.length) arr.splice(startDigitCount, 1);
                newDigits = arr.join('');
                caretDigitIndex = startDigitCount;
              }
              e.preventDefault();
              break;
            }
            case 'insertFromDrop': {
              const dragged = (e.dataTransfer || {}).getData?.('text') || '';
              const digits = dragged.replace(/\D/g,'');
              if (!digits) { e.preventDefault(); return; }
              const arr = newDigits.split('');
              arr.splice(startDigitCount, endDigitCount - startDigitCount, ...digits.split(''));
              newDigits = arr.join('');
              caretDigitIndex = startDigitCount + digits.length;
              e.preventDefault();
              break;
            }
            default: return;
          }
          applyDigitsAndPlace(phoneEl, newDigits, caretDigitIndex);
        } catch (err) { return; }
      }
      function inputFallback(e) {
        try {
          const el = e.target;
          const digits = digitsFrom(el.value).replace(/^1(?=\d{10}$)/,'').slice(0,10);
          applyDigitsAndPlace(el, digits, (digits||'').length);
        } catch (_) {}
        if (typeof validateContactForm === 'function') validateContactForm();
      }
      function keydownGuard(e) {
        const allowed = ['Backspace','Delete','ArrowLeft','ArrowRight','Home','End','Tab'];
        if (allowed.includes(e.key) || e.ctrlKey || e.metaKey) return;
        if (!/^\d$/.test(e.key)) e.preventDefault();
      }
      input.addEventListener('beforeinput', beforeInput, { passive: false });
      input.addEventListener('input', inputFallback);
      input.addEventListener('blur', () => { formatPhoneInternal(input); if (typeof validateContactForm === 'function') validateContactForm(); });
      input.addEventListener('keydown', keydownGuard);
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text')||'';
        const digits = text.replace(/\D/g,'').replace(/^1(?=\d{10}$)/,'').slice(0,10);
        setPhoneRawAndRender(input, digits);
        if (typeof validateContactForm === 'function') validateContactForm();
      });
      input._fv_wired = true;
    }

    /* -------------------------
       UI toggles / views
       ------------------------- */
    
    function openRewardsModal() { document.body.classList.add('body-lock'); $id('rewardsModal')?.classList.remove('contact-hidden'); }
    function closeRewardsModal() { document.body.classList.remove('body-lock'); $id('rewardsModal')?.classList.add('contact-hidden'); }

    /* -------------------------
       OmniTok helper
       ------------------------- */
    const API = { issueOmniTok: 'https://default6eda43f3fbf04e2b9978b543d9dd31.e3.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e3755ec03d8241c09ddb4d73a1c2bb86/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9t0-qJP8VJW4G9_COUvGJxmFKL6IWjUBeEq4GYZj3kQ' };
    async function getOmniTok(act, meta = undefined) {
      const sid = crypto.randomUUID();
      sessionStorage.setItem('sid', sid);
      const body = { act, sid };
      if (meta && typeof meta === 'object') body.meta = meta;
      const res = await fetch(API.issueOmniTok, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (!res.ok) throw new Error(`Failed to get OmniTok config for ${act}`);
      const data = await res.json();
      sessionStorage.setItem('omniTok', data.OmniTok);
      return { ...data, sid };
    }
    window.getOmniTok = getOmniTok;

    /* -------------------------
       POS catalog + cart (minimal)
       ------------------------- */
function initPOSCatalog() {
  // Guard: do nothing if already initialized
  if (window._posCatalogInitialized) return;
  window._posCatalogInitialized = true;

  const gallery = $id('posGallery');
  if (!gallery) return;

  // Restore cart from sessionStorage
  const savedCart = sessionStorage.getItem('posCart');
  const cart = savedCart ? JSON.parse(savedCart) : [];

  function renderCart() {
    const list = $id('posCartItems');
    const totalEl = $id('posCartTotal');
    if (!list || !totalEl) return;
    list.innerHTML = '';
    let total = 0;

    cart.forEach((item, idx) => {
      total += item.price * item.qty;
      const li = document.createElement('li');

      if (item.id === 'rewards-credit') {
        li.innerHTML = `
          <span class="cart-name">${item.name}</span>
          <div class="cart-controls">
            <span class="qty-display">${item.qty}</span>
            <button class="remove-btn">âœ–</button>
          </div>
        `;
        li.querySelector('.remove-btn').onclick = () => {
          cart.splice(idx, 1);
          renderCart();
          // Re-enable rewards input
          const inputEl = $id('checkoutRewardsInput');
          if (inputEl) {
            inputEl.disabled = false;
            inputEl.readOnly = false;
            inputEl.classList.remove('locked');
            inputEl.value = window.rewardsMember?.points || 0;
          }
          window.rewardsConsumedPoints = 0;
          const applyBtn = $id('checkoutApplyRewardsBtn');
          if (applyBtn) { applyBtn.disabled = false; applyBtn.classList.remove('disabled'); }
        };
      } else {
        li.innerHTML = `
          <span class="cart-name">${item.name}</span>
          <div class="cart-controls">
            <button class="qty-btn minus">âˆ’</button>
            <span class="qty-display">${item.qty}</span>
            <button class="qty-btn plus">+</button>
            <button class="remove-btn">âœ–</button>
          </div>
        `;
        li.querySelector('.minus').onclick = () => { if (item.qty > 1) item.qty--; else cart.splice(idx,1); renderCart(); };
        li.querySelector('.plus').onclick = () => { item.qty++; renderCart(); };
        li.querySelector('.remove-btn').onclick = () => { cart.splice(idx,1); renderCart(); };
      }
      list.appendChild(li);
    });

    totalEl.textContent = total.toFixed(2);
    window.cartTotal = total;

    // Persist cart after each render
    sessionStorage.setItem('posCart', JSON.stringify(cart));
  }

  function addToCart(it) {
    const idx = cart.findIndex(x => x.id === it.id);
    if (idx > -1) cart[idx].qty += it.qty;
    else cart.push({ ...it });
    renderCart();
  }

  // Expose
  window.posCart = cart;
  window.addToCart = addToCart;
  window.renderCart = renderCart;

  // Build gallery only once
  gallery.innerHTML = '';
  const products = [
    { id: 'PPSC-001', name: 'House Pequin Salsa', price: 10, image: 'https://picantepequinsalsaco.com/images/image1.jpg' },
    { id: 'PPSC-002', name: 'Spicy Green Chile Pequin', price: 10, image: 'https://picantepequinsalsaco.com/images/image2.jpg' },
    { id: 'PPSC-003', name: 'Red Hot Pepper Pequin', price: 10, image: 'https://picantepequinsalsaco.com/images/image3.jpg' },
    { id: 'PPSC-004', name: 'The Crew (3â€‘Pack)', price: 30, image: 'https://picantepequinsalsaco.com/images/image4.jpg' }
  ];

  products.forEach(p => {
    const card = document.createElement('div');
    card.className = 'prod-card';
    card.innerHTML = `
      <img src="${p.image}" alt="${p.name}">
      <h3 class="prod-name">${p.name}</h3>
      <p class="prod-price">$${p.price.toFixed(2)}</p>
      <div class="quantity">
        <button class="qty-btn minus">âˆ’</button>
        <input type="number" class="qty-input" value="0" min="0">
        <button class="qty-btn plus">+</button>
      </div>
      <button class="add-to-cart">Add to Cart</button>
    `;
    const qtyInput = card.querySelector('.qty-input');
    card.querySelector('.qty-btn.minus').onclick = () => { qtyInput.value = Math.max(0, +qtyInput.value - 1); };
    card.querySelector('.qty-btn.plus').onclick = () => { qtyInput.value = +qtyInput.value + 1; };
    card.querySelector('.add-to-cart').onclick = () => {
      const q = +qtyInput.value;
      if (!q) return;
      addToCart({ id: p.id, name: p.name, price: p.price, qty: q });
      qtyInput.value = 0;
    };
    gallery.appendChild(card);
  });

  $id('posClearBtn')?.addEventListener('click', () => {
    cart.length = 0;
    renderCart();
    window.rewardsConsumedPoints = 0;
    const openBtn = $id('openRewardsModal');
    const inputEl = $id('checkoutRewardsInput');
    if (openBtn) { openBtn.disabled = false; openBtn.classList.remove('disabled'); }
    if (inputEl) {
      inputEl.value = '';
      inputEl.disabled = false;
      inputEl.readOnly = false;
      inputEl.classList.remove('locked');
      inputEl.value = window.rewardsMember?.points || 0;
    }
    const applyBtn = $id('checkoutApplyRewardsBtn');
    if (applyBtn) { applyBtn.disabled = false; applyBtn.classList.remove('disabled'); }
  });

  $id('posCheckoutBtn')?.addEventListener('click', () => {
    if (!cart.length) { alert('Cart is empty.'); return; }
    wirePOSCheckoutModal();
  });

  // Initial render (uses persisted cart if present)
  renderCart();
}

    /* -------------------------
       Form reset + validation
       ------------------------- */
    function resetContactForm() {
      const form = document.querySelector('#contactForm form');
      if (form) form.reset();
      const meter = $id('passwordStrength'); if (meter) meter.value = 0;
      const msg = $id('passwordMessage'); if (msg) msg.textContent = '';
      const phone = $id('custPhone'); if (phone) { phone.dataset.raw = ''; phone.value = ''; }
      const sms = $id('smsConsent'); if (sms) { sms.checked = false; sms.value = ''; }
      if (typeof validateContactForm === 'function') validateContactForm();
      const refresh = ['custFirstname','custLastname','custAddress','custCity','custState','custZip','custEmail','custPhone','custPassword','custConfirmpassword','loginUsername','loginPassword'];
      refresh.forEach(id => { const el = $id(id); if (!el) return; el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('blur',{bubbles:true})); });
    }
    window.resetContactForm = resetContactForm;

    const requiredFields = ['custFirstname','custLastname','custAddress','custCity','custState','custZip','custEmail','custPhone','custPassword','custConfirmpassword'];
    window.validateContactForm = function validateContactForm() {
      try {
        let ok = requiredFields.every(id => { const el = $id(id); return el && safe(el.value).length > 0; });
        const pw = $id('custPassword')?.value || '';
        const conf = $id('custConfirmpassword')?.value || '';
        if (pw !== conf || pw.length < 8) ok = false;
        const submit = $id('submitBtn'); if (submit) { submit.disabled = !ok; submit.classList.toggle('enabled', ok); }
      } catch (e) { /* noop */ }
    };

    /* -------------------------
       Password UI
       ------------------------- */
    (function wirePasswordUI() {
      const pw = $id('custPassword'), cpw = $id('custConfirmpassword'), msg = $id('passwordMessage'), meter = $id('passwordStrength');
      function updateMatch() {
        if (!pw || !cpw || !msg) return;
        if (!pw.value && !cpw.value) { msg.textContent=''; msg.style.color='var(--muted)'; validateContactForm(); return; }
        if (pw.value !== cpw.value) { msg.style.color='var(--accent-red)'; msg.textContent='Passwords do not match. Please reâ€‘enter.'; }
        else { msg.style.color='var(--accent-green)'; msg.textContent='Passwords match âœ”'; }
        validateContactForm();
      }
      if (cpw) cpw.addEventListener('input', updateMatch);
      if (pw) {
        pw.addEventListener('input', () => {
          const v = pw.value || ''; let score = 0;
          if (v.length >= 8) score++;
          if (/[A-Z]/.test(v)) score++;
          if (/[0-9]/.test(v)) score++;
          if (/[^A-Za-z0-9]/.test(v)) score++;
          if (meter) meter.value = score;
          updateMatch();
        });
      }
    })();

              function doManualReveal() {
            try { clearInterval(window._ppsAuthGateIntervalId); } catch(e) {}
            try { window._ppsAuthGateObserver?.disconnect(); } catch(e) {}

            $id('loginContainer')?.classList.add('hidden');
            $id('modeSelector')?.classList.remove('hidden');
            $id('posContainer')?.classList.add('hidden');
            $id('contactForm')?.classList.add('hidden');
            $id('authOverlay')?.classList.add('hidden');

            console.info('Auth gate: login success â€” forced reveal and stopped enforcement.');
          }

function showView(view) {
  // Hide all
  $id('loginContainer')?.classList.add('hidden');
  $id('modeSelector')?.classList.add('hidden');
  $id('posContainer')?.classList.add('hidden');
  $id('contactForm')?.classList.add('hidden');

  // Reveal selected
  if (view === 'pos') $id('posContainer')?.classList.remove('hidden');
  if (view === 'self') $id('posContainer')?.classList.remove('hidden'); // or separate container
  if (view === 'mode') $id('modeSelector')?.classList.remove('hidden');
  if (view === 'contact') $id('contactForm')?.classList.remove('hidden');
  if (view === 'login') {
    $id('loginContainer')?.classList.remove('hidden');
    $id('authOverlay')?.classList.remove('hidden');
  }
    // Overlay control: hide it for all non-login views
  if (view !== 'login') {
    $id('authOverlay')?.classList.add('hidden');
    document.documentElement.classList.remove('pps-auth-pending');
  }

  // Persist state
  window.currentView = view;
  sessionStorage.setItem('currentView', view);
}
window.showView = showView;


    /* -------------------------
       Login wiring
       ------------------------- */
    function wireLogin() {
      const form = $id('loginForm'), btn = $id('loginBtn'), user = $id('loginUsername'), pass = $id('loginPassword');
      if (!form || !btn || !user || !pass) return;
      function validate() {
        const ok = validators.email(user.value) && safe(pass.value).length >= 8;
        btn.disabled = !ok;
        btn.classList.toggle('enabled', ok);
        btn.setAttribute('aria-disabled', String(!ok));

          // HORUS feedback
  if (validators.email(user.value)) {
    setEyes([
      { id: "LeftEye",  state: "ok", flash: false },
      { id: "RightEye", state: "idle", flash: true, rate: 1200 }
    ]);
  } 
}
      validate();
      user.addEventListener('input', validate); pass.addEventListener('input', validate);

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault(); if (btn.disabled) return;
        btn.disabled = true; btn.classList.add('btn-loading'); const original = btn.textContent; btn.textContent = 'Logging in...'; startLoading();
        // HORUS preflight feedback
          setEyes([
           { id: "LeftEye",  state: "ok", flash: true, rate: 900 },
           { id: "RightEye", state: "warn", flash: true, rate: 350 }
           ]);
        resetZoom();
        try {
          const omni = await getOmniTok(btn.dataset.act || 'seclog');
            if (!omni?.endpoint) {
           // HORUS feedback: OmniTok preflight failed
           setEyes([
           { id: "LeftEye",  state: "warn", flash: false, },
           { id: "RightEye", state: "warn", flash: false, }
           ]);
           setEyes([
           { id: "LeftEye",  state: "off", flash: false, },
           { id: "RightEye", state: "off", flash: false, }
           ]);
           setEyes([
           { id: "LeftEye",  state: "error", flash: true, rate: 800 },
           { id: "RightEye", state: "error", flash: true, rate: 800 }
           ]);
          if (!omni?.endpoint) throw new Error('Omnitok preflight did not return an endpoint');}

          setEyes([
          { id: "LeftEye",  state: "ok",   flash: true, rate: 900 },
          { id: "RightEye", state: "ok",   flash: true, rate: 350 }
          ]);
          const payload = { jobId: `PPSLOGIN-${crypto.randomUUID()}`, username: user.value.trim(), password: pass.value.trim() };
          const res = await fetch(omni.endpoint, { method: 'POST', headers: { 'Content-Type':'application/json', 'x-auth-token': omni.authToken, 'x-omnitok': omni.OmniTok, 'x-sid': omni.sid, 'x-act': omni.act }, body: JSON.stringify(payload) });
          if (!res.ok) {

            setEyes([
           { id: "LeftEye",  state: "warn", flash: false, },
           { id: "RightEye", state: "warn", flash: false, }
           ]);

           setEyes([
           { id: "LeftEye",  state: "off", flash: false, },
           { id: "RightEye", state: "off", flash: false, }
           ]);

            setEyes([
             { id: "LeftEye",  state: "error", flash: true, rate: 800 },
             { id: "RightEye", state: "error", flash: true, rate: 800 }
             ]);
            throw new Error('Login failed');}

          const result = await res.json();
          if (!result || typeof result.jobId !== 'string') {

            setEyes([
           { id: "LeftEye",  state: "warn", flash: false, },
           { id: "RightEye", state: "warn", flash: false, }
           ]);

            setEyes([
           { id: "LeftEye",  state: "off", flash: false, },
           { id: "RightEye", state: "off", flash: false, }
           ]);

            setEyes([
             { id: "LeftEye",  state: "error", flash: true, rate: 800 },
             { id: "RightEye", state: "error", flash: true, rate: 800 }
             ]);
          throw new Error('Unexpected response shape (missing jobId)');}
            
           // HORUS feedback: login success
           setEyes([
           { id: "LeftEye",  state: "ok", flash: false, },
           { id: "RightEye", state: "ok", flash: false, }
           ]);

            setEyes([
           { id: "LeftEye",  state: "off", flash: false, },
           { id: "RightEye", state: "off", flash: false, }
           ]);
          setEyes([
             { id: "LeftEye",  state: "ok", flash: true, rate: 1200 },
             { id: "RightEye", state: "ok", flash: true, rate: 1200 }
             ]);

          // Success: set namespaced auth key
          const authKey = `pps_loggedIn@${location.origin}`;
          sessionStorage.setItem(authKey, 'true');
          if (!sessionStorage.getItem('sid')) sessionStorage.setItem('sid', crypto.randomUUID());

          sessionStorage.setItem('username', payload.username);

          sessionStorage.setItem('masterTok', result.MasterTok);

          document.documentElement.classList.remove('pps-auth-pending');

          // Prefer the central gate
          if (typeof window._ppsApplyAuthGate === 'function') {
            try { window._ppsApplyAuthGate(); }
            catch (e) { console.warn('ppsApplyAuthGate threw', e); doManualReveal(); }
          } else { doManualReveal(); }
          
             // Start Horus
          startHorus();
          btn.textContent = 'âœ“ Logged In'; btn.classList.add('is-success'); btn.classList.remove('is-error');
        } catch (err) {
          console.error('Login error:', err);
          alert('âŒ Login failed. Please try again.');
          btn.textContent = 'Retry Login'; btn.classList.remove('is-success'); btn.classList.add('is-error'); btn.disabled = false;
        } finally { btn.classList.remove('btn-loading'); stopLoading(); }
      });
    }

    /* -------------------------
       Rewards lookup wiring
       ------------------------- */
    function wireRewards() {
      if (wireRewards._wired) return;
      wireRewards._wired = true;

      const openBtn = $id('openRewardsModal');
      const closeBtn = $id('closeRewardsModal');
      const form = $id('rewardsForm');
      const lookupBtn = $id('rewardsLookupBtn');

      openBtn?.addEventListener('click', openRewardsModal);
      closeBtn?.addEventListener('click', closeRewardsModal);

      if (!form || !lookupBtn) { console.warn('wireRewards: rewards form or lookup button missing'); return; }

      async function onSubmit(ev) {
        ev.preventDefault();
        lookupBtn.disabled = true;
        lookupBtn.classList.add('loading');
        const origText = lookupBtn.textContent;
        lookupBtn.textContent = lookupBtn.dataset.loadingText || 'Looking up...';

        try {
          const emailVal = (document.getElementById('rewardsEmail')?.value || '').trim();
          const rawPhone = (document.getElementById('rewardsPhone')?.value || '').trim();
          let phoneDigits = rawPhone.replace(/\D/g,'');
          if (phoneDigits.length === 11 && phoneDigits[0] === '1') phoneDigits = phoneDigits.slice(1);
          phoneDigits = phoneDigits.slice(0,10);
          

                // Enforce single-identity lookup
                if (!emailVal && !phoneDigits) {
                alert('Please enter an email OR a 10-digit phone number.');
                return;
                }

                if (emailVal && phoneDigits) {
                alert('Please enter ONLY email OR ONLY phone â€” not both.');
                 return;
                }
          const omni = await getOmniTok(lookupBtn.dataset.act || 'posrewardsmember', { email: emailVal || undefined, phone: phoneDigits || undefined });
          if (!omni || !omni.endpoint) throw new Error('OmniTok preflight returned no endpoint.');

          const payload = { jobId: `PPSREWARDS-${crypto.randomUUID()}`, email: emailVal || undefined, phone: phoneDigits || undefined };
          const res = await fetch(omni.endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'username': sessionStorage.getItem('username'), 'x-auth-token': omni.authToken, 'x-omnitok': omni.OmniTok, 'x-sid': omni.sid, 'x-act': omni.act },
            body: JSON.stringify(payload)
          });
          const text = await res.text().catch(()=>'<no-body>');
          if (!res.ok) throw new Error(`Rewards lookup failed (${res.status}) ${text}`);

          let result; try { result = JSON.parse(text); } catch(e) { result = {}; }
              
          if (result.status !== "OK") {
            throw new Error(`Rewards lookup returned status ${result.status}`);
         }
                  // ðŸ”§ Normalize rewards: divide by 1000 and round to 2 decimals
          const rawRewards = parseInt(result.rewards, 10) || 0;
          const balance = (rawRewards / 1000).toFixed(2);
            
          window.rewardsMember = { 
            name: result.firstName || 'Member', 
            balance, 
            points: rawRewards,
            email: result.email || emailVal, 
            phone: result.phone || phoneDigits
          };

          // Populate inline rewards UI
          const nameEl = document.getElementById('checkoutMemberName');
          const balEl = document.getElementById('checkoutRewardsBalance');
          const inputEl = document.getElementById('checkoutRewardsInput');
          const applyBtn = document.getElementById('checkoutApplyRewardsBtn');

          if (nameEl) nameEl.textContent = window.rewardsMember.name;
          if (balEl) balEl.textContent = `$${balance}`; // or  balance.toString() if you want string
          if (inputEl) {
              inputEl.value = rawRewards;   // input holds points
              inputEl.max = rawRewards;     // cap at balance in points
              inputEl.disabled = false;
              inputEl.readOnly = false;

                   // ðŸ”’ Clamp free typing to cart total (points) and rewards balance (points)
              inputEl.addEventListener('input', () => {
                    const cartTotal = typeof window.cartTotal === 'number' ? window.cartTotal : Infinity;
                    const cartPoints = Math.floor(cartTotal * 1000);
                    const rewardsPoints = window.rewardsMember?.points || 0;

                    let val = parseInt(inputEl.value || '0', 10);

                    if (isNaN(val)) return; // let browser handle empty state

                    if (val < 0) val = 0;
                    if (val > cartPoints) val = cartPoints;
                    if (val > rewardsPoints) val = rewardsPoints;

                      // Only update if clamped
                    if (inputEl.value != val.toString()) {
                        inputEl.value = val;
                    }
                });

                  // On focus, just leave the field editable in points
              inputEl.addEventListener('focus', () => {
                inputEl.readOnly = false;
                inputEl.disabled = false;
              });
            }

          // â€¦ inside try { â€¦ after wiring inputEl â€¦
if (applyBtn) {
  applyBtn.disabled = false;
  applyBtn.onclick = () => {
    const openBtn = document.getElementById('openRewardsModal');
    const cartTotal = typeof window.cartTotal === 'number' ? window.cartTotal : 0;
    const rewardsPoints = window.rewardsMember?.points || 0;

          // Always parse directly from the input field
  let valPoints = parseInt((document.getElementById('checkoutRewardsInput')?.value || '0'), 10);
  if (isNaN(valPoints)) valPoints = 0;

    const cartPoints = Math.floor(cartTotal * 1000);
    if (valPoints <= 0) { alert('Enter a valid amount to redeem.'); return; }
    if (valPoints > cartPoints) { alert('You cannot redeem more than the cart total.'); return; }
    if (valPoints > rewardsPoints) { alert('You cannot redeem more than your rewards balance.'); return; }

    const valDollars = (valPoints / 1000).toFixed(2);

    if (openBtn) {
      openBtn.disabled = true;
      openBtn.classList.add('disabled');
      openBtn.setAttribute('aria-disabled', 'true');
    }

    if (inputEl) {
      inputEl.value = valDollars;
      inputEl.readOnly = true;
      inputEl.disabled = true;
      inputEl.classList.add('locked');
    }

    if (Array.isArray(window.posCart)) {
      const existingIdx = window.posCart.findIndex(x => x.id === 'rewards-credit');
      if (existingIdx > -1) window.posCart.splice(existingIdx, 1);
    }

    if (typeof window.addToCart === 'function') {
      window.addToCart({
        id: 'rewards-credit',
        name: 'Rewards Applied',
        price: -parseFloat(valDollars),
        qty: 1
      });
    }

    window.rewardsConsumedPoints = valPoints;
        // Disable Apply button once rewards are applied
  applyBtn.disabled = true;
  applyBtn.classList.add('disabled');
  }; // <-- CLOSE the onclick function here
}
          // Show toast notification
          const toast = document.getElementById('rewardsToast');
          if (toast) { 
            toast.textContent = `Member: ${window.rewardsMember.name}, Balance: ${balance}`; 
            toast.classList.add('show'); 
            setTimeout(()=>toast.classList.remove('show'),4000); 
          }

          closeRewardsModal();
        } catch (err) {
          console.error('[dbg] onSubmit error', err);
          alert('âŒ Rewards lookup failed. See console for details.');
        } finally {
          lookupBtn.disabled = false;
          lookupBtn.classList.remove('loading');
          lookupBtn.textContent = origText;
        }

      }

      form.removeEventListener('submit', form._rewardsHandler || onSubmit);
      form.addEventListener('submit', onSubmit);
      form._rewardsHandler = onSubmit;
    }

/* -------------------------
   Checkout modal flow
   ------------------------- */
const TAX_RATE = 0.0825;
const POLL_INTERVAL_MS = 8000;      // for PENDING loop
const PAYMENT_TIMEOUT_MS = 180000;  // 3 minutes safety cap

function money(v) {
  const n = Number(v);
  if (!Number.isFinite(n)) return 0;
  return Math.round(n * 100) / 100;
}
function fmt(v) { return `$${money(v).toFixed(2)}`; }

/* ============================================================
   Checkout Modal â€” Phase 1/2
   ============================================================ */

function openCheckoutModalWithCart(cart) {
  /* ============================================================
     MODULE 1 â€” Build Cart Snapshot
     ============================================================ */
  function buildCartSnapshot(cart) {
    const items = cart.map(i => ({
      sku: i.id,
      name: i.name,
      qty: i.qty,
      unitPrice: money(i.price),
      lineTotal: money(i.price * i.qty)
    }));

    const subtotal = money(items.reduce((s, i) => s + i.lineTotal, 0));
    const taxAmount = money(subtotal * TAX_RATE);
    const total = money(subtotal + taxAmount);

    return { items, subtotal, taxAmount, total };
  }

  const snapshot = buildCartSnapshot(cart);

  /* ============================================================
     MODULE 2 â€” Grab Modal Elements
     ============================================================ */
  const modal = document.getElementById('checkoutModal');
  const replica = document.getElementById('cartReplica');
  const cashControls = document.getElementById('cashControls');
  const cashReceivedEl = document.getElementById('cashReceived');
  const changeDueEl = document.getElementById('changeDue');
  const statusRow = document.getElementById('statusRow');
  const submitBtn = document.getElementById('submitOrderBtn');
  const closeBtn = document.getElementById('closeCheckoutModal');

  const cashOption = document.getElementById("tenderCash");
  const cashLabel = document.getElementById("tenderCashLabel");
  const cardOption = document.getElementById("tenderCard");

  /* ============================================================
     MODULE 3 â€” Reset Modal State
     ============================================================ */
  function resetModalState() {
    replica.innerHTML = '';
    statusRow.textContent = '';
    cashReceivedEl.value = '';
    changeDueEl.textContent = fmt(0);
  }

  resetModalState();

  /* ============================================================
     MODULE 4 â€” Render Cart Replica
     ============================================================ */
  function renderCartReplica({ items, subtotal, taxAmount, total }) {
    const list = document.createElement('div');

    items.forEach(i => {
      const row = document.createElement('div');
      row.className = 'line';

      const name = document.createElement('span');
      name.textContent = `${i.name} x${i.qty}`;

      const price = document.createElement('span');
      price.textContent = fmt(i.lineTotal);

      row.append(name, price);
      list.appendChild(row);
    });

    const subRow = document.createElement('div');
    subRow.className = 'line';
    subRow.append(
      Object.assign(document.createElement('span'), { textContent: 'Subtotal' }),
      Object.assign(document.createElement('span'), { textContent: fmt(subtotal) })
    );

    const taxRow = document.createElement('div');
    taxRow.className = 'line';
    taxRow.append(
      Object.assign(document.createElement('span'), { textContent: `Sales Tax (${(TAX_RATE * 100).toFixed(2)}%)` }),
      Object.assign(document.createElement('span'), { textContent: fmt(taxAmount) })
    );

    const totalRow = document.createElement('div');
    totalRow.className = 'line total';
    totalRow.append(
      Object.assign(document.createElement('span'), { textContent: 'Total' }),
      Object.assign(document.createElement('span'), { textContent: fmt(total) })
    );

    replica.append(list, subRow, taxRow, totalRow);
  }

  renderCartReplica(snapshot);

  /* ============================================================
     MODULE 5 â€” Determine Checkout Mode
     ============================================================ */
  const checkoutMode = sessionStorage.getItem("currentView"); // 'pos' or 'self'

  /* ============================================================
     MODULE 6 â€” Configure Tender Options
     ============================================================ */
  function configureTenderOptions(mode) {
    const isZeroTotal = snapshot.total === 0;

    // Self checkout â†’ card only
    if (mode === "self") {
      if (cashOption) {
        cashOption.checked = false;
        cashOption.disabled = true;
      }
      if (cashLabel) cashLabel.classList.add("hidden");
      if (cardOption) cardOption.checked = true;
      return;
    }

    // POS + zero-total â†’ force card only
    if (mode === "pos" && isZeroTotal) {
      if (cashOption) {
        cashOption.checked = false;
        cashOption.disabled = true;
      }
      if (cashLabel) cashLabel.classList.add("hidden");
      if (cardOption) cardOption.checked = true;
      return;
    }

    // POS + non-zero â†’ allow cash
    if (cashOption) {
      cashOption.disabled = false;
      cashLabel.classList.remove("hidden");
    }
  }

  configureTenderOptions(checkoutMode);

  /* ============================================================
     MODULE 7 â€” Tender Toggle UI
     ============================================================ */
  function wireTenderUI() {
    const radios = document.querySelectorAll('input[name="tender"]');

    function currentTender() {
      const r = document.querySelector('input[name="tender"]:checked');
      return r ? r.value : 'CASH';
    }

    function updateTenderUI() {
      const tender = currentTender();
      cashControls.style.display = tender === 'CASH' ? 'block' : 'none';
      submitBtn.textContent = tender === 'CASH'
        ? 'Submit cash order'
        : 'Submit card order';
    }

    radios.forEach(r => r.addEventListener('change', updateTenderUI));
    updateTenderUI();
  }

  wireTenderUI();

  /* ============================================================
     MODULE 8 â€” Change Due Live Update
     ============================================================ */
  function wireCashChangeUI() {
    cashReceivedEl.addEventListener('input', () => {
      const received = money(parseFloat(cashReceivedEl.value || '0'));
      const change = money(received - snapshot.total);
      changeDueEl.textContent = fmt(Math.max(change, 0));
    });
  }

  wireCashChangeUI();

  /* ============================================================
     MODULE 9 â€” Populate Checkout Rewards UI (Guest Default)
     ============================================================ */
  function syncCheckoutRewardsUI() {
    const m = window.rewardsMember;

    const memberEl = document.getElementById("checkoutMemberName");
    const balanceEl = document.getElementById("checkoutRewardsBalance");
    const inputEl = document.getElementById("checkoutRewardsInput");
    const applyBtn = document.getElementById("checkoutApplyRewardsBtn");

    if (memberEl) memberEl.textContent = m.name;
    if (balanceEl) balanceEl.textContent = `$${m.balance}`;

    if (m.isGuest) {
      if (inputEl) {
        inputEl.value = "0";
        inputEl.disabled = true;
      }
      if (applyBtn) applyBtn.disabled = true;
    } else {
      if (inputEl) {
        inputEl.disabled = false;
        inputEl.value = m.points;
        inputEl.max = m.points;
      }
      if (applyBtn) applyBtn.disabled = false;
    }
  }

  syncCheckoutRewardsUI();

  /* ============================================================
     MODULE 10 â€” Show Modal
     ============================================================ */
  function showModal() {
    document.body.classList.add('body-lock');
    modal.classList.remove('contact-hidden');
  }

  /* ============================================================
     MODULE 11 â€” Checkout API wiring (Phase 2)
     ============================================================ */

  // Local state for retry / diagnostics (kept, in case you expand later)
  let lastPayload = null;
  let lastEndpoints = null;

  function getCurrentTender() {
    const r = document.querySelector('input[name="tender"]:checked');
    return r ? r.value : 'CASH';
  }

  async function createOrderWithOmniTok(tenderType, payloadMeta = {}) {
    const omni = await getOmniTok('pos_checkout', payloadMeta);
    if (!omni || !omni.endpoint) {
      throw new Error('OmniTok preflight returned no endpoint');
    }

    const username = sessionStorage.getItem('username') || 'unknown';

    const m = window.rewardsMember || {
      name: 'Guest',
      email: null,
      phone: null,
      points: 0,
      balance: '0.00',
      isGuest: true
    };

    const rewardsPointsConsumed = window.rewardsConsumedPoints || 0;

    const payload = {
      tenderType,
      cartItems: snapshot.items,
      subtotal: snapshot.subtotal,
      taxRate: TAX_RATE,
      taxAmount: snapshot.taxAmount,
      total: snapshot.total,

      sid: omni.sid,
      authTok: omni.authToken,
      clientTime: new Date().toISOString(),
      username,

      checkoutMode: checkoutMode,
      rewards: {
        memberName: m.name,
        memberEmail: m.email,
        memberPhone: m.phone,
        pointsAvailable: m.points,
        balanceDollars: m.balance,
        pointsConsumed: rewardsPointsConsumed
      },

      meta: payloadMeta || {}
    };

    lastPayload = payload;
    lastEndpoints = {
      createOrder: omni.endpoint
    };

    const res = await fetch(omni.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'username': sessionStorage.getItem('username'),
        'x-omnitok': omni.OmniTok,
        'x-sid': omni.sid,
        'x-act': omni.act,
        'x-auth-token': omni.authToken
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const detail = await res.text().catch(() => '');
      throw new Error(detail || 'Order creation failed');
    }

    const json = await res.json().catch(() => ({}));

    // json is your backend response: { status, orderId, checkoutMode, memberName, isGuest, rewards {...} }
    return {
      omni,
      response: json
    };
  }

  // Sleep helper for PENDING polling loop
  function sleep(ms) {
    return new Promise(res => setTimeout(res, ms));
  }
   //Start PHASE 3
  async function handlePaid(resp) {
       showToast(`Order ${resp.orderId} completed (${resp.status}).`);
    modal.classList.add('contact-hidden');
    document.body.classList.remove('body-lock');
    // stash resp for Phase 3:
    openOrderSuccessModal(resp);
  }

  async function handleRetry(resp) {
    statusRow.textContent = "Card reader error. Please try again.";
    submitBtn.disabled = false;
  }

  async function handleFailed(resp) {
    statusRow.textContent = "Payment failed. Please try again.";
    submitBtn.disabled = false;
  }

  async function handlePending(resp) {
    const start = Date.now();
    statusRow.textContent = "Waiting for card payment...";

    while (Date.now() - start < PAYMENT_TIMEOUT_MS) {
      const omni = await getOmniTok("pos_orderStatus", {
        orderId: resp.orderId,
        checkoutMode: resp.checkoutMode
      });

      const res = await fetch(omni.endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "username": sessionStorage.getItem("username"),
          "x-omnitok": omni.OmniTok,
          "x-sid": omni.sid,
          "x-act": omni.act,
          "x-auth-token": omni.authToken
        },
        body: JSON.stringify({
          orderId: resp.orderId,
          checkoutMode: resp.checkoutMode
        })
      });

      if (!res.ok) {
        statusRow.textContent = "Error checking payment status. Retryingâ€¦";
        await sleep(POLL_INTERVAL_MS);
        continue;
      }

      const json = await res.json().catch(() => ({}));

      switch (json.status) {
        case "PAID":
          return handlePaid(json);

        case "PENDING":
          statusRow.textContent = "Still waiting for card paymentâ€¦";
          await sleep(POLL_INTERVAL_MS);
          continue;

        case "FAILED":
          return handleFailed(json);

        case "RETRY":
          return handleRetry(json);

        default:
          statusRow.textContent = "Unexpected status from payment. You can retry.";
          submitBtn.disabled = false;
          return;
      }
    }

    statusRow.textContent = "Payment timeout. Please try again.";
    submitBtn.disabled = false;
  }

  async function handleSubmit() {
    const tenderType = getCurrentTender();  // 'CASH' or 'CARD'
    submitBtn.disabled = true;
    statusRow.textContent = '';

    try {
      const meta = {
        rewardsPointsConsumed: window.rewardsConsumedPoints || 0,
        checkoutMode
      };

      const { response: checkoutResponse } =
        await createOrderWithOmniTok(tenderType, meta);

        // CASH FLOW â€” treat exactly like PAID card
        if (tenderType === 'CASH') {
        return handlePaid(checkoutResponse);
        }

      // CARD FLOW â€” backend returns PAID/PENDING/FAILED/RETRY
      switch (checkoutResponse.status) {
        case "PAID":
          return handlePaid(checkoutResponse);

        case "PENDING":
          return handlePending(checkoutResponse);

        case "RETRY":
          return handleRetry(checkoutResponse);

        case "FAILED":
          return handleFailed(checkoutResponse);

        default:
          throw new Error("Unknown checkout status");
      }
    } catch (err) {
      console.error('Checkout error:', err);
      statusRow.textContent = 'Checkout failed. You can retry.';
    } finally {
      // For PENDING, handlePending re-enables submit when done; this just
      // ensures we don't get stuck disabled on immediate failures.
      if (statusRow.textContent !== "Waiting for card payment...") {
        submitBtn.disabled = false;
      }
    }
  }

  // Wire buttons
  submitBtn.onclick = handleSubmit;
  closeBtn.onclick = () => {
    modal.classList.add('contact-hidden');
    document.body.classList.remove('body-lock');
  };

  // Show the modal
  showModal();
}

/* -------------------------
   POS checkout button wiring
   ------------------------- */
function wirePOSCheckoutModal() {
  const btn = document.getElementById('posCheckoutBtn');
  if (!btn) return;

  // Remove any existing listener
  btn.replaceWith(btn.cloneNode(true));
  const newBtn = document.getElementById('posCheckoutBtn');

  newBtn.addEventListener('click', () => {
    console.log('posCart at checkout:', window.posCart);
    if (!Array.isArray(window.posCart) || !window.posCart.length) {
      alert('Cart is empty.');
      return;
    }
    openCheckoutModalWithCart(window.posCart);
  });
}
wirePOSCheckoutModal(); // run at startup

function openOrderSuccessModal(resp) {
  const modal = document.getElementById("orderSuccessModal");
  if (!modal) return;

  const line1 = document.getElementById("orderSuccessLine1");
  const line2 = document.getElementById("orderSuccessLine2");
  const guestActions = document.getElementById("orderSuccessGuestActions");

  const isGuest = String(resp.isGuest).toLowerCase() === "true";
  const earned = resp.rewards?.earned ?? "0";
  const total = resp.rewards?.total ?? "0";
  const orderId = resp.orderId ?? "";

  const badge = document.getElementById("orderSuccessPointsBadge");
  const badgeValue = document.getElementById("orderSuccessPointsValue");

if (badge && badgeValue) {
  const earned = resp.rewards?.earned ?? "0";
  badgeValue.textContent = earned;

  // Show badge only if earned > 0
  if (parseInt(earned) > 0) {
    badge.classList.remove("hidden");
  } else {
    badge.classList.add("hidden");
  }
}
  // Line 1: generic thank you
  if (line1) {
    line1.textContent = `Order ${orderId} is complete.`;
  }

  // Line 2: points text varies by guest/member
  if (line2) {
    if (isGuest) {
      line2.textContent = `You just earned ${earned} rewards points. You can keep them by joining our rewards trading post.`;
    } else {
      line2.textContent = `You earned ${earned} rewards points. Your new total balance is ${total}.`;
    }
  }

  // Guest CTA
  if (guestActions) {
    guestActions.style.display = isGuest ? "flex" : "none";
  }

  document.body.classList.add("body-lock");
  modal.classList.remove("contact-hidden");

  // Stash for later use (contact form handoff)
  window.lastOrder = resp;
}

function closeOrderSuccessModal() {
  const modal = document.getElementById("orderSuccessModal");
  if (!modal) return;
  modal.classList.add("contact-hidden");
  document.body.classList.remove("body-lock");
}


    /* -------------------------
       Signup wiring
       ------------------------- */
    function wireSignup() {
      setupFieldValidation('custFirstname', validators.notEmpty, 'Please enter your first name');
      setupFieldValidation('custLastname', validators.notEmpty, 'Please enter your last name');
      setupFieldValidation('custAddress', validators.street, 'Please enter your street address');
      setupFieldValidation('custCity', validators.notEmpty, 'Please enter your city');
      setupFieldValidation('custState', v => safe(v) !== '', 'Please select your state');
      setupFieldValidation('custZip', validators.zip5, 'Enter a 5-digit ZIP code');
      setupFieldValidation('custEmail', validators.email, 'Enter a valid email like name@example.com');
      setupFieldValidation('custPhone', () => validators.phoneFormatted($id('custPhone')?.value || ''), 'Enter a valid 10-digit phone number');
      setupFieldValidation('loginUsername', validators.email, 'Enter a valid email like name@example.com');
      setupFieldValidation('loginPassword', v => safe(v).length >= 8, 'Password must be at least 8 characters');

      const submit = $id('submitBtn');
      const required = ['custFirstname','custLastname','custAddress','custCity','custState','custZip','custEmail','custPhone','custPassword','custConfirmpassword'];
      required.forEach(id => { const el = $id(id); if (el) el.addEventListener('input', validateContactForm); });

      window.handleFormSubmit = async function handleFormSubmit(e) {
        if (e && e.preventDefault) e.preventDefault();
        if (!submit || submit.disabled) return;

        const isAuth = sessionStorage.getItem(`pps_loggedIn@${location.origin}`) === 'true';
        if (!isAuth) { alert('Please log in before signing up.'); return; }

        const phoneEl = $id('custPhone'), smsEl = $id('smsConsent');
        
        const meta = window.pendingSignupMetadata || {};

        const payload = {
          firstName: safe($id('custFirstname')?.value),
          lastName: safe($id('custLastname')?.value),
          address: safe($id('custAddress')?.value),
          city: safe($id('custCity')?.value),
          state: safe($id('custState')?.value),
          zip: safe($id('custZip')?.value),
          email: safe($id('custEmail')?.value),
          password: safe($id('custPassword')?.value),
          phone: (phoneEl?.dataset?.raw || (phoneEl?.value || '').replace(/\D/g,'')),
          smsConsent: Boolean(smsEl?.checked),
            // Phase 3 extras
          orderId: meta.orderId || null,
          pointsEarned: meta.pointsEarned || null,
          checkoutMode: meta.checkoutMode || null,

          verificationCode: undefined
        };
        const confirm = safe($id('custConfirmpassword')?.value);
        if (payload.password !== confirm) { alert('Passwords do not match.'); return; }

        const original = submit.textContent;
        submit.disabled = true; submit.classList.add('btn-loading'); submit.textContent = 'Submittingâ€¦'; startLoading();

        try {
          const omni = await getOmniTok(submit.dataset.act || 'ppsc_signup');
          if (!omni?.endpoint) throw new Error('Omnitok preflight did not return an endpoint');
          payload.verificationCode = omni.verificationCode;
          const res = await fetch(omni.endpoint, { method: 'POST', headers: { 'Content-Type':'application/json', 'username': sessionStorage.getItem('username'), 'x-auth-token': omni.authToken,'x-omnitok': omni.OmniTok,'x-sid': omni.sid,'x-act': omni.act }, body: JSON.stringify(payload) });
          if (!res.ok) {
            let detail = '';
            try { const j = await res.json(); detail = j?.error?.message || ''; } catch(_) {}
            throw new Error(detail || `Signup failed (${res.status})`);
          }
          await res.json().catch(()=>{});
          alert(`âœ… Welcome to the Trading Post, ${payload.firstName || payload.email}!`);
          submit.textContent = 'âœ“ Account Created'; submit.classList.add('is-success');
          resetContactForm();
          window.pendingSignupMetadata = null;
          setTimeout(()=>{ submit.disabled=false; submit.textContent = original; submit.classList.remove('is-success','btn-loading','enabled'); }, 800);
        } catch (err) {
          console.error('Signup error:', err);
          alert(`âŒ Signup failed. ${err?.message || 'Please try again.'}`);
          submit.textContent = 'Retry Signup'; submit.classList.remove('is-success'); submit.classList.add('is-error'); submit.disabled=false;
        } finally {
          submit.classList.remove('btn-loading'); stopLoading();
        }
      };
    }

    /* -------------------------
       Initial DOM wiring
       ------------------------- */
document.addEventListener('DOMContentLoaded', once(() => {
  const y = $id('y'); if (y) y.textContent = new Date().getFullYear();

  $id('choosePOSBtn')?.addEventListener('click', showPOSContainer);
  $id('chooseSelfBtn')?.addEventListener('click', showSelfCheckout);
  $id('chooseJoinBtn')?.addEventListener('click', showJoinRewards);
  $id('chooseLogOutBtn')?.addEventListener('click', forceLogout);
  $id('openRewardsModal')?.addEventListener('click', openRewardsModal);
  $id('closeRewardsModal')?.addEventListener('click', closeRewardsModal);

  wireLogin();
  wireRewards();
  wireSignup();

  wirePhone($id('custPhone'));
  wirePhone($id('rewardsPhone'));

  setupFieldValidation('rewardsEmail', v => true, 'Enter email or phone (optional)');
  setupFieldValidation('rewardsPhone', v => true, 'Enter email or phone (optional)');

  // Default view driven by gate; check for existing session first
  const authKey = `pps_loggedIn@${location.origin}`;
  const sid = sessionStorage.getItem('sid');

  if (sessionStorage.getItem(authKey) && sid) {
    console.info('Startup: session found, applying gate');
    if (typeof window._ppsApplyAuthGate === 'function') {
      try { window._ppsApplyAuthGate(); }
      catch (e) { console.warn('ppsApplyAuthGate threw', e); doManualReveal(); }
    } else {
      doManualReveal();
    }
    // âœ… Restart Horus if not already running
    if (typeof startHorus === 'function') startHorus();

    //  Restore saved UI state here
    const savedView = sessionStorage.getItem('currentView');
    const savedCaller = sessionStorage.getItem('joinCaller');
    if (savedView) {
      switch (savedView) {
        case 'pos': showPOSContainer(); break;
        case 'self': showSelfCheckout(); break;
        case 'contact': showJoinRewards(); break;
          if (savedCaller) { window.joinCaller = savedCaller; }
          showJoinRewards();
          break;
        case 'mode': showModeSelector(); break;
        default: showLogin(); break;
      }
    }

    // Force-lift any paint block once weâ€™ve restored a view
document.documentElement.classList.remove('pps-auth-pending');

  } else {
    console.info('Startup: no session, showing login');
    $id('loginContainer')?.classList.remove('hidden');
    $id('authOverlay')?.classList.remove('hidden');
    resetRewardsToGuest();
  }

  if (typeof validateContactForm === 'function') validateContactForm();
}));


  const dismissSuccessBtn = $id('dismissOrderSuccessBtn');
  const keepPointsBtn = $id('keepPointsBtn');

  if (dismissSuccessBtn) {
    dismissSuccessBtn.addEventListener('click', () => {
      // Close Phase 3
      closeOrderSuccessModal();

      // Reset POS / Self checkout state
      try {
        clearPOSCartOnly?.();   // clear cart only, your helper
        resetRewardsToGuest?.();
        // return to appropriate view based on checkoutMode if needed:
        const last = window.lastOrder;
        const mode = last?.checkoutMode || sessionStorage.getItem('currentView');
        if (mode === 'pos') {
          showPOSContainer?.();
        } else if (mode === 'self') {
          showSelfCheckout?.();
        } else {
          showModeSelector?.();
        }
      } catch (e) {
        console.warn('Order dismiss reset failed', e);
      }
    });
  }

  if (keepPointsBtn) {
    keepPointsBtn.addEventListener('click', () => {
      const last = window.lastOrder;
      if (!last) {
        alert('Order context missing. Please try again.');
        return;
      }

      // Close success modal
      closeOrderSuccessModal();

      // Stash metadata for signup flow
      window.pendingSignupMetadata = {
        orderId: last.orderId,
        pointsEarned: last.rewards?.earned ?? "0",
        checkoutMode: last.checkoutMode || sessionStorage.getItem('currentView')
      };

      // Navigate to contact form (Join Rewards)
      showJoinRewards?.();
    });
  }


    /* -------------------------
       Public helpers
       ------------------------- */
    window.showPOSContainer = showPOSContainer;
    window.showSelfCheckout = showSelfCheckout;
    window.openRewardsModal = openRewardsModal;
    window.closeRewardsModal = closeRewardsModal;
    window.wirePhone = wirePhone;
  
  })();
  </script>
</body>
</html>
